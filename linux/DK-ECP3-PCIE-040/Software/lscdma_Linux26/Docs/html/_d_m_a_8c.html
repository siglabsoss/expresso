<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Lattice PCIeDMA Device Driver : DMA.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>DMA.c File Reference</h1><code>#include "<a class="el" href="lscdma_8h-source.html">lscdma.h</a>"</code><br>

<p>
<a href="_d_m_a_8c-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_d_m_a_8c.html#a0">StartDmaWrite</a> (<a class="el" href="struct_p_c_i_e___board.html">pcie_board_t</a> *pBrd, <a class="el" href="struct_d_m_a_channel__t.html">DMAChannel_t</a> *pChan)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_d_m_a_8c.html#a1">StartDmaRead</a> (<a class="el" href="struct_p_c_i_e___board.html">pcie_board_t</a> *pBrd, <a class="el" href="struct_d_m_a_channel__t.html">DMAChannel_t</a> *pChan)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_d_m_a_8c.html#a2">initDMAChan</a> (<a class="el" href="struct_p_c_i_e___board.html">pcie_board_t</a> *pBrd, <a class="el" href="struct_d_m_a_channel__t.html">DMAChannel_t</a> *pChan, unsigned long userAddr, size_t len, int direction)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_d_m_a_8c.html#a3">releaseDMAChan</a> (<a class="el" href="struct_p_c_i_e___board.html">pcie_board_t</a> *pBrd, <a class="el" href="struct_d_m_a_channel__t.html">DMAChannel_t</a> *pChan)</td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>

<p>
Definition in file <a class="el" href="_d_m_a_8c-source.html">DMA.c</a>.<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="DMA.c::initDMAChan"></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int initDMAChan           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="struct_p_c_i_e___board.html">pcie_board_t</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pBrd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="struct_d_m_a_channel__t.html">DMAChannel_t</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pChan</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>unsigned long&nbsp;</td>
          <td class="mdname" nowrap> <em>userAddr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>size_t&nbsp;</td>
          <td class="mdname" nowrap> <em>len</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>direction</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Initialize the data elements that control the SGDMA operation.<p>
use info from User's vritual buffer - length,<p>
this assumes that the transfer can be done with one mapping. It does not try to handle splitting the entire xfer among multiple allocations of SG lists and maps.<p>
Code takes advantage of the fact that the biggest move is 1MB and that can fit within the 256 BD's. If you need to move more than 1 MB (i.e. need more than 256 BD's) then this code needs to be changed to handle it.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>pChan</em>&nbsp;</td><td>specific DMA channel of a board/device that is being setup for the transfer, read or write channel.  direction specifies reading or writing, use PCI_DMA_TODEVICE or PCI_DMA_FRPOMDEVICE </td></tr>
  </table>
</dl>

<p>
Definition at line <a class="el" href="_d_m_a_8c-source.html#l00114">114</a> of file <a class="el" href="_d_m_a_8c-source.html">DMA.c</a>.
<p>
References <a class="el" href="lscdma_8h-source.html#l00141">DMAChannel_t::bufBaseVirtualAddr</a>, <a class="el" href="lscdma_8h-source.html#l00134">DMAChannel_t::cancelDMA</a>, <a class="el" href="lscdma_8h-source.html#l00155">DMAChannel_t::direction</a>, <a class="el" href="lscdma_8h-source.html#l00167">SGDMAOperations_t::DmaOk</a>, <a class="el" href="lscdma_8h-source.html#l00133">DMAChannel_t::doneDMA</a>, <a class="el" href="lscdma_8h-source.html#l00137">DMAChannel_t::elapsedTime</a>, <a class="el" href="lscdma_8h-source.html#l00254">PCIE_Board::IRQ</a>, <a class="el" href="lscdma_8h-source.html#l00143">DMAChannel_t::isDmaAddr64</a>, <a class="el" href="lscdma_8h-source.html#l00152">DMAChannel_t::numPages</a>, <a class="el" href="lscdma_8h-source.html#l00151">DMAChannel_t::pageList</a>, <a class="el" href="lscdma_8h.html#a23">pcie_board_t</a>, <a class="el" href="lscdma_8h-source.html#l00272">PCIE_Board::pPciDev</a>, <a class="el" href="lscdma_8h-source.html#l00278">PCIE_Board::SGDMA</a>, <a class="el" href="lscdma_8h-source.html#l00154">DMAChannel_t::sgLen</a>, <a class="el" href="lscdma_8h-source.html#l00153">DMAChannel_t::sgList</a>, <a class="el" href="lscdma_8h-source.html#l00140">DMAChannel_t::thisXferSize</a>, <a class="el" href="lscdma_8h-source.html#l00138">DMAChannel_t::totalXferSize</a>, and <a class="el" href="lscdma_8h-source.html#l00139">DMAChannel_t::xferedSoFar</a>.
<p>
Referenced by <a class="el" href="_main_8c-source.html#l01211">lscdma_read()</a>, and <a class="el" href="_main_8c-source.html#l01305">lscdma_write()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="DMA.c::releaseDMAChan"></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int releaseDMAChan           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="struct_p_c_i_e___board.html">pcie_board_t</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pBrd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="struct_d_m_a_channel__t.html">DMAChannel_t</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pChan</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Release the data elements used in the SGDMA operation.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>pBrd</em>&nbsp;</td><td>pointer to the specific device </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pChan</em>&nbsp;</td><td>specific DMA channel of a board/device that is being setup for the transfer, read or write channel. </td></tr>
  </table>
</dl>

<p>
Definition at line <a class="el" href="_d_m_a_8c-source.html#l00338">338</a> of file <a class="el" href="_d_m_a_8c-source.html">DMA.c</a>.
<p>
References <a class="el" href="lscdma_8h-source.html#l00141">DMAChannel_t::bufBaseVirtualAddr</a>, <a class="el" href="lscdma_8h-source.html#l00155">DMAChannel_t::direction</a>, <a class="el" href="lscdma_8h-source.html#l00152">DMAChannel_t::numPages</a>, <a class="el" href="lscdma_8h-source.html#l00151">DMAChannel_t::pageList</a>, <a class="el" href="lscdma_8h.html#a23">pcie_board_t</a>, <a class="el" href="lscdma_8h-source.html#l00272">PCIE_Board::pPciDev</a>, <a class="el" href="lscdma_8h-source.html#l00154">DMAChannel_t::sgLen</a>, and <a class="el" href="lscdma_8h-source.html#l00153">DMAChannel_t::sgList</a>.
<p>
Referenced by <a class="el" href="_main_8c-source.html#l01211">lscdma_read()</a>, and <a class="el" href="_main_8c-source.html#l01305">lscdma_write()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="DMA.c::StartDmaRead"></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void StartDmaRead           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="struct_p_c_i_e___board.html">pcie_board_t</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pBrd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="struct_d_m_a_channel__t.html">DMAChannel_t</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pChan</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Enable the read channel and start the DMA.<p>
NOTE: this function should be called after obtaining the hdwAccess spin_lock using spin_lock_irqsave() to ensure the ISR is not running and about to modify the interrupt controller or SGDMA registers.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>pBrd</em>&nbsp;</td><td>specific hardware board to access and setup </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pChan</em>&nbsp;</td><td>DMA channel </td></tr>
  </table>
</dl>

<p>
Definition at line <a class="el" href="_d_m_a_8c-source.html#l00065">65</a> of file <a class="el" href="_d_m_a_8c-source.html">DMA.c</a>.
<p>
References <a class="el" href="lscdma_8h.html#a23">pcie_board_t</a>, <a class="el" href="lscdma_8h-source.html#l00170">SGDMAOperations_t::ReadBurstSize</a>, <a class="el" href="lscdma_8h-source.html#l00278">PCIE_Board::SGDMA</a>, <a class="el" href="_devices_8c-source.html#l00598">SGDMA_ConfigRead()</a>, <a class="el" href="_devices_8c-source.html#l00457">SGDMA_EnableChan()</a>, <a class="el" href="_devices_8c-source.html#l00683">SGDMA_StartReadChan()</a>, <a class="el" href="lscdma_8h-source.html#l00154">DMAChannel_t::sgLen</a>, <a class="el" href="lscdma_8h-source.html#l00153">DMAChannel_t::sgList</a>, and <a class="el" href="lscdma_8h-source.html#l00146">DMAChannel_t::startBD</a>.
<p>
Referenced by <a class="el" href="_main_8c-source.html#l01305">lscdma_write()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="DMA.c::StartDmaWrite"></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void StartDmaWrite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="struct_p_c_i_e___board.html">pcie_board_t</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pBrd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="struct_d_m_a_channel__t.html">DMAChannel_t</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pChan</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Enable the write channel and start the DMA.<p>
NOTE: this function should be called after obtaining the hdwAccess spin_lock using spin_lock_irqsave() to ensure the ISR is not running and about to modify the interrupt controller or SGDMA registers.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>pBrd</em>&nbsp;</td><td>specific hardware board to access and setup </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pChan</em>&nbsp;</td><td>DMA channel </td></tr>
  </table>
</dl>

<p>
Definition at line <a class="el" href="_d_m_a_8c-source.html#l00024">24</a> of file <a class="el" href="_d_m_a_8c-source.html">DMA.c</a>.
<p>
References <a class="el" href="lscdma_8h.html#a23">pcie_board_t</a>, <a class="el" href="lscdma_8h-source.html#l00278">PCIE_Board::SGDMA</a>, <a class="el" href="_devices_8c-source.html#l00524">SGDMA_ConfigWrite()</a>, <a class="el" href="_devices_8c-source.html#l00457">SGDMA_EnableChan()</a>, <a class="el" href="_devices_8c-source.html#l00663">SGDMA_StartWriteChan()</a>, <a class="el" href="lscdma_8h-source.html#l00154">DMAChannel_t::sgLen</a>, <a class="el" href="lscdma_8h-source.html#l00153">DMAChannel_t::sgList</a>, <a class="el" href="lscdma_8h-source.html#l00146">DMAChannel_t::startBD</a>, and <a class="el" href="lscdma_8h-source.html#l00169">SGDMAOperations_t::WriteBurstSize</a>.
<p>
Referenced by <a class="el" href="_main_8c-source.html#l01211">lscdma_read()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Wed Jul 16 12:05:24 2008 for Lattice PCIeDMA Device Driver  by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
