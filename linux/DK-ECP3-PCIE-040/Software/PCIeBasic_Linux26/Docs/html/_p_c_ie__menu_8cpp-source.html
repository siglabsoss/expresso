<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Lattice PCIe Basic Demo: PCIe_menu.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000002.html">BasicMenu</a></div>
<h1>PCIe_menu.cpp</h1><a href="_p_c_ie__menu_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> *  COPYRIGHT (c) 2008 by Lattice Semiconductor Corporation</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * All rights reserved. All use of this software and documentation is</span>
00005 <span class="comment"> * subject to the License Agreement located in the file LICENSE.</span>
00006 <span class="comment"> */</span>
00056 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
00057 <span class="preprocessor">#include &lt;iostream&gt;</span>
00058 <span class="preprocessor">#include &lt;string&gt;</span>
00059 
00060 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00061 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00062 <span class="preprocessor">#include &lt;string.h&gt;</span>
00063 
00064 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00065 
00066 <span class="preprocessor">#include "PCIeAPI.h"</span>         <span class="comment">// the APIs</span>
00067 <span class="preprocessor">#include "LSCPCIe2_IF.h"</span>     <span class="comment">// the driver interface</span>
00068 <span class="preprocessor">#include "GPIO.h"</span>            <span class="comment">// the GPIO IP module</span>
00069 <span class="preprocessor">#include "Mem.h"</span>            <span class="comment">// the General Memory IP module</span>
00070 <span class="preprocessor">#include "MiscUtils.h"</span>
00071 <span class="preprocessor">#include "MemFormat.h"</span>
00072 <span class="preprocessor">#include "../MemMap.h"</span>       <span class="comment">// IP module base addresses</span>
00073 
00074 
00075 
00077 <span class="comment">// Required to use Lattice PCIe methods</span>
00079 <span class="comment"></span><span class="keyword">using</span> <span class="keyword">namespace </span>LatticeSemi_PCIe;
00080 
00081 
00082 <span class="keyword">typedef</span> uint32_t Addr_t;
00083 <span class="keyword">typedef</span> uint8_t  Data_t;
00084 
00085 
00086 
00087 <span class="comment">/*==========================================================================*/</span>
00088 <span class="comment">/*==========================================================================*/</span>
00089 <span class="comment">/*==========================================================================*/</span>
00090 <span class="comment">/*               GLOBAL VARIABLES                                           */</span>
00091 <span class="comment">/*==========================================================================*/</span>
00092 <span class="comment">/*==========================================================================*/</span>
00093 <span class="comment">/*==========================================================================*/</span>
00094 
00095 LSCPCIe2_IF *pDrvr;
00096 Mem        *pEBR;
00097 Mem        *pBAR0;
00098 Mem        *pBAR1;
00099 GPIO        *pGPIO;
00100 
00101 
00102 <span class="comment">/* Function Prototypes */</span>
00103 <span class="keywordtype">void</span> <a class="code" href="_p_c_ie__menu_8cpp.html#a7">menu</a>(<span class="keywordtype">void</span>);
00104 <span class="keyword">static</span> <span class="keywordtype">char</span>* strip(<span class="keywordtype">char</span> *s);
00105 <span class="keyword">static</span> <span class="keywordtype">char</span> getCmd(<span class="keywordtype">char</span> *line);
00106 <span class="keywordtype">void</span>    <a class="code" href="_p_c_ie__menu_8cpp.html#a10">showHelp</a>(<span class="keywordtype">void</span>);
00107 
00108 
00109 
00110 
00111 
00113 <span class="comment">//             Main Entry</span>
00115 <span class="comment"></span>
<a name="l00124"></a><a class="code" href="_p_c_ie__menu_8cpp.html#a11">00124</a> <span class="keywordtype">int</span> <a class="code" href="_p_c_ie__menu_8cpp.html#a11">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
00125 {
00126     <span class="keywordtype">char</span> boardName[LSC_PCIE_BOARD_NAME_LEN + 1];
00127     <span class="keywordtype">char</span> demoName[LSC_PCIE_DEMO_NAME_LEN + 1];
00128     uint32_t boardNum;
00129     string infoStr;
00130     uint32_t ui;
00131 
00132 
00133 
00134     cout&lt;&lt;<span class="stringliteral">"\n\n========================================================\n"</span>;
00135     cout&lt;&lt;<span class="stringliteral">"           Lattice PCIe Basic Demo Menu\n"</span>;
00136     cout&lt;&lt;<span class="stringliteral">"                 ver2.0.1\n"</span>;
00137     cout&lt;&lt;<span class="stringliteral">"========================================================\n"</span>;
00138 
00139 
00140     cout&lt;&lt;<span class="stringliteral">"\n\n======================================\n"</span>;
00141     cout&lt;&lt;<span class="stringliteral">"    Instantiate the PCIeAPI DLL class\n"</span>;
00142     cout&lt;&lt;    <span class="stringliteral">"======================================\n"</span>;
00143     PCIeAPI theDLL;
00144     cout&lt;&lt;<span class="stringliteral">"Dll version info: "</span>&lt;&lt;theDLL.getVersionStr()&lt;&lt;endl;
00145 
00146     <span class="comment">// Setup so lots of diag output occurs from tests</span>
00147     theDLL.setRunTimeCtrl(PCIeAPI::VERBOSE);
00148 
00149     <span class="comment">// Get the environment variables needed to open the desired board</span>
00150     <span class="comment">// Pre-load with defaults of an ECP2M SolBrd and the basic demo IP bitstream</span>
00151     strcpy(boardName, <span class="stringliteral">"ven_1204&amp;dev_e250"</span>);
00152     strcpy(demoName, <span class="stringliteral">"subsys_30101204"</span>);
00153     <span class="keywordflow">if</span> (!GetPCIeEnvVars(boardName, demoName, boardNum))
00154         cout&lt;&lt;<span class="stringliteral">"\nEnvVars not found.  Using defaults.\n"</span>;
00155 
00156     cout&lt;&lt;<span class="stringliteral">"boardName = "</span>&lt;&lt;boardName&lt;&lt;endl;
00157     cout&lt;&lt;<span class="stringliteral">"boardNum = "</span>&lt;&lt;boardNum&lt;&lt;endl;
00158     cout&lt;&lt;<span class="stringliteral">"demoName = "</span>&lt;&lt;demoName&lt;&lt;endl;
00159 
00160 
00161     <span class="keywordflow">try</span>
00162     {
00163         cout&lt;&lt;<span class="stringliteral">"\n\n======================================\n"</span>;
00164         cout&lt;&lt;    <span class="stringliteral">"       Driver Interface Info\n"</span>;
00165         cout&lt;&lt;    <span class="stringliteral">"======================================\n"</span>;
00166         cout&lt;&lt;<span class="stringliteral">"Opening LSCPCIe2_IF...\n"</span>;
00167         pDrvr = <span class="keyword">new</span> LSCPCIe2_IF(boardName, 
00168                                 demoName, 
00169                                 boardNum);
00170 
00171         cout&lt;&lt;<span class="stringliteral">"OK.\n"</span>;
00172 
00173         pDrvr-&gt;getDriverVersionStr(infoStr);
00174         cout&lt;&lt;<span class="stringliteral">"Version: "</span>&lt;&lt;infoStr&lt;&lt;endl;
00175         pDrvr-&gt;getDriverResourcesStr(infoStr);
00176         cout&lt;&lt;<span class="stringliteral">"Resources: "</span>&lt;&lt;infoStr&lt;&lt;endl;
00177         pDrvr-&gt;getPCICapabiltiesStr(infoStr);
00178         cout&lt;&lt;<span class="stringliteral">"Link Info: "</span>&lt;&lt;infoStr&lt;&lt;endl;
00179 
00180         <span class="comment">//==================================================</span>
00181         <span class="comment">//  lscpcie2 Driver Info</span>
00182         <span class="comment">//==================================================</span>
00183         cout&lt;&lt;<span class="stringliteral">"\n\n"</span>;
00184         cout&lt;&lt;<span class="stringliteral">"==========================================\n"</span>;
00185         cout&lt;&lt;<span class="stringliteral">"  PCIe Driver &amp; Link Resources\n"</span>;
00186         cout&lt;&lt;<span class="stringliteral">"==========================================\n"</span>;
00187 
00188         <span class="keyword">const</span> PCIResourceInfo_t *pInfo;
00189         pDrvr-&gt;getPCIDriverInfo(&amp;pInfo);
00190         cout&lt;&lt;<span class="stringliteral">"lscpcie2 Driver Info:\n"</span>;
00191         cout&lt;&lt;<span class="stringliteral">"numBARs = "</span>&lt;&lt;pInfo-&gt;numBARs&lt;&lt;endl;
00192         <span class="keywordflow">for</span> (ui = 0; ui &lt; MAX_PCI_BARS; ui++)
00193         {
00194             <span class="keywordflow">if</span> (ui &gt;= pInfo-&gt;numBARs)
00195                 cout&lt;&lt;<span class="stringliteral">"***"</span>;  <span class="comment">// not initialized</span>
00196             cout&lt;&lt;<span class="stringliteral">"\tBAR"</span>&lt;&lt;ui&lt;&lt;<span class="stringliteral">":"</span>;
00197             cout&lt;&lt;<span class="stringliteral">"  nbar="</span>&lt;&lt;pInfo-&gt;BAR[ui].nBAR;
00198             cout&lt;&lt;<span class="stringliteral">"  type="</span>&lt;&lt;(int)pInfo-&gt;BAR[ui].type;
00199             cout&lt;&lt;<span class="stringliteral">"  size="</span>&lt;&lt;pInfo-&gt;BAR[ui].size;
00200             cout&lt;&lt;<span class="stringliteral">"  Addr="</span>&lt;&lt;hex&lt;&lt;pInfo-&gt;BAR[ui].physStartAddr&lt;&lt;dec;
00201             cout&lt;&lt;<span class="stringliteral">"  mapped="</span>&lt;&lt;pInfo-&gt;BAR[ui].memMapped;
00202             cout&lt;&lt;<span class="stringliteral">"  flags="</span>&lt;&lt;pInfo-&gt;BAR[ui].flags&lt;&lt;endl;
00203         }
00204         cout&lt;&lt;<span class="stringliteral">"hasInterrupt="</span>&lt;&lt;pInfo-&gt;hasInterrupt&lt;&lt;endl;
00205         cout&lt;&lt;<span class="stringliteral">"intrVector="</span>&lt;&lt;pInfo-&gt;intrVector&lt;&lt;endl;
00206 
00207 
00208         pDrvr-&gt;getPCIExtraInfoStr(infoStr);
00209         cout&lt;&lt;<span class="stringliteral">"\n\nDevice Driver Info:\n"</span>&lt;&lt;infoStr&lt;&lt;endl;
00210 
00211         <span class="comment">//==================================================</span>
00212         <span class="comment">// Access GPIO</span>
00213         <span class="comment">//==================================================</span>
00214         cout&lt;&lt;<span class="stringliteral">"\n\n"</span>;
00215         cout&lt;&lt;<span class="stringliteral">"=======================================================\n"</span>;
00216         cout&lt;&lt;<span class="stringliteral">"  Create access to GPIO IP module\n"</span>;
00217         cout&lt;&lt;<span class="stringliteral">"=======================================================\n"</span>;
00218 
00219 
00220         pGPIO = <span class="keyword">new</span> GPIO(<span class="stringliteral">"GPIO"</span>,         <span class="comment">// a unique name for the IP module instance</span>
00221                  GPIOreg(0),    <span class="comment">// its base address</span>
00222                  pDrvr);        <span class="comment">// driver interface to use for register access</span>
00223 
00224         cout&lt;&lt;<span class="stringliteral">"\n\n======================================\n"</span>;
00225         cout&lt;&lt;    <span class="stringliteral">"  Create access to the 16KB EBR\n"</span>;
00226         cout&lt;&lt;    <span class="stringliteral">"======================================\n"</span>;
00227 
00228         pEBR = <span class="keyword">new</span> Mem(<span class="stringliteral">"EBR16"</span>, EBR_SIZE, EBRreg(0), pDrvr); 
00229 
00230         <span class="comment">// This gives us access to all the memory locations within BAR0</span>
00231         <span class="comment">// Its for diagnostic purposes</span>
00232         pBAR0 = <span class="keyword">new</span> Mem(<span class="stringliteral">"BAR0"</span>, BAR0_SIZE, BAR0reg(0), pDrvr); 
00233 
00234         <span class="comment">// This gives us access to all the memory locations within BAR1</span>
00235         <span class="comment">// Its for diagnostic purposes</span>
00236         pBAR1 = <span class="keyword">new</span> Mem(<span class="stringliteral">"BAR1"</span>, BAR1_SIZE, BAR1reg(0), pDrvr); 
00237 
00238         <span class="comment">// Do the tests</span>
00239         <a class="code" href="_p_c_ie__menu_8cpp.html#a7">menu</a>();
00240 
00241     }
00242     <span class="keywordflow">catch</span> (std::exception &amp;e)
00243     {
00244         cout&lt;&lt;<span class="stringliteral">"RUNTIME ERROR!!! "</span>&lt;&lt;e.what()&lt;&lt;endl;
00245     }
00246 
00247     cout&lt;&lt;<span class="stringliteral">"Done."</span>&lt;&lt;endl;
00248 
00249     <span class="keyword">delete</span> pEBR;
00250     <span class="keyword">delete</span> pBAR0;
00251     <span class="keyword">delete</span> pBAR1;
00252     <span class="keyword">delete</span> pGPIO;
00253     <span class="keyword">delete</span> pDrvr;
00254     <span class="keywordflow">return</span>(0);
00255 }
00256 
00257 
00258 
00259 
00264 <span class="keyword">static</span> <span class="keywordtype">char</span>* strip(<span class="keywordtype">char</span> *s)
00265 {
00266     <span class="keywordflow">while</span> (((*s &lt;= 0x21) || ((unsigned char)*s &gt; 0x7f)) &amp;&amp; (*s != <span class="charliteral">'\0'</span>))
00267         ++s;
00268     <span class="keywordflow">return</span>(s);
00269 }
00270 
00271 
00275 <span class="keyword">static</span> <span class="keywordtype">char</span> getCmd(<span class="keywordtype">char</span> *line)
00276 {
00277     <span class="keywordtype">char</span> choice;
00278 
00279     cin.getline(line, 80);
00280     choice = *(strip(line));
00281     <span class="keywordflow">return</span>(choice);
00282 }
00283 
00284 
00285 
00286 
<a name="l00306"></a><a class="code" href="_p_c_ie__menu_8cpp.html#a7">00306</a> <span class="keywordtype">void</span> <a class="code" href="_p_c_ie__menu_8cpp.html#a7">menu</a>(<span class="keywordtype">void</span>)
00307 {
00308     <span class="keywordtype">int</span>     argCnt;
00309     <span class="keywordtype">bool</span>    done;
00310     <span class="keywordtype">char</span>    line[256];
00311     <span class="keywordtype">char</span>    lastCmd[256];
00312     uint8_t buf[256];
00313     uint8_t d;
00314     size_t  i;
00315     string  s;
00316     <span class="keywordtype">char</span>    fName[128];
00317     size_t  n;
00318     <span class="keywordtype">char</span>    c;
00319     <span class="keywordtype">int</span> barNum = 0;
00320 
00321 
00322     MemFormat BAR0Access(pBAR0, BAR0_SIZE);   <span class="comment">// max range to read</span>
00323     MemFormat BAR1Access(pBAR1, BAR1_SIZE);   <span class="comment">// max range to read</span>
00324 
00325     <a class="code" href="_p_c_ie__menu_8cpp.html#a10">showHelp</a>();
00326 
00327     done = <span class="keyword">false</span>;
00328     <span class="keywordflow">while</span> (!done)
00329     {
00330         <span class="comment">// show the prompt</span>
00331         cout&lt;&lt;<span class="stringliteral">"\n=&gt; "</span>;
00332         argCnt = 0;
00333 
00334         s.clear();
00335 
00336         <span class="keywordflow">switch</span> (getCmd(line))
00337         {
00338             <span class="keywordflow">case</span> <span class="charliteral">'r'</span>:   <span class="comment">// read:  r [addr [count]]</span>
00339             <span class="keywordflow">case</span> <span class="charliteral">'R'</span>:
00340                                <span class="keywordflow">if</span> (barNum == 0)
00341                                {
00342                                    <span class="keywordflow">if</span> (BAR0Access.doCmd(line, s))
00343                                            cout&lt;&lt;s&lt;&lt;endl;
00344                                }
00345                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (barNum == 1)
00346                                {
00347                                    <span class="keywordflow">if</span> (BAR1Access.doCmd(line, s))
00348                                            cout&lt;&lt;s&lt;&lt;endl;
00349                                }
00350                 <span class="keywordflow">break</span>;
00351 
00352             <span class="keywordflow">case</span> <span class="charliteral">'w'</span>:  <span class="comment">// write:  w &lt;address&gt; [data_1]...[data_n]</span>
00353             <span class="keywordflow">case</span> <span class="charliteral">'W'</span>:
00354                                 <span class="keywordflow">if</span> (barNum == 0)
00355                                 {
00356                                     BAR0Access.doCmd(line, s);
00357                                 }
00358                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (barNum == 1)
00359                                 {
00360                                     BAR1Access.doCmd(line, s);
00361                                 }
00362                 <span class="keywordflow">break</span>;
00363 
00364 
00365                         <span class="keywordflow">case</span> <span class="charliteral">'b'</span>:  <span class="comment">// BAR selection</span>
00366                         <span class="keywordflow">case</span> <span class="charliteral">'B'</span>:
00367                                 <span class="keywordflow">if</span> (((line[0] == <span class="charliteral">'B'</span>) || (line[0] == <span class="charliteral">'b'</span>)) &amp;&amp; (line[1] == <span class="charliteral">'1'</span>))
00368                                     barNum = 1;
00369                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((line[0] == <span class="charliteral">'B'</span>) || (line[0] == <span class="charliteral">'b'</span>)) &amp;&amp; (line[1] == <span class="charliteral">'0'</span>))
00370                                     barNum = 0;  <span class="comment">// default</span>
00371                                 cout&lt;&lt;<span class="stringliteral">"Accessing BAR"</span>&lt;&lt;barNum&lt;&lt;endl;
00372                                 <span class="keywordflow">break</span>;
00373  
00374 
00375 
00376             <span class="keywordflow">case</span> <span class="charliteral">'c'</span>:  <span class="comment">// Show PCI Config registers</span>
00377             <span class="keywordflow">case</span> <span class="charliteral">'C'</span>:
00378                 cout&lt;&lt;<span class="stringliteral">"PCI Config Registers (00-3f):\n"</span>;
00379                 pDrvr-&gt;getPCIConfigRegs(buf);
00380                 MemFormat::formatBlockOfBytes(s, 0x00, 0x40, buf);
00381                 cout&lt;&lt;s&lt;&lt;endl;
00382                 s.clear();  <span class="comment">// clear the string</span>
00383                 pDrvr-&gt;getPCIResourcesStr(s);
00384                 cout&lt;&lt;s&lt;&lt;endl;
00385 
00386                 cout&lt;&lt;<span class="stringliteral">"\n\nPCI Capabilities Registers (40-ff):\n"</span>;
00387                 s.clear();  <span class="comment">// clear the string</span>
00388                 MemFormat::formatBlockOfBytes(s, 0x40, 0xc0, &amp;buf[0x40]);
00389                 cout&lt;&lt;s&lt;&lt;endl;
00390                 s.clear();  <span class="comment">// clear the string</span>
00391                 pDrvr-&gt;getPCICapabiltiesStr(s);
00392                 cout&lt;&lt;s&lt;&lt;endl;
00393                 <span class="keywordflow">break</span>;
00394 
00395             <span class="keywordflow">case</span> <span class="charliteral">'e'</span>:   <span class="comment">// Show PCI Express registers</span>
00396             <span class="keywordflow">case</span> <span class="charliteral">'E'</span>:
00397                 cout&lt;&lt;<span class="stringliteral">"PCI Express Extended Capabilities Registers (100-fff)\n"</span>;
00398                 cout&lt;&lt;<span class="stringliteral">"Not accessable yet.\n"</span>;
00399                 <span class="keywordflow">break</span>;
00400 
00401             <span class="keywordflow">case</span> <span class="charliteral">'m'</span>:  <span class="comment">// Memory test</span>
00402             <span class="keywordflow">case</span> <span class="charliteral">'M'</span>:
00403                 <span class="keywordflow">if</span> ((line[0] == <span class="charliteral">'m'</span>) &amp;&amp; (line[1] == <span class="charliteral">'c'</span>))
00404                 {
00405                     <span class="keywordflow">if</span> (pEBR-&gt;clear())
00406                     cout&lt;&lt;<span class="stringliteral">"EBR Memory cleared to 0x00"</span>&lt;&lt;endl;
00407                     <span class="keywordflow">else</span>
00408                     cout&lt;&lt;<span class="stringliteral">"ERROR! in Memory clear!"</span>&lt;&lt;endl;
00409                     <span class="keywordflow">break</span>;
00410                 }
00411                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((line[0] == <span class="charliteral">'m'</span>) &amp;&amp; (line[1] == <span class="charliteral">'f'</span>))
00412                 {
00413                     n = sscanf(&amp;line[3], <span class="stringliteral">"%x"</span>, &amp;i);
00414                     <span class="keywordflow">if</span> (n == 1)
00415                     {
00416                         <span class="keywordflow">if</span> (pEBR-&gt;fill((uint8_t)i))
00417                         cout&lt;&lt;<span class="stringliteral">"EBR Memory filled with 0x"</span>&lt;&lt;hex&lt;&lt;i&lt;&lt;endl;
00418                         <span class="keywordflow">else</span>
00419                         cout&lt;&lt;<span class="stringliteral">"ERROR!  Memory Fill failed!"</span>&lt;&lt;endl;
00420                     }
00421                     <span class="keywordflow">break</span>;
00422                 }
00423                 <span class="keywordflow">else</span>
00424                 {
00425                     <span class="keywordflow">if</span> (pEBR-&gt;test())
00426                     cout&lt;&lt;<span class="stringliteral">"PASS"</span>&lt;&lt;endl;
00427                     <span class="keywordflow">else</span>
00428                     cout&lt;&lt;<span class="stringliteral">"FAILED"</span>&lt;&lt;endl;
00429                 }
00430                 <span class="keywordflow">break</span>;
00431 
00432 
00433             <span class="keywordflow">case</span> <span class="charliteral">'i'</span>:  <span class="comment">// Input file into EBR Memory</span>
00434             <span class="keywordflow">case</span> <span class="charliteral">'I'</span>:
00435                 i = sscanf(line,  <span class="stringliteral">"%c %s"</span>, &amp;c, fName);
00436                 <span class="keywordflow">if</span> (i != 2)
00437                     <span class="keywordflow">break</span>;
00438                 <span class="keywordflow">if</span> (pEBR-&gt;loadFromFile(fName))
00439                     cout&lt;&lt;<span class="stringliteral">"OK"</span>&lt;&lt;endl;
00440                 <span class="keywordflow">else</span>
00441                     cout&lt;&lt;<span class="stringliteral">"FAILED"</span>&lt;&lt;endl;
00442                 <span class="keywordflow">break</span>;
00443 
00444             <span class="keywordflow">case</span> <span class="charliteral">'o'</span>:  <span class="comment">// write EBR memory to a File</span>
00445             <span class="keywordflow">case</span> <span class="charliteral">'O'</span>:
00446                 i = sscanf(line,  <span class="stringliteral">"%c %s"</span>, &amp;c, fName);
00447                 <span class="keywordflow">if</span> (i != 2)
00448                     <span class="keywordflow">break</span>;
00449                 <span class="keywordflow">if</span> (pEBR-&gt;saveToFile(fName))
00450                     cout&lt;&lt;<span class="stringliteral">"OK"</span>&lt;&lt;endl;
00451                 <span class="keywordflow">else</span>
00452                     cout&lt;&lt;<span class="stringliteral">"FAILED"</span>&lt;&lt;endl;
00453                 <span class="keywordflow">break</span>;
00454 
00455 
00456             <span class="keywordflow">case</span> <span class="charliteral">'l'</span>:  <span class="comment">// LED test - </span>
00457             <span class="keywordflow">case</span> <span class="charliteral">'L'</span>:
00458                 pGPIO-&gt;LED16DisplayTest();
00459                 <span class="keywordflow">break</span>;
00460 
00461 
00462             <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:  <span class="comment">// DIP Switch Test </span>
00463             <span class="keywordflow">case</span> <span class="charliteral">'D'</span>:
00464                 cout&lt;&lt;<span class="stringliteral">"=== DIP Switch Test ===\n"</span>;
00465                 cout&lt;&lt;<span class="stringliteral">"Reading switch setting 10 times:\n"</span>;
00466                 <span class="keywordflow">for</span> (i = 0; i &lt; 10; i++)
00467                 {
00468                     d = pGPIO-&gt;getDIPsw();
00469                     cout&lt;&lt;<span class="stringliteral">"["</span>&lt;&lt;dec&lt;&lt;i&lt;&lt;<span class="stringliteral">"] read: 0x"</span>&lt;&lt;hex&lt;&lt;(<span class="keywordtype">unsigned</span> int)d&lt;&lt;endl;
00470                     Sleep(1000);
00471                 }
00472                 <span class="keywordflow">break</span>;
00473 
00474             <span class="keywordflow">case</span> <span class="charliteral">'n'</span>:  <span class="comment">// Interrupt Test</span>
00475             <span class="keywordflow">case</span> <span class="charliteral">'N'</span>:
00476                 cout&lt;&lt;<span class="stringliteral">"PCI Express Interrupt Test\n"</span>;
00477                 cout&lt;&lt;<span class="stringliteral">"NOT IMPLEMENTED YET\n"</span>;
00478                 <span class="keywordflow">break</span>;
00479 
00480             <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:  <span class="comment">// Version and Driver info</span>
00481             <span class="keywordflow">case</span> <span class="charliteral">'V'</span>:
00482                 cout&lt;&lt;<span class="stringliteral">"PCI Driver Version:\n"</span>;
00483                 <span class="keywordflow">if</span> (pDrvr-&gt;getDriverVersionStr(s))
00484                     cout&lt;&lt;s&lt;&lt;endl;
00485                 cout&lt;&lt;<span class="stringliteral">"PCI Driver Information:\n"</span>;
00486                 s.clear();
00487                 <span class="keywordflow">if</span> (pDrvr-&gt;getDriverResourcesStr(s))
00488                     cout&lt;&lt;s&lt;&lt;endl;
00489                 <span class="keywordflow">break</span>;
00490 
00491             <span class="keywordflow">case</span> <span class="charliteral">'t'</span>:
00492             <span class="keywordflow">case</span> <span class="charliteral">'T'</span>:
00493                 <span class="keywordflow">if</span> (line[1] == <span class="charliteral">'1'</span>)
00494                 {
00495                     uint32_t id_reg;
00496                     <span class="keywordtype">int</span> t1_times;
00497                     <span class="keywordtype">int</span> tt = 1;
00498                     cout&lt;&lt;<span class="stringliteral">"T1 - read Demo ID test"</span>&lt;&lt;endl;
00499                     i = sscanf(&amp;line[2],  <span class="stringliteral">"%d"</span>, &amp;t1_times);
00500                     <span class="keywordflow">if</span> (i != 1)
00501                         t1_times = 100000;
00502 
00503                     <span class="keywordflow">do</span>
00504                     {
00505                         cout&lt;&lt;dec&lt;&lt;tt&lt;&lt;endl;
00506                         ++tt;
00507                         id_reg = pGPIO-&gt;getID();
00508                         <span class="keywordflow">if</span> (t1_times &gt; 0)
00509                             --t1_times;
00510                     } <span class="keywordflow">while</span>((id_reg == 0x53030100) &amp;&amp; (t1_times != 0));
00511                     <span class="keywordflow">if</span> (t1_times)
00512                         cout&lt;&lt;<span class="stringliteral">"FAILURE: read 0x"</span>&lt;&lt;hex&lt;&lt;id_reg&lt;&lt;<span class="stringliteral">" not 0x53030100"</span>&lt;&lt;endl;
00513                 }
00514                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (line[1] == <span class="charliteral">'2'</span>)
00515                 {
00516                     uint32_t wr_val = 0x11223344;
00517                     <span class="keywordtype">int</span> t2_times;
00518                     <span class="keywordtype">int</span> tt = 1;
00519                     cout&lt;&lt;<span class="stringliteral">"T2 - write test"</span>&lt;&lt;endl;
00520                     i = sscanf(&amp;line[2],  <span class="stringliteral">"%d"</span>, &amp;t2_times);
00521                     <span class="keywordflow">if</span> (i != 1)
00522                         t2_times = 100000;
00523 
00524                     <span class="keywordflow">do</span>
00525                     {
00526                         pGPIO-&gt;setScratchPad(wr_val);
00527                         cout&lt;&lt;dec&lt;&lt;tt&lt;&lt;<span class="stringliteral">": wr="</span>&lt;&lt;hex&lt;&lt;wr_val&lt;&lt;endl;
00528                         ++tt;
00529                         <span class="keywordflow">if</span> (t2_times &gt; 0)
00530                             --t2_times;
00531                     } <span class="keywordflow">while</span> (t2_times != 0);
00532                 }
00533                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (line[1] == <span class="charliteral">'3'</span>)
00534                 {
00535                     uint32_t wr_val;
00536                     uint32_t rd_val;
00537                     <span class="keywordtype">int</span> t3_times;
00538                     <span class="keywordtype">int</span> tt = 1;
00539                     cout&lt;&lt;<span class="stringliteral">"T3 - write/read test"</span>&lt;&lt;endl;
00540                     i = sscanf(&amp;line[2],  <span class="stringliteral">"%d"</span>, &amp;t3_times);
00541                     <span class="keywordflow">if</span> (i != 1)
00542                         t3_times = 100000;
00543 
00544                     <span class="keywordflow">do</span>
00545                     {
00546                         wr_val = ((rand())&lt;&lt;16) | rand();
00547                         pGPIO-&gt;setScratchPad(wr_val);
00548                         cout&lt;&lt;dec&lt;&lt;tt&lt;&lt;<span class="stringliteral">": wr="</span>&lt;&lt;hex&lt;&lt;wr_val&lt;&lt;endl;
00549                         ++tt;
00550                         rd_val = pGPIO-&gt;getScratchPad();
00551                         <span class="keywordflow">if</span> (t3_times &gt; 0)
00552                             --t3_times;
00553                     } <span class="keywordflow">while</span> ((t3_times != 0) &amp;&amp; (rd_val == wr_val));
00554 
00555                     <span class="keywordflow">if</span> (rd_val != wr_val)
00556                         cout&lt;&lt;<span class="stringliteral">"FAILURE: read 0x"</span>&lt;&lt;hex&lt;&lt;rd_val&lt;&lt;<span class="stringliteral">"   wrote 0x"</span>&lt;&lt;hex&lt;&lt;wr_val&lt;&lt;endl;
00557 
00558                 }
00559                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (line[1] == <span class="charliteral">'4'</span>)
00560                 {
00561                     uint32_t wr_val;
00562                     uint32_t rd_val;
00563                     <span class="keywordtype">int</span> t4_times;
00564                     <span class="keywordtype">int</span> tt = 0;
00565                     <span class="keywordtype">int</span> addr;
00566                     cout&lt;&lt;<span class="stringliteral">"T4 - write32/read32 EBR test"</span>&lt;&lt;endl;
00567                     i = sscanf(&amp;line[2],  <span class="stringliteral">"%d"</span>, &amp;t4_times);
00568                     <span class="keywordflow">if</span> (i != 1)
00569                         t4_times = 100000;
00570 
00571                     <span class="keywordflow">do</span>
00572                     {
00573                         addr = (tt &amp; 0x3ffc);
00574                         wr_val = ((rand())&lt;&lt;16) | rand();
00575                         pEBR-&gt;write32(addr, wr_val);
00576                         rd_val = pEBR-&gt;read32(addr);
00577                         cout&lt;&lt;dec&lt;&lt;tt&lt;&lt;<span class="stringliteral">": addr= "</span>&lt;&lt;hex&lt;&lt;addr&lt;&lt;<span class="stringliteral">"  wr="</span>&lt;&lt;hex&lt;&lt;wr_val&lt;&lt;<span class="stringliteral">"  rd="</span>&lt;&lt;hex&lt;&lt;rd_val&lt;&lt;endl;
00578                         <span class="keywordflow">if</span> (t4_times &gt; 0)
00579                             --t4_times;
00580                         ++tt;
00581 
00582                     } <span class="keywordflow">while</span> ((t4_times != 0) &amp;&amp; (rd_val == wr_val));
00583 
00584                     <span class="keywordflow">if</span> (rd_val != wr_val)
00585                         cout&lt;&lt;<span class="stringliteral">"FAILURE @ 0x"</span>&lt;&lt;hex&lt;&lt;addr&lt;&lt;<span class="stringliteral">"  read 0x"</span>&lt;&lt;hex&lt;&lt;rd_val&lt;&lt;<span class="stringliteral">"   wrote 0x"</span>&lt;&lt;hex&lt;&lt;wr_val&lt;&lt;endl;
00586 
00587                 }
00588                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (line[1] == <span class="charliteral">'5'</span>)
00589                 {
00590                     uint8_t wr_val;
00591                     uint8_t rd_val;
00592                     <span class="keywordtype">int</span> t5_times;
00593                     <span class="keywordtype">int</span> tt = 0;
00594                     <span class="keywordtype">int</span> addr;
00595                     cout&lt;&lt;<span class="stringliteral">"T5 - write8/read8 EBR test"</span>&lt;&lt;endl;
00596                     i = sscanf(&amp;line[2],  <span class="stringliteral">"%d"</span>, &amp;t5_times);
00597                     <span class="keywordflow">if</span> (i != 1)
00598                         t5_times = 100000;
00599 
00600                     <span class="keywordflow">do</span>
00601                     {
00602                         addr = (tt &amp; 0x3fff);
00603                         wr_val = (rand() &amp; 0xff);
00604                         pEBR-&gt;write8(addr, wr_val);
00605                         rd_val =  pEBR-&gt;read8(addr);
00606                         cout&lt;&lt;dec&lt;&lt;tt&lt;&lt;<span class="stringliteral">": addr= "</span>&lt;&lt;hex&lt;&lt;addr&lt;&lt;<span class="stringliteral">"  wr="</span>&lt;&lt;hex&lt;&lt;(int)wr_val&lt;&lt;<span class="stringliteral">"  rd="</span>&lt;&lt;hex&lt;&lt;(int)rd_val&lt;&lt;endl;
00607                         <span class="keywordflow">if</span> (t5_times &gt; 0)
00608                             --t5_times;
00609                         ++tt;
00610 
00611                     } <span class="keywordflow">while</span> ((t5_times != 0) &amp;&amp; (rd_val == wr_val));
00612 
00613                     <span class="keywordflow">if</span> (rd_val != wr_val)
00614                         cout&lt;&lt;<span class="stringliteral">"FAILURE @ 0x"</span>&lt;&lt;hex&lt;&lt;addr&lt;&lt;<span class="stringliteral">"  read 0x"</span>&lt;&lt;hex&lt;&lt;(int)rd_val&lt;&lt;<span class="stringliteral">"   wrote 0x"</span>&lt;&lt;hex&lt;&lt;(int)wr_val&lt;&lt;endl;
00615 
00616                 }
00617                 <span class="keywordflow">break</span>;
00618     
00619 
00620             <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:  <span class="comment">// Help</span>
00621             <span class="keywordflow">case</span> <span class="charliteral">'H'</span>:
00622             <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
00623                 <a class="code" href="_p_c_ie__menu_8cpp.html#a10">showHelp</a>();
00624                 <span class="keywordflow">break</span>;
00625 
00626             <span class="keywordflow">case</span> <span class="charliteral">'q'</span>:
00627             <span class="keywordflow">case</span> <span class="charliteral">'Q'</span>:
00628             <span class="keywordflow">case</span> <span class="charliteral">'X'</span>:
00629             <span class="keywordflow">case</span> <span class="charliteral">'x'</span>:
00630                 done = <span class="keyword">true</span>;
00631                 <span class="keywordflow">break</span>;
00632 
00633             <span class="keywordflow">default</span>:
00634                 <a class="code" href="_p_c_ie__menu_8cpp.html#a10">showHelp</a>();
00635         }
00636 
00637         strcpy(lastCmd, line);
00638     }
00639 
00640 }
00641 
00642 
<a name="l00646"></a><a class="code" href="_p_c_ie__menu_8cpp.html#a10">00646</a> <span class="keywordtype">void</span>    <a class="code" href="_p_c_ie__menu_8cpp.html#a10">showHelp</a>(<span class="keywordtype">void</span>)
00647 {
00648     cout&lt;&lt;<span class="stringliteral">"\n\n======= PCIe Basic Demo Menu ==========\n"</span>;
00649     cout&lt;&lt;<span class="stringliteral">" c - PCI Config Registers\n"</span>;
00650     cout&lt;&lt;<span class="stringliteral">" e - PCIe Extended Capabilities Registers\n"</span>;
00651     cout&lt;&lt;<span class="stringliteral">" l - LED test\n"</span>;
00652     cout&lt;&lt;<span class="stringliteral">" d - DIP switch setting\n"</span>;
00653     cout&lt;&lt;<span class="stringliteral">" m[cf] - EBR memory test\n"</span>;
00654     cout&lt;&lt;<span class="stringliteral">" i &lt;file&gt; - Input file to EBR memory\n"</span>;
00655     cout&lt;&lt;<span class="stringliteral">" o &lt;file&gt; - Output EBR memory to file\n"</span>;
00656     cout&lt;&lt;<span class="stringliteral">" r[bsl] [&lt;addr&gt; [count]]\n"</span>;
00657     cout&lt;&lt;<span class="stringliteral">" w[bsl] [&lt;addr&gt; &lt;data_1&gt;...&lt;data_n&gt;]\n"</span>;
00658     cout&lt;&lt;<span class="stringliteral">" b[0|1] - set BAR space access\n"</span>;
00659     cout&lt;&lt;<span class="stringliteral">" v - version and driver info\n"</span>;
00660     cout&lt;&lt;<span class="stringliteral">" t[1-5] [num] - run a debug test num times\n"</span>;
00661     cout&lt;&lt;<span class="stringliteral">" q,x - exit\n\n"</span>;
00662 }
00663 
00664 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Jul 16 12:05:30 2008 for Lattice PCIe Basic Demo by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
