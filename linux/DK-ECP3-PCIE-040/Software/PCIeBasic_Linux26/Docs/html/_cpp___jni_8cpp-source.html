<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Lattice PCIe Basic Demo: Cpp_Jni.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">BasicGUI</a>&nbsp;/&nbsp;<a class="el" href="dir_000001.html">Cpp_DLL</a></div>
<h1>Cpp_Jni.cpp</h1><a href="_cpp___jni_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> *  COPYRIGHT (c) 2008 by Lattice Semiconductor Corporation</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * All rights reserved. All use of this software and documentation is</span>
00005 <span class="comment"> * subject to the License Agreement located in the file LICENSE.</span>
00006 <span class="comment"> */</span>
00110 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
00111 <span class="preprocessor">#include &lt;iostream&gt;</span>
00112 <span class="preprocessor">#include &lt;string&gt;</span>
00113 <span class="preprocessor">#include &lt;sstream&gt;</span>
00114 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00115 <span class="preprocessor">#include &lt;iostream&gt;</span>
00116 <span class="preprocessor">#include &lt;exception&gt;</span>
00117 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00118 
00119 <span class="comment">// Auto-generated with Java utility javah</span>
00120 <span class="preprocessor">#include "com_latticesemi_lpa_apps_pcie_DemoUI.h"</span>
00121 <span class="preprocessor">#include "PCIeAPI.h"</span>         <span class="comment">// the APIs</span>
00122 <span class="preprocessor">#include "LSCPCIe2_IF.h"</span>     <span class="comment">// the driver interface</span>
00123 <span class="preprocessor">#include "GPIO.h"</span>            <span class="comment">// the GPIO IP module</span>
00124 <span class="preprocessor">#include "Mem.h"</span>            <span class="comment">// the SFIF IP module</span>
00125 <span class="preprocessor">#include "MiscUtils.h"</span>
00126 <span class="preprocessor">#include "MemFormat.h"</span>
00127 <span class="preprocessor">#include "../../MemMap.h"</span>       <span class="comment">// IP module base addresses</span>
00128 <span class="preprocessor">#include "DebugPrint.h"</span>
00129 
00130 
00131 
00132 
00134 <span class="comment">// Required to use Lattice PCIe methods</span>
00136 <span class="comment"></span><span class="keyword">using</span> <span class="keyword">namespace </span>LatticeSemi_PCIe;
00137 
00138 
00139 
00140 
00141 
00142 <span class="comment">/*===== GLOBAL VARIABLES ========*/</span>
00143 
00144 LSCPCIe2_IF *pDrvr;
00145 Mem         *pEBR;
00146 Mem         *pBAR0;
00147 Mem         *pBAR1;
00148 GPIO        *pGPIO;
00149 
00150 
00151 <span class="keywordtype">bool</span> SimHdw = <span class="keyword">false</span>;
00152 
00153 
00154 <span class="keyword">static</span> <span class="keywordtype">char</span> HexChar[16] = {<span class="charliteral">'0'</span>, <span class="charliteral">'1'</span>, <span class="charliteral">'2'</span>, <span class="charliteral">'3'</span>, <span class="charliteral">'4'</span>, <span class="charliteral">'5'</span>, <span class="charliteral">'6'</span>, <span class="charliteral">'7'</span>, 
00155     <span class="charliteral">'8'</span>, <span class="charliteral">'9'</span>, <span class="charliteral">'A'</span>, <span class="charliteral">'B'</span>, <span class="charliteral">'C'</span>, <span class="charliteral">'D'</span>, <span class="charliteral">'E'</span>, <span class="charliteral">'F'</span>};
00156 
00157 
<a name="l00162"></a><a class="code" href="dllmain_8cpp.html#a0">00162</a> <span class="keywordtype">bool</span> <a class="code" href="_cpp___jni_8cpp.html#a7">createBasicDemo</a>(<span class="keywordtype">void</span>)
00163 {
00164     <span class="keywordtype">char</span> boardName[LSC_PCIE_BOARD_NAME_LEN + 1];
00165     <span class="keywordtype">char</span> demoName[LSC_PCIE_DEMO_NAME_LEN + 1];
00166     uint32_t boardNum;
00167 
00168 
00169     ENTER();
00170 
00171     DEBUGSTR(<span class="stringliteral">"Creating the PCIe Basic Demo\n"</span>);
00172 
00173 
00174     DEBUGSTR(<span class="stringliteral">"Instantiate the PCIeAPI DLL class\n"</span>);
00175     PCIeAPI theDLL;
00176     DEBUGPRINT((<span class="stringliteral">"PCIeAPI_Lib version info: %s\n"</span>, theDLL.getVersionStr()));
00177 
00178 <span class="preprocessor">#ifndef RELEASE</span>
00179 <span class="preprocessor"></span>    <span class="comment">// Setup so lots of diag output occurs</span>
00180     PCIeAPI::setRunTimeCtrl(PCIeAPI::VERBOSE);
00181     
00182 <span class="preprocessor">#endif</span>
00183 <span class="preprocessor"></span>
00184     <span class="comment">// Get the environment variables needed to open the desired board</span>
00185     <span class="comment">// Pre-load with defaults</span>
00186     strcpy(boardName, <span class="stringliteral">"SIM"</span>);
00187     strcpy(demoName, <span class="stringliteral">"subsys_30101204"</span>);
00188     <span class="keywordflow">if</span> (!GetPCIeEnvVars(boardName, demoName, boardNum))
00189         cout&lt;&lt;<span class="stringliteral">"\nEnvVars not found.  Using defaults.\n"</span>;
00190 
00191     cout&lt;&lt;<span class="stringliteral">"boardName = "</span>&lt;&lt;boardName&lt;&lt;endl;
00192     cout&lt;&lt;<span class="stringliteral">"boardNum = "</span>&lt;&lt;boardNum&lt;&lt;endl;
00193     cout&lt;&lt;<span class="stringliteral">"demoName = "</span>&lt;&lt;demoName&lt;&lt;endl;
00194     
00195     <span class="keywordflow">try</span>
00196     {
00197 
00198         <span class="comment">// Find out what board the user expects to run on</span>
00199         <span class="keywordflow">if</span> (boardName == NULL)
00200             strcpy(boardName, <span class="stringliteral">"SIM"</span>);
00201 
00202         <span class="keywordflow">if</span> (strcmp(boardName, <span class="stringliteral">"SIM"</span>) == 0)
00203         {
00204             DEBUGSTR(<span class="stringliteral">"Using View-Only Mode!  No Real Hardware Access!\n"</span>);
00205 
00206             pDrvr = NULL;
00207             pEBR = NULL;
00208             pBAR0 = NULL;
00209             pBAR1 = NULL;
00210             pGPIO = NULL;
00211             SimHdw = <span class="keyword">true</span>;
00212         }
00213         <span class="keywordflow">else</span>
00214         {
00215             cout&lt;&lt;<span class="stringliteral">"Opening LSCPCIe2_IF...\n"</span>;
00216             pDrvr = <span class="keyword">new</span> LSCPCIe2_IF(boardName, 
00217                         demoName, 
00218                             boardNum);
00219 
00220             <span class="comment">// Create Device instances used in the demo</span>
00221             
00222             pGPIO = <span class="keyword">new</span> GPIO(<span class="stringliteral">"GPIO"</span>,         <span class="comment">// a unique name for the IP module instance</span>
00223                       GPIOreg(0),    <span class="comment">// its base address</span>
00224                       pDrvr);        <span class="comment">// driver interface to use for register access</span>
00225             pEBR = <span class="keyword">new</span> Mem(<span class="stringliteral">"EBR16k"</span>,         <span class="comment">// a unique name for the IP module instance</span>
00226                           EBR_SIZE,
00227                       EBRreg(0),    <span class="comment">// its base address</span>
00228                           pDrvr);        <span class="comment">// driver interface to use for register access</span>
00229 
00230             pBAR0 = <span class="keyword">new</span> Mem(<span class="stringliteral">"BAR0"</span>,         <span class="comment">// a unique name for the IP module instance</span>
00231                          BAR0_SIZE,
00232                       BAR0reg(0),    <span class="comment">// its base address</span>
00233                           pDrvr);        <span class="comment">// driver interface to use for register access</span>
00234 
00235             pBAR1 = <span class="keyword">new</span> Mem(<span class="stringliteral">"BAR1"</span>,         <span class="comment">// a unique name for the IP module instance</span>
00236                          BAR1_SIZE,
00237                       BAR1reg(0),    <span class="comment">// its base address</span>
00238                           pDrvr);        <span class="comment">// driver interface to use for register access</span>
00239         }
00240 
00241     }
00242     <span class="keywordflow">catch</span> (std::exception &amp;e)
00243     {
00244         DEBUGSTR(<span class="stringliteral">"RUNTIME ERROR!!!...\n"</span>);
00245         DEBUGSTRNL(e.what());
00246         <span class="keywordflow">return</span>(<span class="keyword">false</span>);
00247     }
00248 
00249     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00250 }
00251 
00252 
<a name="l00257"></a><a class="code" href="dllmain_8cpp.html#a1">00257</a> <span class="keywordtype">bool</span> <a class="code" href="_cpp___jni_8cpp.html#a8">deleteBasicDemo</a>(<span class="keywordtype">void</span>)
00258 {
00259     ENTER();
00260 
00261     <span class="keywordflow">if</span> (!SimHdw)
00262     {
00263         <span class="keywordflow">if</span> (pDrvr &amp;&amp; pBAR0 &amp;&amp; pBAR1 &amp;&amp; pEBR &amp;&amp; pGPIO)
00264         {
00265             <span class="comment">// delete the device objects open to the device driver</span>
00266             <span class="keyword">delete</span> pEBR;
00267             <span class="keyword">delete</span> pBAR0;
00268             <span class="keyword">delete</span> pBAR1;
00269             <span class="keyword">delete</span> pGPIO;
00270             <span class="keyword">delete</span> pDrvr;
00271 
00272             pEBR = NULL;
00273             pBAR0 = NULL;
00274             pBAR1 = NULL;
00275             pGPIO = NULL;
00276             pDrvr = NULL;
00277         }
00278     }
00279     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00280 }
00281 
00282 
00283 <span class="comment">/*==========================================================================*/</span>
00284 <span class="comment">/*==========================================================================*/</span>
00285 <span class="comment">/*==========================================================================*/</span>
00286 <span class="comment">/*</span>
00287 <span class="comment"> *   IMPLEMENT THE JNI METHODS TO ACCESS AND CONTROL THE FPGA VIA API CLASS</span>
00288 <span class="comment"> *</span>
00289 <span class="comment"> *   NOTE: Function signatures are created by JNI!  Must follow proper</span>
00290 <span class="comment"> *   procedures for variable usage and passing.</span>
00291 <span class="comment"> */</span>
00292 <span class="comment">/*==========================================================================*/</span>
00293 <span class="comment">/*==========================================================================*/</span>
00294 <span class="comment">/*==========================================================================*/</span>
00295 
00296 <span class="comment">/*</span>
00297 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00298 <span class="comment"> * Method:    CPP_getVersionStr</span>
00299 <span class="comment"> * Signature: ()Ljava/lang/String;</span>
00300 <span class="comment"> */</span>
00301 
00302 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1getVersionStr(JNIEnv *env, jobject obj)
00303 {
00304     string retStr;
00305 
00306     ENTER();
00307 
00308     <span class="keywordflow">if</span> (pDrvr-&gt;getDriverVersionStr(retStr))
00309         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(retStr.c_str()));         
00310     <span class="keywordflow">else</span>
00311         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"ERROR"</span>));         
00312 }
00313 
00314 <span class="comment">/*</span>
00315 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00316 <span class="comment"> * Method:    CPP_getDrvrResourceStr</span>
00317 <span class="comment"> * Signature: ()Ljava/lang/String;</span>
00318 <span class="comment"> */</span>
00319 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1getDrvrResourceStr(JNIEnv *env, jobject obj)
00320 {
00321     string retStr;
00322 
00323     ENTER();
00324 
00325     <span class="keywordflow">if</span> (pDrvr-&gt;getDriverResourcesStr(retStr))
00326         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(retStr.c_str()));
00327     <span class="keywordflow">else</span>
00328         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"ERROR"</span>));         
00329 }
00330 
00331 
00332 
00333 <span class="comment">/*</span>
00334 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00335 <span class="comment"> * Method:    CPP_getPCIResourceStr</span>
00336 <span class="comment"> * Signature: ()Ljava/lang/String;</span>
00337 <span class="comment"> */</span>
00338 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1getPCIResourceStr(JNIEnv *env, jobject obj)
00339 {
00340     string retStr;
00341 
00342     ENTER();
00343 
00344     <span class="keywordflow">if</span> (pDrvr-&gt;getPCIResourcesStr(retStr))
00345         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(retStr.c_str()));
00346     <span class="keywordflow">else</span>
00347         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"ERROR"</span>));         
00348 }
00349 
00350 
00351 
00352 <span class="comment">/*</span>
00353 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00354 <span class="comment"> * Method:    CPP_getCfgRegsStr</span>
00355 <span class="comment"> * Signature: ()Ljava/lang/String;</span>
00356 <span class="comment"> */</span>
00357 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1getCfgRegsStr(JNIEnv *env, jobject obj)
00358 {
00359     string regVals, regFields, retStr;
00360     uint8_t cfgs[256];
00361 
00362     ENTER();
00363 
00364     <span class="keywordflow">if</span> (pDrvr-&gt;getPCIResourcesStr(regFields))
00365     {
00366         pDrvr-&gt;getPCIConfigRegs(cfgs);
00367         <span class="comment">// Call routine to format</span>
00368         MemFormat::formatBlockOfBytes(regVals, 0x00, 0x40, cfgs);
00369         retStr = regVals + regFields;
00370         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(retStr.c_str()));         
00371     }
00372     <span class="keywordflow">else</span>
00373     {
00374         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"ERROR"</span>));         
00375     }
00376 }
00377 
00378 
00379 
00380 <span class="comment">/*</span>
00381 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00382 <span class="comment"> * Method:    CPP_getCapRegStr</span>
00383 <span class="comment"> * Signature: ()Ljava/lang/String;</span>
00384 <span class="comment"> */</span>
00385 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1getCapRegStr(JNIEnv *env, jobject obj)
00386 {
00387     string regVals, regFields, retStr;
00388     uint8_t caps[256];
00389 
00390     ENTER();
00391 
00392     <span class="keywordflow">if</span> (pDrvr-&gt;getPCICapabiltiesStr(regFields))
00393     {
00394         pDrvr-&gt;getPCIConfigRegs(caps);
00395         <span class="comment">// Call routine to format the memory bytes into a table format in a string</span>
00396         MemFormat::formatBlockOfBytes(regVals, 0x40, (0x100-0x40), &amp;caps[0x40]);
00397         retStr = regVals + regFields;
00398         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(retStr.c_str()));         
00399     }
00400     <span class="keywordflow">else</span>
00401     {
00402         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"ERROR"</span>));         
00403     }
00404 
00405 
00406 }
00407 
00408 
00409 <span class="comment">/*</span>
00410 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00411 <span class="comment"> * Method:    CPP_getExtCapRegsStr</span>
00412 <span class="comment"> * Signature: ()Ljava/lang/String;</span>
00413 <span class="comment"> */</span>
00414 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1getExtCapRegsStr(JNIEnv *env, jobject obj)
00415 {
00416     <span class="keywordtype">char</span> retStr[4096];
00417 
00418     ENTER();
00419     strcpy(retStr, <span class="stringliteral">"NOT IMPLEMENTED: PCIe Extended Capabilities Registers"</span>);
00420 
00421     <span class="keywordflow">return</span>(env-&gt;NewStringUTF(retStr));         
00422 }
00423 
00424 
00425 <span class="comment">/*</span>
00426 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00427 <span class="comment"> * Method:    CPP_runEBRTest</span>
00428 <span class="comment"> * Signature: ()Ljava/lang/String;</span>
00429 <span class="comment"> */</span>
00430 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1runEBRTest(JNIEnv *env, jobject obj)
00431 {
00432     ENTER();
00433 
00434     <span class="keywordflow">if</span> (pEBR-&gt;test())
00435         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"PASS"</span>));
00436     <span class="keywordflow">else</span>
00437         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"ERRORS!!!"</span>));         
00438 }
00439 
00440 
00441 <span class="comment">/*</span>
00442 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00443 <span class="comment"> * Method:    CPP_readBAR0Mem</span>
00444 <span class="comment"> * Signature: (Ljava/lang/String;)Ljava/lang/String;</span>
00445 <span class="comment"> */</span>
00446 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1readBAR0Mem(JNIEnv *env, jobject obj, jstring cmd)
00447 {
00448     string retStr;
00449     <span class="keyword">const</span> <span class="keywordtype">char</span> *str;
00450 
00451     ENTER();
00452 
00453     MemFormat RWMem(pBAR0, BAR0_SIZE);   <span class="comment">// max range</span>
00454 
00455     str = env-&gt;GetStringUTFChars(cmd, NULL);
00456     <span class="keywordflow">if</span> (str == NULL)
00457     {
00458         <span class="keywordflow">return</span>(NULL);  <span class="comment">/* OutofMemory Error */</span>
00459     }
00460 
00461     <span class="comment">//cout&lt;&lt;" Cmd: "&lt;&lt;str&lt;&lt;endl;</span>
00462     DEBUGSTR(str);
00463 
00464     <span class="keywordflow">if</span> (RWMem.doCmd((<span class="keywordtype">char</span> *)str, retStr))
00465     {
00466         env-&gt;ReleaseStringUTFChars(cmd, str); 
00467         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(retStr.c_str()));         
00468     }
00469     <span class="keywordflow">else</span>
00470     {
00471         env-&gt;ReleaseStringUTFChars(cmd, str); 
00472         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"ERROR"</span>));         
00473     }
00474 }
00475 
00476 <span class="comment">/*</span>
00477 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00478 <span class="comment"> * Method:    CPP_writeBAR0Mem</span>
00479 <span class="comment"> * Signature: (Ljava/lang/String;)Ljava/lang/String;</span>
00480 <span class="comment"> */</span>
00481 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1writeBAR0Mem(JNIEnv *env, jobject obj, jstring cmd)
00482 {
00483     string retStr;
00484     <span class="keyword">const</span> <span class="keywordtype">char</span> *str;
00485 
00486     ENTER();
00487 
00488     MemFormat RWMem(pBAR0, BAR0_SIZE);   <span class="comment">// max range</span>
00489 
00490     str = env-&gt;GetStringUTFChars(cmd, NULL);
00491     <span class="keywordflow">if</span> (str == NULL)
00492     {
00493         <span class="keywordflow">return</span>(NULL);  <span class="comment">/* OutofMemory Error */</span>
00494     }
00495 
00496     <span class="comment">//cout&lt;&lt;" Cmd: "&lt;&lt;str&lt;&lt;endl;</span>
00497     DEBUGSTR(str);
00498 
00499     <span class="keywordflow">if</span> (RWMem.doCmd((<span class="keywordtype">char</span> *)str, retStr))
00500     {
00501         env-&gt;ReleaseStringUTFChars(cmd, str); 
00502         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(retStr.c_str()));         
00503     }
00504     <span class="keywordflow">else</span>
00505     {
00506         env-&gt;ReleaseStringUTFChars(cmd, str); 
00507         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"ERROR"</span>));         
00508     }
00509 }
00510 
00511 <span class="comment">/*</span>
00512 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00513 <span class="comment"> * Method:    CPP_readBAR1Mem</span>
00514 <span class="comment"> * Signature: (Ljava/lang/String;)Ljava/lang/String;</span>
00515 <span class="comment"> */</span>
00516 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1readBAR1Mem(JNIEnv *env, jobject obj, jstring cmd)
00517 {
00518     string retStr;
00519     <span class="keyword">const</span> <span class="keywordtype">char</span> *str;
00520 
00521     ENTER();
00522 
00523     MemFormat RWMem(pBAR1, BAR1_SIZE);   <span class="comment">// max range to read</span>
00524 
00525     str = env-&gt;GetStringUTFChars(cmd, NULL);
00526     <span class="keywordflow">if</span> (str == NULL)
00527     {
00528         <span class="keywordflow">return</span>(NULL);  <span class="comment">/* OutofMemory Error */</span>
00529     }
00530 
00531     <span class="comment">//cout&lt;&lt;" Cmd: "&lt;&lt;str&lt;&lt;endl;</span>
00532     DEBUGSTR(str);
00533 
00534     <span class="keywordflow">if</span> (RWMem.doCmd((<span class="keywordtype">char</span> *)str, retStr))
00535     {
00536         env-&gt;ReleaseStringUTFChars(cmd, str); 
00537         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(retStr.c_str()));         
00538     }
00539     <span class="keywordflow">else</span>
00540     {
00541         env-&gt;ReleaseStringUTFChars(cmd, str); 
00542         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"ERROR"</span>));         
00543     }
00544 }
00545 
00546 <span class="comment">/*</span>
00547 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00548 <span class="comment"> * Method:    CPP_writeBAR1Mem</span>
00549 <span class="comment"> * Signature: (Ljava/lang/String;)Ljava/lang/String;</span>
00550 <span class="comment"> */</span>
00551 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1writeBAR1Mem(JNIEnv *env, jobject obj, jstring cmd)
00552 {
00553     string retStr;
00554     <span class="keyword">const</span> <span class="keywordtype">char</span> *str;
00555 
00556     ENTER();
00557 
00558     MemFormat RWMem(pBAR1, BAR1_SIZE);   <span class="comment">// max range to read</span>
00559 
00560     str = env-&gt;GetStringUTFChars(cmd, NULL);
00561     <span class="keywordflow">if</span> (str == NULL)
00562     {
00563         <span class="keywordflow">return</span>(NULL);  <span class="comment">/* OutofMemory Error */</span>
00564     }
00565 
00566     <span class="comment">//cout&lt;&lt;" Cmd: "&lt;&lt;str&lt;&lt;endl;</span>
00567     DEBUGSTR(str);
00568 
00569     <span class="keywordflow">if</span> (RWMem.doCmd((<span class="keywordtype">char</span> *)str, retStr))
00570     {
00571         env-&gt;ReleaseStringUTFChars(cmd, str); 
00572         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(retStr.c_str()));         
00573     }
00574     <span class="keywordflow">else</span>
00575     {
00576         env-&gt;ReleaseStringUTFChars(cmd, str); 
00577         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"ERROR"</span>));         
00578     }
00579 }
00580 
00581   
00582 
00583 
00584 <span class="comment">/*</span>
00585 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00586 <span class="comment"> * Method:    CPP_readEBRMem</span>
00587 <span class="comment"> * Signature: (Ljava/lang/String;)Ljava/lang/String;</span>
00588 <span class="comment"> */</span>
00589 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1readEBRMem(JNIEnv *env, jobject obj, jstring cmd)
00590 {
00591     string retStr;
00592     <span class="keyword">const</span> <span class="keywordtype">char</span> *str;
00593 
00594     ENTER();
00595 
00596     MemFormat RWMem(pEBR, EBR_SIZE);   <span class="comment">// max range to read</span>
00597 
00598     str = env-&gt;GetStringUTFChars(cmd, NULL);
00599     <span class="keywordflow">if</span> (str == NULL)
00600     {
00601         <span class="keywordflow">return</span>(NULL);  <span class="comment">/* OutofMemory Error */</span>
00602     }
00603 
00604     <span class="comment">//cout&lt;&lt;" Cmd: "&lt;&lt;str&lt;&lt;endl;</span>
00605     DEBUGSTR(str);
00606 
00607     <span class="keywordflow">if</span> (RWMem.doCmd((<span class="keywordtype">char</span> *)str, retStr))
00608     {
00609         env-&gt;ReleaseStringUTFChars(cmd, str); 
00610         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(retStr.c_str()));         
00611     }
00612     <span class="keywordflow">else</span>
00613     {
00614         env-&gt;ReleaseStringUTFChars(cmd, str); 
00615         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"ERROR"</span>));         
00616     }
00617 }
00618 
00619 
00620 <span class="comment">/*</span>
00621 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00622 <span class="comment"> * Method:    CPP_writeEBRMem</span>
00623 <span class="comment"> * Signature: (Ljava/lang/String;)Ljava/lang/String;</span>
00624 <span class="comment"> */</span>
00625 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1writeEBRMem(JNIEnv *env, jobject obj, jstring cmd)
00626 {
00627     string retStr;
00628     <span class="keyword">const</span> <span class="keywordtype">char</span> *str;
00629 
00630     ENTER();
00631 
00632     MemFormat RWMem(pEBR, EBR_SIZE);   <span class="comment">// max range to read</span>
00633 
00634     str = env-&gt;GetStringUTFChars(cmd, NULL);
00635     <span class="keywordflow">if</span> (str == NULL)
00636     {
00637         <span class="keywordflow">return</span>(NULL);  <span class="comment">/* OutofMemory Error */</span>
00638     }
00639 
00640     <span class="comment">//cout&lt;&lt;" Cmd: "&lt;&lt;str&lt;&lt;endl;</span>
00641     DEBUGSTR(str);
00642 
00643     <span class="keywordflow">if</span> (RWMem.doCmd((<span class="keywordtype">char</span> *)str, retStr))
00644     {
00645         env-&gt;ReleaseStringUTFChars(cmd, str); 
00646         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(retStr.c_str()));         
00647     }
00648     <span class="keywordflow">else</span>
00649     {
00650         env-&gt;ReleaseStringUTFChars(cmd, str); 
00651         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"ERROR"</span>));         
00652     }
00653 }
00654 
00655 
00656 <span class="comment">/*</span>
00657 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00658 <span class="comment"> * Method:    CPP_clearEBRMem</span>
00659 <span class="comment"> * Signature: ()Ljava/lang/String;</span>
00660 <span class="comment"> */</span>
00661 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1clearEBRMem(JNIEnv *env, jobject obj)
00662 {
00663     ENTER();
00664 
00665     <span class="keywordflow">if</span> (pEBR-&gt;clear())
00666         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"OK"</span>));
00667     <span class="keywordflow">else</span>
00668         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"ERROR"</span>));         
00669 }
00670 
00671 
00672 <span class="comment">/*</span>
00673 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00674 <span class="comment"> * Method:    CPP_fillEBRMem</span>
00675 <span class="comment"> * Signature: (I)Ljava/lang/String;</span>
00676 <span class="comment"> */</span>
00677 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1fillEBRMem(JNIEnv *env, jobject obj, jint val)
00678 {
00679     ENTER();
00680 
00681     <span class="keywordflow">if</span> (pEBR-&gt;fill((uint8_t)val))
00682         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"OK"</span>));
00683     <span class="keywordflow">else</span>
00684         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"ERROR"</span>));         
00685 }
00686 
00687 
00688 <span class="comment">/*</span>
00689 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00690 <span class="comment"> * Method:    CPP_loadEBRFromFile</span>
00691 <span class="comment"> * Signature: (Ljava/lang/String;)Ljava/lang/String;</span>
00692 <span class="comment"> */</span>
00693 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1loadEBRFromFile(JNIEnv *env, jobject obj, jstring fname)
00694 {
00695     <span class="keyword">const</span> <span class="keywordtype">char</span> *str;
00696 
00697     ENTER();
00698 
00699     str = env-&gt;GetStringUTFChars(fname, NULL);
00700     <span class="keywordflow">if</span> (str == NULL)
00701     {
00702         <span class="keywordflow">return</span>(NULL);  <span class="comment">/* OutofMemory Error */</span>
00703     }
00704 
00705     <span class="comment">//cout&lt;&lt;"Filename: "&lt;&lt;str&lt;&lt;endl;</span>
00706     DEBUGSTR(str);
00707 
00708     <span class="keywordflow">if</span> (pEBR-&gt;loadFromFile((<span class="keywordtype">char</span> *)str))
00709     {
00710         env-&gt;ReleaseStringUTFChars(fname, str); 
00711         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"OK"</span>));         
00712     }
00713     <span class="keywordflow">else</span>
00714     {
00715         env-&gt;ReleaseStringUTFChars(fname, str); 
00716         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"ERROR"</span>));         
00717     }
00718 
00719 }
00720 
00721 
00722 <span class="comment">/*</span>
00723 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00724 <span class="comment"> * Method:    CPP_saveEBRToFile</span>
00725 <span class="comment"> * Signature: (Ljava/lang/String;)Ljava/lang/String;</span>
00726 <span class="comment"> */</span>
00727 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1saveEBRToFile(JNIEnv *env, jobject obj, jstring fname)
00728 {
00729     <span class="keyword">const</span> <span class="keywordtype">char</span> *str;
00730 
00731     ENTER();
00732 
00733     str = env-&gt;GetStringUTFChars(fname, NULL);
00734     <span class="keywordflow">if</span> (str == NULL)
00735     {
00736         <span class="keywordflow">return</span>(NULL);  <span class="comment">/* OutofMemory Error */</span>
00737     }
00738 
00739     <span class="comment">//cout&lt;&lt;" Filename: "&lt;&lt;str&lt;&lt;endl;</span>
00740     DEBUGSTR(str);
00741 
00742     <span class="keywordflow">if</span> (pEBR-&gt;saveToFile((<span class="keywordtype">char</span> *)str))
00743     {
00744         env-&gt;ReleaseStringUTFChars(fname, str); 
00745         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"OK"</span>));         
00746     }
00747     <span class="keywordflow">else</span>
00748     {
00749         env-&gt;ReleaseStringUTFChars(fname, str); 
00750         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"ERROR"</span>));         
00751     }
00752 
00753 }
00754 
00755 
00756 <span class="comment">/*</span>
00757 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00758 <span class="comment"> * Method:    CPP_runLEDTest</span>
00759 <span class="comment"> * Signature: ()Ljava/lang/String;</span>
00760 <span class="comment"> */</span>
00761 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1runLEDTest(JNIEnv *env, jobject obj)
00762 {
00763     ENTER();
00764 
00765     pGPIO-&gt;LED16DisplayTest();
00766     <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"OK"</span>));
00767 }
00768 
00769 
00770 <span class="comment">/*</span>
00771 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00772 <span class="comment"> * Method:    CPP_setLED</span>
00773 <span class="comment"> * Signature: (I)Ljava/lang/String;</span>
00774 <span class="comment"> */</span>
00775 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1setLED(JNIEnv *env, jobject obj, jint val)
00776 {
00777     ENTER();
00778 
00779     pGPIO-&gt;setLED16Display((<span class="keywordtype">char</span>)val);
00780     <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"OK"</span>));
00781 }
00782 
00783 
00784 <span class="comment">/*</span>
00785 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00786 <span class="comment"> * Method:    CPP_runLED16SegTest</span>
00787 <span class="comment"> * Signature: ()Ljava/lang/String;</span>
00788 <span class="comment"> */</span>
00789 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1runLED16SegTest(JNIEnv *env, jobject obj)
00790 {
00791     ENTER();
00792 
00793     pGPIO-&gt;LED16DisplayTest();
00794     <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"OK"</span>));
00795 }
00796 
00797 
00798 <span class="comment">/*</span>
00799 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00800 <span class="comment"> * Method:    CPP_setLED16Seg</span>
00801 <span class="comment"> * Signature: (C)Ljava/lang/String;</span>
00802 <span class="comment"> */</span>
00803 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1setLED16Seg__C(JNIEnv *env, jobject obj, jchar val)
00804 {
00805     ENTER();
00806 
00807     pGPIO-&gt;setLED16Display((<span class="keywordtype">char</span>)val);
00808     <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"OK"</span>));
00809 
00810 }
00811 
00812 
00813 <span class="comment">/*</span>
00814 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00815 <span class="comment"> * Method:    CPP_setLED16Seg</span>
00816 <span class="comment"> * Signature: (I)Ljava/lang/String;</span>
00817 <span class="comment"> */</span>
00818 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1setLED16Seg__I(JNIEnv *env, jobject obj, jint val)
00819 {
00820     ENTER();
00821 
00822     pGPIO-&gt;setLED16Display((<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)val);
00823     <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"OK"</span>));
00824 
00825 }
00826 
00827 
00828 <span class="comment">/*</span>
00829 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00830 <span class="comment"> * Method:    CPP_getLED16Seg</span>
00831 <span class="comment"> * Signature: ()Ljava/lang/String;</span>
00832 <span class="comment"> */</span>
00833 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1getLED16Seg(JNIEnv *env, jobject obj)
00834 {
00835     uint8_t lo, hi;
00836     <span class="keywordtype">char</span> retStr[8];
00837 
00838     ENTER();
00839 
00840     <span class="comment">// The 16 Segment LED display is at registers 8 and 9 in BAR1</span>
00841     lo = pGPIO-&gt;read8(0x08);
00842     hi = pGPIO-&gt;read8(0x09);
00843 
00844     <span class="comment">// Quick in-place conversion from 4 digit hex value to 4 char string</span>
00845     retStr[0] = HexChar[(hi&gt;&gt;4) &amp; 0x0f];
00846     retStr[1] = HexChar[hi &amp; 0x0f];
00847     retStr[2] = HexChar[(lo&gt;&gt;4) &amp; 0x0f];
00848     retStr[3] = HexChar[lo &amp; 0x0f];
00849     retStr[4] = <span class="charliteral">'\0'</span>;
00850     <span class="keywordflow">return</span>(env-&gt;NewStringUTF(retStr));         
00851 }
00852 
00853 
00854 
00855 <span class="comment">/*</span>
00856 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00857 <span class="comment"> * Method:    CPP_getDIPsw</span>
00858 <span class="comment"> * Signature: ()Ljava/lang/String;</span>
00859 <span class="comment"> */</span>
00860 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1getDIPsw(JNIEnv *env, jobject obj)
00861 {
00862     <span class="keywordtype">char</span> retStr[4];
00863     uint8_t val;
00864 
00865     ENTER();
00866 
00867     val = pGPIO-&gt;getDIPsw();
00868     
00869     retStr[0] = HexChar[val&gt;&gt;4];
00870     retStr[1] = HexChar[val &amp; 0x0f];
00871     retStr[2] = <span class="charliteral">'\0'</span>;
00872     <span class="keywordflow">return</span>(env-&gt;NewStringUTF(retStr));         
00873 }
00874 
00875 
00876 <span class="comment">/*</span>
00877 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00878 <span class="comment"> * Method:    CPP_runCounter</span>
00879 <span class="comment"> * Signature: (I)Ljava/lang/String;</span>
00880 <span class="comment"> */</span>
00881 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1runCounter(JNIEnv *env, jobject obj, jint mode)
00882 {
00883     ENTER();
00884 
00885     <span class="keywordflow">if</span> (mode == 1)
00886     {
00887         pGPIO-&gt;runCounter(<span class="keyword">true</span>);
00888         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"OK"</span>));
00889     }
00890     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode == 0)
00891     {
00892         pGPIO-&gt;runCounter(<span class="keyword">false</span>);
00893         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"OK"</span>));
00894     }
00895     <span class="keywordflow">else</span>
00896     {
00897         <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"ERROR"</span>));         
00898     }
00899 }
00900 
00901 
00902 <span class="comment">/*</span>
00903 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00904 <span class="comment"> * Method:    CPP_getCounter</span>
00905 <span class="comment"> * Signature: ()Ljava/lang/String;</span>
00906 <span class="comment"> */</span>
00907 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1getCounter(JNIEnv *env, jobject obj)
00908 {
00909     <span class="keywordtype">char</span> retStr[12];
00910     uint32_t val;
00911 
00912     ENTER();
00913 
00914     val = pGPIO-&gt;getCounter();
00915     
00916     retStr[0] = HexChar[(val&gt;&gt;28) &amp; 0x0f];
00917     retStr[1] = HexChar[(val&gt;&gt;24) &amp; 0x0f];
00918     retStr[2] = HexChar[(val&gt;&gt;20) &amp; 0x0f];
00919     retStr[3] = HexChar[(val&gt;&gt;16) &amp; 0x0f];
00920     retStr[4] = HexChar[(val&gt;&gt;12) &amp; 0x0f];
00921     retStr[5] = HexChar[(val&gt;&gt;8) &amp; 0x0f];
00922     retStr[6] = HexChar[(val&gt;&gt;4) &amp; 0x0f];
00923     retStr[7] = HexChar[val &amp; 0x0f];
00924     retStr[8] = <span class="charliteral">'\0'</span>;
00925     <span class="keywordflow">return</span>(env-&gt;NewStringUTF(retStr));         
00926 }
00927 
00928 
00929 <span class="comment">/*</span>
00930 <span class="comment"> * Class:     com_latticesemi_lpa_apps_pcie_DemoUI</span>
00931 <span class="comment"> * Method:    CPP_setReloadCount</span>
00932 <span class="comment"> * Signature: (I)Ljava/lang/String;</span>
00933 <span class="comment"> */</span>
00934 
00935 JNIEXPORT jstring JNICALL Java_com_latticesemi_lpa_apps_pcie_DemoUI_CPP_1setReloadCount(JNIEnv *env, jobject obj, jint cnt)
00936 {
00937     ENTER();
00938 
00939     pGPIO-&gt;setCounterReload((uint32_t)cnt);
00940     <span class="keywordflow">return</span>(env-&gt;NewStringUTF(<span class="stringliteral">"OK"</span>));
00941 }
00942 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Jul 16 12:05:30 2008 for Lattice PCIe Basic Demo by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
