<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Lattice PCIe API Manual: SFIF.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000001.html">DevObjs</a></div>
<h1>SFIF.cpp</h1><a href="_s_f_i_f_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> *  COPYRIGHT (c) 2008 by Lattice Semiconductor Corporation</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * All rights reserved. All use of this software and documentation is</span>
00005 <span class="comment"> * subject to the License Agreement located in the file LICENSE.</span>
00006 <span class="comment"> */</span>
00007 
00010 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
00011 <span class="preprocessor">#include &lt;iostream&gt;</span>
00012 <span class="preprocessor">#include &lt;string&gt;</span>
00013 <span class="preprocessor">#include &lt;sstream&gt;</span>
00014 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00015 
00016 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00017 
00018 <span class="preprocessor">#include "<a class="code" href="_p_c_ie_a_p_i_8h.html">PCIeAPI.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="_debug_print_8h.html">DebugPrint.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="_s_f_i_f_8h.html">SFIF.h</a>"</span>
00021 <span class="preprocessor">#include "<a class="code" href="_mem_format_8h.html">MemFormat.h</a>"</span>
00022 
00023 <span class="keyword">using</span> <span class="keyword">namespace </span>LatticeSemi_PCIe;
00024 
00025 
<a name="l00030"></a><a class="code" href="_s_f_i_f_8cpp.html#a0">00030</a> <span class="preprocessor">#define TIMESTAMP   0</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#define TIMESTAMP2  1</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#define HEADER0     2</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#define HEADER1     3</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#define HEADER2     4</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#define DATA        5</span>
00036 <span class="preprocessor"></span>
00037 <span class="comment">// TLP Type Definitions</span>
00038 <span class="preprocessor">#define MRD 1</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#define MWR 0</span>
00040 <span class="preprocessor"></span>
00041 <span class="preprocessor">#define SWAP(A) ((A&gt;&gt;24) | ((A&gt;&gt;8) &amp; 0x0000ff00) | ((A&lt;&lt;8) &amp; 0x00ff0000) | (A&lt;&lt;24))</span>
00042 <span class="preprocessor"></span>
00043 
00044 
00045 <span class="keyword">const</span> <span class="keywordtype">char</span> *CplStatusStr[8] = {<span class="stringliteral">"SC"</span>, <span class="stringliteral">"UR"</span>, <span class="stringliteral">"CRS"</span>, <span class="stringliteral">"???"</span>, <span class="stringliteral">"CA"</span>, <span class="stringliteral">"???"</span>, <span class="stringliteral">"???"</span>, <span class="stringliteral">"???"</span>};
00046 
00047 
00048 
<a name="l00063"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a0">00063</a> <a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a0">SFIF::SFIF</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *nameStr, 
00064        uint32_t baseAddr, 
00065        <a class="code" href="class_lattice_semi___p_c_ie_1_1_register_access.html">RegisterAccess</a> *pRA) : LatticeSemi_PCIe::<a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html">Device</a>(pRA, nameStr, baseAddr, MAX_ADDRESS)
00066 {
00067     ENTER();
00068     <span class="comment">/* Base Class Device has setup the name, address, and range already */</span>
00069 
00070     RunTimes = 0;    <span class="comment">// counter for loading uniques patterns into the transfer buffers</span>
00071     
00072     <span class="comment">// Default settings</span>
00073     RlxOrdBit = 1;
00074     SnoopBit = 0;
00075     PoisonedBit = 0;
00076     TrafficClassBits = 0;
00077 
00078 
00079     pDrvr = (<a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_p_c_ie2___i_f.html">LSCPCIe2_IF</a> *)pRA;  <span class="comment">// has to be a driver of type LSCPCIe2 that was passed in</span>
00080     Aligned4k = <span class="keyword">true</span>;
00081     Aligned128 = <span class="keyword">true</span>;
00082 
00083     <span class="keyword">const</span> <a class="code" href="struct_extra_resource_info__t.html">ExtraResourceInfo_t</a> *pExtra;
00084     pDrvr-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_p_c_ie2___i_f.html#a2">getPciDriverExtraInfo</a>(&amp;pExtra);
00085 
00086         <span class="keywordflow">if</span> (pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o6">DmaBufSize</a> &lt; FIFO_SIZE)
00087         {
00088             cout&lt;&lt;<span class="stringliteral">"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n"</span>;
00089             cout&lt;&lt;<span class="stringliteral">"            ERROR\n"</span>;
00090             cout&lt;&lt;<span class="stringliteral">"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n"</span>;
00091             cout&lt;&lt;<span class="stringliteral">"\nDMA Common Buffer smaller than SFIF TX FIFO\n"</span>;
00092             cout&lt;&lt;<span class="stringliteral">"Exiting to avoid possible buffer overflows.\n"</span>;
00093             ERRORSTR(<span class="stringliteral">"DMA Common Buffer &lt; 16KB!\n"</span>);
00094             <span class="keywordflow">throw</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f___error.html">SFIF_Error</a>(<span class="stringliteral">"SFIF: DMA Common Buffer &lt; 16KB"</span>);
00095         }
00096 
00097         <span class="keywordflow">if</span> (pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o9">DmaPhyAddrLo</a> % 4096)
00098         {
00099             cout&lt;&lt;<span class="stringliteral">"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n"</span>;
00100             cout&lt;&lt;<span class="stringliteral">"WARNING!  DMA Common Buffer Base is not 4KB aligned.\n"</span>;
00101             cout&lt;&lt;<span class="stringliteral">"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n"</span>;
00102             cout&lt;&lt;<span class="stringliteral">"\nNo support to handle crossing 4KB address boundary\n"</span>;
00103             Aligned4k = <span class="keyword">false</span>;
00104             ERRORSTR(<span class="stringliteral">"DMA Common Buffer not 4KB aligned!\n"</span>);
00105             <span class="keywordflow">throw</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f___error.html">SFIF_Error</a>(<span class="stringliteral">"SFIF: DMA Common Buffer not 4KB aligned"</span>);
00106         }
00107 
00108         <span class="keywordflow">if</span> (pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o9">DmaPhyAddrLo</a> % 128)
00109         {
00110             cout&lt;&lt;<span class="stringliteral">"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n"</span>;
00111             cout&lt;&lt;<span class="stringliteral">"WARNING!  Base is not 128 aligned.\n"</span>;
00112             cout&lt;&lt;<span class="stringliteral">"Writes need to account for crossing 4k boundary\n"</span>;
00113             cout&lt;&lt;<span class="stringliteral">"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n"</span>;
00114             cout&lt;&lt;<span class="stringliteral">"\nNo support to handle crossing 4kB address boundary\n"</span>;
00115             Aligned128 = <span class="keyword">false</span>;
00116             ERRORSTR(<span class="stringliteral">"DMA Common Buffer not 128 aligned!\n"</span>);
00117             <span class="keywordflow">throw</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f___error.html">SFIF_Error</a>(<span class="stringliteral">"SFIF: DMA Common Buffer not 128 aligned"</span>);
00118         }
00119         <span class="comment">// Build the PCIe TLP requester ID out of PCI Bus/Dev/Func</span>
00120         RequesterID = ((pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o1">busNum</a>)&lt;&lt;24) | ((pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o2">deviceNum</a>)&lt;&lt;19) | ((pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o3">functionNum</a>)&lt;&lt;16);
00121         DmaCommonBufAddr = pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o9">DmaPhyAddrLo</a>;
00122         DmaCommonBufSize = FIFO_SIZE;
00123 
00124     LEAVE();
00125 }
00126 
<a name="l00133"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a1">00133</a> <a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a1">SFIF::~SFIF</a>()
00134 {
00135     ENTER();
00136     
00137 }
00138 
00139 
00140 
<a name="l00145"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a2">00145</a> <span class="keywordtype">void</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a2">SFIF::showRegs</a>(<span class="keywordtype">void</span>)
00146 {
00147         cout&lt;&lt;<span class="stringliteral">"============================\n"</span>;
00148         cout&lt;&lt;<span class="stringliteral">"     SFIF Registers\n"</span>;
00149         cout&lt;&lt;<span class="stringliteral">"============================\n"</span>;
00150         cout&lt;&lt;<span class="stringliteral">"CONTROL: SFIF[0x00] = "</span>&lt;&lt;hex&lt;&lt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(0)&lt;&lt;endl;
00151         cout&lt;&lt;<span class="stringliteral">"TX_TLP_CTRL: SFIF[0x04] = "</span>&lt;&lt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(4)&lt;&lt;endl;
00152         cout&lt;&lt;<span class="stringliteral">"TX_ICG: SFIF[0x08] = "</span>&lt;&lt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(8)&lt;&lt;endl;
00153         cout&lt;&lt;<span class="stringliteral">"TX_DATA: SFIF[0x0c] = "</span>&lt;&lt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(0x0c)&lt;&lt;endl;
00154         cout&lt;&lt;<span class="stringliteral">"RX_DATA: SFIF[0x10] = "</span>&lt;&lt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(0x10)&lt;&lt;endl;
00155         cout&lt;&lt;<span class="stringliteral">"ELAPSED_CNT: SFIF[0x14] = "</span>&lt;&lt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(0x14)&lt;&lt;endl;
00156         cout&lt;&lt;<span class="stringliteral">"TX_TLP_CNT: SFIF[0x18] = "</span>&lt;&lt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(0x18)&lt;&lt;endl;
00157         cout&lt;&lt;<span class="stringliteral">"RX_TLP_CNT: SFIF[0x1C] = "</span>&lt;&lt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(0x1c)&lt;&lt;endl;
00158         cout&lt;&lt;<span class="stringliteral">"CREDIT_WR_PAUSE_CNT: SFIF[0x20] = "</span>&lt;&lt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(0x20)&lt;&lt;endl;
00159         cout&lt;&lt;<span class="stringliteral">"LAST_CPLD_TS: SFIF[0x24] = "</span>&lt;&lt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(0x24)&lt;&lt;endl;
00160         cout&lt;&lt;<span class="stringliteral">"CREDIT_RD_PAUSE_CNT: SFIF[0x28] = "</span>&lt;&lt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(0x28)&lt;&lt;endl;
00161 
00162 }
00163 
00164 
<a name="l00172"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a10">00172</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a10">SFIF::startSFIF</a>(<span class="keywordtype">bool</span> loop)
00173 {
00174     ENTER();
00175 
00176     <span class="comment">// Get the current operating mode</span>
00177     uint32_t mode = <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(SFIF_CTRL);
00178 
00179     <span class="keywordflow">if</span> (loop)
00180         mode = mode | 0x0c;  <span class="comment">// turn on the loop &amp; run bits</span>
00181     <span class="keywordflow">else</span>
00182         mode = mode | 0x04;  <span class="comment">// turn on the run bit</span>
00183 
00184     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_CTRL, mode);   <span class="comment">// take out of reset and start running again</span>
00185 
00186     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00187 }
00188 
00189 
00190 
00191 
00192 
<a name="l00201"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a11">00201</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a11">SFIF::stopSFIF</a>()
00202 {
00203     ENTER();
00204 
00205     uint32_t mode;
00206     mode = <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(SFIF_CTRL);
00207     mode = mode &amp; ~0x0c;  <span class="comment">// shut off the run bit and the loop bit</span>
00208     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_CTRL, mode);
00209 
00210     Sleep(1);  <span class="comment">// wait to make sure its stopped</span>
00211 
00212     ++RunTimes;  <span class="comment">// counter for loading uniques patterns into the transfer buffers</span>
00213 
00214     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00215 }
00216 
00217 
<a name="l00223"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a12">00223</a> <span class="keywordtype">void</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a12">SFIF::disableSFIF</a>()
00224 {
00225     ENTER();
00226 
00227     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_CTRL, 0);  <span class="comment">// disable everything</span>
00228 
00229 }
00230 
00231 
<a name="l00241"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a7">00241</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a7">SFIF::cfgTLP</a>(uint32_t rlxOrd,
00242                     uint32_t snoop,
00243                     uint32_t trafficClass,
00244                     uint32_t poisoned)
00245 {
00246     <span class="keywordflow">if</span> (rlxOrd)
00247         RlxOrdBit = 1;
00248     <span class="keywordflow">else</span>
00249         RlxOrdBit = 0;
00250     <span class="keywordflow">if</span> (snoop)
00251         SnoopBit = 1;
00252     <span class="keywordflow">else</span>
00253         SnoopBit = 0;
00254     <span class="keywordflow">if</span> (poisoned)
00255         PoisonedBit = 1;
00256     <span class="keywordflow">else</span>
00257         PoisonedBit = 0;
00258     TrafficClassBits = trafficClass &amp; 0x07;
00259 
00260     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00261 }
00262 
<a name="l00269"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a4">00269</a> <span class="keywordtype">int</span>  <a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a4">SFIF::getSFIFRegs</a>(<span class="keywordtype">long</span> <span class="keywordtype">long</span> *elements, <span class="keywordtype">int</span> len)
00270 {
00271     ENTER();
00272     elements[0] = <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(SFIF_ELAPSE_CNT);   <span class="comment">// ElapsedTime</span>
00273     elements[1] = <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(SFIF_TXTLP_CNT);    <span class="comment">// TxTLPCnt</span>
00274     elements[2] = <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(SFIF_RXTLP_CNT);    <span class="comment">// RxTLPCnt</span>
00275     elements[3] = <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(SFIF_WRWAIT_CNT);   <span class="comment">// WrWaitTime</span>
00276     elements[4] = <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(SFIF_LAST_CPLD);    <span class="comment">// LastCplDTime</span>
00277     elements[5] = <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(SFIF_RDWAIT_CNT);   <span class="comment">// RdWaitTime</span>
00278     <span class="keywordflow">return</span>(6);
00279 }
00280 
00281 
<a name="l00288"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a5">00288</a> <span class="keywordtype">void</span>  <a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a5">SFIF::getCntrs</a>(SFIFCntrs_t &amp;cnts)
00289 {
00290     ENTER();
00291     cnts.ElapsedTime = <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(SFIF_ELAPSE_CNT);  <span class="comment">// ElapsedTime</span>
00292     cnts.TxTLPCnt = <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(SFIF_TXTLP_CNT);  <span class="comment">// TxTLPCnt</span>
00293     cnts.RxTLPCnt = <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(SFIF_RXTLP_CNT);  <span class="comment">// RxTLPCnt</span>
00294     cnts.WrWaitTime = <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(SFIF_WRWAIT_CNT);   <span class="comment">// WrWaitTime</span>
00295     cnts.LastCplDTime = <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(SFIF_LAST_CPLD);  <span class="comment">// LastCplDTime</span>
00296     cnts.RdWaitTime = <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(SFIF_RDWAIT_CNT);   <span class="comment">// RdWaitTime</span>
00297 }
00298 
00299 
<a name="l00312"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a6">00312</a> uint32_t  <a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a6">SFIF::getRxFIFO</a>(uint32_t *pBuf, size_t len)
00313 {
00314     uint32_t n, i;
00315 
00316     ENTER();
00317 
00318     <span class="keywordflow">if</span> ((len &gt; FIFO_SIZE) || (len == 0))
00319         len = FIFO_SIZE;
00320 
00321     n = 0;  <span class="comment">// number of words read from RX FIFO</span>
00322     <span class="keywordflow">for</span> (i = 0; i &lt; len/4; i++)
00323     {
00324         <span class="keywordflow">if</span> (<a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(SFIF_CTRL) &amp; 0x20)
00325             <span class="keywordflow">break</span>;  <span class="comment">// Rx FIFO is empty now - no more data</span>
00326 
00327         pBuf[i] =  <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(SFIF_RXTLP_DATA);
00328         ++n;
00329 
00330     }
00331 
00332 
00333     <span class="keywordflow">return</span>(n * 4);   <span class="comment">// number of bytes read, even though its always DWORDs</span>
00334 
00335 }
00336 
00337 
<a name="l00353"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a9">00353</a> <span class="keywordtype">bool</span>  <a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a9">SFIF::verifyMWrXfer</a>(uint32_t *pUserBuf, size_t len)
00354 {
00355     uint32_t i;
00356     uint32_t errs = 0;
00357 
00358     ENTER();
00359 
00360     <span class="keywordflow">if</span> ((len &gt; FIFO_SIZE) || (len == 0))
00361         len = this-&gt;TxSaveLen;
00362 
00363     len = len / 4;
00364     <span class="keywordflow">for</span> (i = 0; i &lt; len; i++)
00365     {
00366         <span class="keywordflow">if</span> (pUserBuf[i] != this-&gt;TxSaveBuf[i])
00367         {
00368             cout&lt;&lt;<span class="stringliteral">"ERROR!  DMA MWr xfer error @ addr: "</span>&lt;&lt;i;
00369             cout&lt;&lt;<span class="stringliteral">"\t"</span>&lt;&lt;hex&lt;&lt;TxSaveBuf[i]&lt;&lt;<span class="stringliteral">" != "</span>;
00370             cout&lt;&lt;pUserBuf[i]&lt;&lt;dec&lt;&lt;endl;
00371             ++errs;
00372         }
00373     }
00374 
00375     
00376     <span class="keywordflow">if</span> (errs)
00377         <span class="keywordflow">return</span>(<span class="keyword">false</span>);
00378     <span class="keywordflow">else</span>
00379         <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00380 
00381 }
00382 
00383 
00384 
<a name="l00393"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a3">00393</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a3">SFIF::getSFIFParseRxFIFO</a>(string &amp;outs)
00394 {
00395     uint32_t i, j;
00396     uint32_t n, tag;
00397     uint32_t len;
00398     uint32_t numDWs;
00399     uint32_t nDwRcvd, rx_time, ts;
00400     <span class="keywordtype">int</span> state;
00401     uint32_t data;
00402     <span class="keywordtype">double</span>   thruput;
00403     <span class="keywordtype">bool</span> status = <span class="keyword">true</span>;
00404 
00405 
00406     <span class="comment">// initialize to avoid compiler warnings</span>
00407     tag = 0;
00408     len = 0;
00409     numDWs = 0;
00410     rx_time = 0;
00411     ts = 0;
00412     std::ostringstream oss;
00413 
00414     ENTER();
00415 
00416     n = 0;  <span class="comment">// number of words read from RX FIFO</span>
00417     <span class="keywordflow">for</span> (i = 0; i &lt; FIFO_SIZE/4; i++)
00418     {
00419         <span class="keywordflow">if</span> (<a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(SFIF_CTRL) &amp; 0x20)
00420             <span class="keywordflow">break</span>;  <span class="comment">// Rx FIFO is empty now - no more data</span>
00421 
00422         RxFIFO[i] =  <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a7">read32</a>(SFIF_RXTLP_DATA);
00423         ++n;
00424 
00425     }
00426 
00427 
00428     <span class="comment">// if the RX FIFO contains all the CplD's then parse and use the time stamps</span>
00429     <span class="comment">// otherwise return the raw contents and false.  </span>
00430     <span class="keywordflow">if</span> (this-&gt;RxFifoValid)
00431     {
00432         <span class="comment">// Clear the RX Bins for processing split transactions out of FIFO</span>
00433         memset(RxCpl, 0, <span class="keyword">sizeof</span>(RxCpl));
00434 
00435         oss&lt;&lt;<span class="stringliteral">"Parsing Received CplDs\n"</span>;
00436 
00437         j = 0;
00438         nDwRcvd = 0;
00439         state = TIMESTAMP;
00440         oss&lt;&lt;hex;
00441         <span class="keywordflow">for</span> (i = 1; i &lt; n; i++)
00442         {
00443             <span class="keywordflow">switch</span> (state)
00444             {
00445                 <span class="keywordflow">case</span> <a class="code" href="_s_f_i_f_8cpp.html#a0">TIMESTAMP</a>:
00446                     <span class="keywordflow">if</span> (RxFIFO[i] &gt; 0)
00447                     {
00448                         ts = RxFIFO[i];
00449                         state = TIMESTAMP2;
00450                     }
00451                     <span class="keywordflow">break</span>;
00452 
00453                 <span class="keywordflow">case</span> TIMESTAMP2:
00454                     <span class="keywordflow">if</span> (ts == RxFIFO[i])
00455                     {
00456                         oss&lt;&lt;<span class="stringliteral">"\n\nTLP["</span>&lt;&lt;j&lt;&lt;<span class="stringliteral">"] Time = 0x"</span>&lt;&lt;ts&lt;&lt;endl;
00457                         state = HEADER0;
00458                     }
00459                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RxFIFO[i] == 0)
00460                     {
00461                         state = TIMESTAMP;
00462                     }
00463                     <span class="keywordflow">else</span>
00464                     {
00465                         state = TIMESTAMP2;
00466                         ts = RxFIFO[i];
00467                     }
00468                     <span class="keywordflow">break</span>;
00469 
00470                 <span class="keywordflow">case</span> HEADER0:
00471                     <span class="keywordflow">if</span> ((RxFIFO[i] &amp; 0x4a000000) == 0x4a000000)
00472                     {
00473                         numDWs = RxFIFO[i] &amp; 0x3ff;
00474                         state = HEADER1;
00475                         oss&lt;&lt;<span class="stringliteral">"\tLen=0x"</span>&lt;&lt;numDWs&lt;&lt;<span class="stringliteral">" DWs\n"</span>;
00476                         ++j;
00477                     }
00478                     <span class="keywordflow">else</span>
00479                     {
00480                         oss&lt;&lt;<span class="stringliteral">"PARSE ERROR!  Expected CplD HDR[0]\n"</span>;
00481                         state = TIMESTAMP;
00482                     }
00483                     <span class="keywordflow">break</span>;
00484 
00485                 <span class="keywordflow">case</span> HEADER1:
00486                     <span class="keywordflow">if</span> ((RxFIFO[i] &amp; 0xffff0000) != 0)
00487                         oss&lt;&lt;<span class="stringliteral">"WARNING: expected CplID=0/0/0\n"</span>;
00488                     len = (RxFIFO[i] &amp; 0x0fff);
00489                     oss&lt;&lt;<span class="stringliteral">"\tByteCount=0x"</span>&lt;&lt;len;
00490                     <span class="keywordflow">if</span> (RxFIFO[i] &amp; 0x1000)
00491                         oss&lt;&lt;<span class="stringliteral">"  BCM=1"</span>;
00492                     oss&lt;&lt;<span class="stringliteral">"   Status: "</span>&lt;&lt;((RxFIFO[i]&gt;&gt;12) &amp; 0x07)&lt;&lt;<span class="stringliteral">" ("</span>&lt;&lt;CplStatusStr[(RxFIFO[i]&gt;&gt;12) &amp; 0x07]&lt;&lt;<span class="stringliteral">")\n"</span>;
00493                     state = HEADER2;
00494                     <span class="keywordflow">break</span>;
00495 
00496                 <span class="keywordflow">case</span> HEADER2:
00497                     <span class="keywordflow">if</span> ((RxFIFO[i] &amp; 0xffff0000) != RequesterID)
00498                         oss&lt;&lt;<span class="stringliteral">"ERROR: Not Our Cpl! Expected req_ID="</span>&lt;&lt;RequesterID&lt;&lt;endl;
00499                     tag = ((RxFIFO[i] &amp; 0xff00)&gt;&gt;8) &amp; 0x1f;   <span class="comment">// force 5 bit tag</span>
00500                     oss&lt;&lt;<span class="stringliteral">"\ttag="</span>&lt;&lt;tag;
00501                     oss&lt;&lt;<span class="stringliteral">"   lowAddr="</span>&lt;&lt;(RxFIFO[i] &amp; 0x7f)&lt;&lt;endl;
00502                     state = DATA;
00503                     rx_time = ts;
00504                     <span class="keywordflow">break</span>;
00505 
00506                 <span class="keywordflow">case</span> DATA:
00507                     <span class="keywordflow">if</span> (len == this-&gt;ReadReqSize)
00508                     {
00509                         <span class="comment">// First packet of what could be multiples to fulfill entire read request</span>
00510                         RxCpl[tag].index = 0;
00511                         RxCpl[tag].size = this-&gt;ReadReqSize;
00512                     }
00513                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len &gt; this-&gt;ReadReqSize)
00514                     {
00515                         oss&lt;&lt;<span class="stringliteral">"PARSE ERROR!  Going back to find TIMESTAMP.\n"</span>;
00516                         state = TIMESTAMP;
00517                         <span class="keywordflow">break</span>;
00518                     }
00519 
00520                     data = SWAP(RxFIFO[i]);
00521                     oss&lt;&lt;<span class="stringliteral">"\tDATA["</span>&lt;&lt;RxCpl[tag].index&lt;&lt;<span class="stringliteral">"]: "</span>&lt;&lt;hex&lt;&lt;data&lt;&lt;endl;
00522                     RxCpl[tag].buf[RxCpl[tag].index] = data;
00523                     ++RxCpl[tag].index;
00524                     ++nDwRcvd;  <span class="comment">// total data DWords read from the RX FIFO (for thruput computation)</span>
00525                     RxCpl[tag].size = RxCpl[tag].size - 4;   <span class="comment">// processed one more DW of payload</span>
00526                     --numDWs;  <span class="comment">// processed 1 more DW from this TLP</span>
00527                     --len;
00528                     <span class="keywordflow">if</span> ((numDWs == 0) || (RxCpl[tag].size == 0))
00529                         state = TIMESTAMP;
00530                     <span class="keywordflow">break</span>;
00531             }
00532 
00533         }
00534 
00535         <span class="keywordflow">if</span> (this-&gt;TotalBytesReq != nDwRcvd * 4)
00536             oss&lt;&lt;<span class="stringliteral">"\n\nERROR! asked for "</span>&lt;&lt;dec&lt;&lt;this-&gt;TotalBytesReq&lt;&lt;<span class="stringliteral">" bytes, but got "</span>&lt;&lt;(nDwRcvd * 4)&lt;&lt;endl;
00537 
00538 
00539         <span class="comment">// The recvd data (read completions) can now be compared to the transmit pattern in the System DMA buffer</span>
00540         <span class="comment">// If more than 1 cycle was specified, the Rx FIFO has multiple copies of the recvd data, but this parser</span>
00541         <span class="comment">// will only keep the last cycle - each cycle overwrites previous cycle's data.</span>
00542         <span class="comment">// No checking to verify that each read cycle was received correctly.</span>
00543         <span class="comment">//</span>
00544         oss&lt;&lt;<span class="stringliteral">"\nVerifying Received Data\n"</span>;
00545         n = 0;
00546         <span class="keywordtype">bool</span> err = <span class="keyword">false</span>;
00547         <span class="keywordflow">for</span> (i = 0; i &lt; 32; i++)
00548         {
00549             <span class="keywordflow">if</span> (RxCpl[i].index &gt; 0)
00550             {
00551                 <span class="keywordflow">for</span> (j = 0; j &lt; RxCpl[i].index; j++)
00552                 {
00553                     <span class="keywordflow">if</span> (RxCpl[i].buf[j] != WriteDmaBuf[n])
00554                     {
00555                         err = <span class="keyword">true</span>;
00556                         <span class="keywordflow">break</span>;
00557                     }
00558                     ++n;
00559                 }
00560                 <span class="keywordflow">if</span> (!err)
00561                     oss&lt;&lt;<span class="stringliteral">"ReadReq["</span>&lt;&lt;i&lt;&lt;<span class="stringliteral">"]: OK\n"</span>;
00562                 <span class="keywordflow">else</span>
00563                     oss&lt;&lt;<span class="stringliteral">"ReadReq["</span>&lt;&lt;i&lt;&lt;<span class="stringliteral">"]: ERROR!  Read Data != WriteDma @ "</span>&lt;&lt;i&lt;&lt;endl;
00564             }
00565         }
00566         thruput = ((nDwRcvd * 4) / (8E-9 * rx_time)) / 1E6;
00567 
00568         oss&lt;&lt;<span class="stringliteral">"\nRead: "</span>&lt;&lt;dec&lt;&lt;(nDwRcvd * 4)&lt;&lt;<span class="stringliteral">" bytes   ElpsTime: "</span>&lt;&lt;rx_time&lt;&lt;<span class="stringliteral">" clks   Thruput: "</span>&lt;&lt;thruput&lt;&lt;<span class="stringliteral">" MB/s\n"</span>;
00569 
00570         outs = oss.str();
00571     }
00572     <span class="keywordflow">else</span>
00573     {
00574 
00575         <span class="comment">// Just display the contents since its probably not going to match anything in the PC buffer</span>
00576         <span class="comment">// cause its looped so many times.</span>
00577         outs.append(<span class="stringliteral">"Raw Data Display (CplDs overflowed FIFO)\n"</span>);
00578         <a class="code" href="class_lattice_semi___p_c_ie_1_1_mem_format.html#e2">MemFormat::formatBlockOfWords</a>(outs, 0x0000, n, RxFIFO);
00579 
00580         status = <span class="keyword">false</span>;   <span class="comment">// Let user know that parsing did not happen. Just the raw contents are returned.</span>
00581     }
00582 
00583     LEAVE();
00584 
00585     <span class="keywordflow">return</span>(status);
00586 }
00587 
00588 
00589 
<a name="l00628"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a8">00628</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f.html#a8">SFIF::setupSFIF</a>(uint32_t runMode, 
00629                      uint32_t trafficMode,
00630                      uint32_t cycles, 
00631                      uint32_t ICG, 
00632                      uint32_t rdTLPSize, 
00633                      uint32_t wrTLPSize, 
00634                      uint32_t numRdTLPs, 
00635                      uint32_t numWrTLPs,
00636                      uint32_t pktRdRatio,
00637                      uint32_t pktWrRatio)
00638 {
00639     uint32_t i;
00640     uint32_t n, nPkts;
00641     uint32_t payloadSize, readReqSize, totalBytesReq;
00642     uint32_t rdNumDWs, wrNumDWs;
00643     uint32_t pattern;
00644     uint32_t wrAddr, rdAddr;
00645     uint32_t payload[MAX_TLP_SIZE / 4];
00646     uint32_t tag;
00647 <span class="comment">//  uint32_t pktRdRatio = 4;</span>
00648 <span class="comment">//  uint32_t pktWrRatio = 1;</span>
00649 
00650     ENTER();
00651 
00652     <span class="keywordflow">if</span> (cycles &lt; 1)
00653         cycles = 1;
00654     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cycles &gt; 0xffff)
00655         cycles = 0xffff;
00656 
00657 
00658     DEBUGSTR(<span class="stringliteral">"Reset FIFOs\n"</span>);
00659     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_CTRL, 0x41);  <span class="comment">// turn on enable</span>
00660     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_CTRL, 0x43);  <span class="comment">// assert RESET</span>
00661     <span class="keywordflow">if</span> (runMode == THRUPUT_MODE)
00662         <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_CTRL, (cycles&lt;&lt;16) | 0x49);  <span class="comment">// de-assert RESET, filter RX pkts, loop forever, leave enable on</span>
00663     <span class="keywordflow">else</span>
00664         <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_CTRL, (cycles&lt;&lt;16) | 0x41);  <span class="comment">// de-assert RESET, leave enable on and filter RX pkts</span>
00665 
00666     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXICG_CTRL, ICG);  <span class="comment">//  clocks between TLPs</span>
00667 
00668 
00669     readReqSize = 0;
00670     totalBytesReq = 0;
00671 
00672 
00673 
00674     <span class="keywordflow">if</span> (trafficMode == MWR_TLPS)
00675     {
00676         DEBUGSTR(<span class="stringliteral">"Load: MWr\n"</span>);
00677         nPkts = numWrTLPs;
00678         wrAddr = 0;
00679         wrNumDWs = wrTLPSize / 4;
00680         payloadSize = wrTLPSize;
00681 
00682         DEBUGSTR(<span class="stringliteral">"Clear DMA common buffer\n"</span>);
00683         memset(WriteDmaBuf, 0, <span class="keyword">sizeof</span>(WriteDmaBuf));
00684         pDrvr-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_p_c_ie2___i_f.html#a4">writeSysDmaBuf</a>(WriteDmaBuf, <span class="keyword">sizeof</span>(WriteDmaBuf));
00685 
00686         this-&gt;TxSaveLen = 0;
00687         this-&gt;TxSavePtr = TxSaveBuf;
00688 
00689         DEBUGSTR(<span class="stringliteral">"Load TX FIFO data\n"</span>); 
00690         <span class="comment">// pattern=&lt;pkt#[31:24]&gt;&lt;RunTimes[23:16]&gt;&lt;word#[15:0]&gt;</span>
00691         <span class="keywordflow">for</span> (n = 0; n &lt; nPkts; n++)
00692         {
00693 
00694             pattern = ((n+1)&lt;&lt;24) | (RunTimes&lt;&lt;16);
00695             <span class="keywordflow">for</span> (i = 0; i &lt; wrNumDWs; ++i)
00696                 payload[i] = pattern | (i&lt;&lt;8) | i;
00697 
00698             loadMWrTLP(wrNumDWs, payload, wrAddr);
00699 
00700             <span class="comment">// Keep a copy of what was loaded into the Tx FIFO for comparison later</span>
00701             <span class="keywordflow">if</span> (this-&gt;TxSaveLen &lt; <span class="keyword">sizeof</span>(this-&gt;TxSaveBuf))
00702             {
00703                 memcpy(this-&gt;TxSavePtr, payload, wrNumDWs * 4);
00704                 this-&gt;TxSavePtr = this-&gt;TxSavePtr + wrNumDWs;
00705                 this-&gt;TxSaveLen = this-&gt;TxSaveLen + wrNumDWs * 4;
00706             }
00707 
00708             wrAddr = wrAddr + payloadSize;
00709         }
00710     }
00711     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (trafficMode == MRD_TLPS)
00712     {
00713         DEBUGSTR(<span class="stringliteral">"Load: MRd\n"</span>);
00714         nPkts = numRdTLPs;
00715         rdAddr = 0;
00716         rdNumDWs = rdTLPSize / 4;
00717         readReqSize = rdTLPSize;
00718 
00719         totalBytesReq = readReqSize * nPkts * cycles;
00720 
00721         <span class="comment">// Fill Common DMA buffer with pattern to read for verification in SFIF RX FIFO</span>
00722         <span class="comment">// Pattern = &lt;pkt#[31:24]&gt;&lt;tag[24:16]&gt;&lt;word#[15:8][7:8]&gt;</span>
00723         <span class="keywordflow">for</span> (n = 0; n &lt; nPkts; n++)
00724         {
00725             pattern = ((n+1)&lt;&lt;24);
00726             <span class="keywordflow">for</span> (i = 0; i &lt; rdNumDWs; i++)
00727                 WriteDmaBuf[n * rdNumDWs + i] = pattern | ((n%32)&lt;&lt;16) | (i&lt;&lt;8) | i;
00728         }
00729 
00730         DEBUGPRINT((<span class="stringliteral">"Fill DMA common buffer with %d bytes\n"</span>, totalBytesReq));
00731         pDrvr-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_p_c_ie2___i_f.html#a4">writeSysDmaBuf</a>(WriteDmaBuf, readReqSize * nPkts);
00732 
00733         DEBUGSTR(<span class="stringliteral">"Load TX_FIFO with READ TLPs\n"</span>);
00734         tag = 0;
00735         <span class="keywordflow">for</span> (n = 0; n &lt; nPkts; n++)
00736         {
00737             loadMRdTLP(rdNumDWs, rdAddr, tag);
00738 
00739             tag = ((tag + 1) &amp; 0x1f);
00740             rdAddr = rdAddr + readReqSize;
00741         }
00742 
00743     }
00744     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((trafficMode == MRD_MWR_TLPS) || (trafficMode == MRD_MWR_CTRL_TLPS))
00745     {
00746         DEBUGSTR(<span class="stringliteral">"Load: MWr+MRd\n"</span>);
00747         <span class="comment">// nPkts is assumed to be 4 until we resolve whatever causes some system hang-ups</span>
00748         nPkts = numWrTLPs;
00749         rdNumDWs = rdTLPSize / 4;
00750         wrNumDWs = wrTLPSize / 4;
00751         readReqSize = rdTLPSize;
00752         rdAddr = FIFO_SIZE / 2;   <span class="comment">// read from middle of buffer</span>
00753         wrAddr = 0;  <span class="comment">// write to beginning of buffer</span>
00754         tag = 1;  <span class="comment">// tag 0 is reserved for writes so don't use it </span>
00755 
00756         this-&gt;TxSaveLen = 0;
00757         this-&gt;TxSavePtr = TxSaveBuf;
00758 
00759         DEBUGSTR(<span class="stringliteral">"Clear DMA common buffer\n"</span>);
00760         memset(WriteDmaBuf, 0, <span class="keyword">sizeof</span>(WriteDmaBuf));
00761         <span class="comment">// Pattern = &lt;pkt#[31:24]&gt;&lt;tag[24:16]&gt;&lt;word#[15:8][7:8]&gt;</span>
00762         uint32_t nRdReq = nPkts / pktRdRatio;
00763         <span class="keywordflow">for</span> (n = 0; n &lt; nRdReq; n++)
00764         {
00765             pattern = ((n+1)&lt;&lt;24);
00766             <span class="keywordflow">for</span> (i = 0; i &lt; rdNumDWs; i++)
00767                 WriteDmaBuf[rdAddr/4 + (n * rdNumDWs + i)] = pattern | ((n%32)&lt;&lt;16) | (i&lt;&lt;8) | i;
00768         }
00769 
00770         DEBUGSTR(<span class="stringliteral">"Fill DMA common buffer with read pattern.\n"</span>);
00771         pDrvr-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_p_c_ie2___i_f.html#a4">writeSysDmaBuf</a>(WriteDmaBuf, rdAddr + rdNumDWs*4*nRdReq);
00772 
00773 
00774         <span class="keywordflow">for</span> (n = 0; n &lt; nPkts; n++)
00775         {
00776             <span class="comment">// Load the read request</span>
00777             <span class="keywordflow">if</span> ((n % pktRdRatio) == 0)
00778             {
00779                 DEBUGPRINT((<span class="stringliteral">"--&gt;MRdTLP: tag=%d\n"</span>, tag));
00780                 loadMRdTLP(rdNumDWs, rdAddr, tag);
00781 
00782                 ++tag;
00783                 <span class="keywordflow">if</span> (tag &gt;= 32)
00784                     tag = 1;   <span class="comment">// can't use tag 0 cause its used for writes</span>
00785                 rdAddr = rdAddr + readReqSize;
00786                 <span class="keywordflow">if</span> (rdAddr &gt;= FIFO_SIZE)
00787                     rdAddr = FIFO_SIZE / 2;   <span class="comment">// wrap back to middle of memory buffer</span>
00788             }
00789 
00790             <span class="keywordflow">if</span> ((n % pktWrRatio) == 0)
00791             {
00792                 DEBUGSTR(<span class="stringliteral">"--&gt;MWrTLP\n"</span>);
00793                 pattern = ((n+1)&lt;&lt;24) | (wrNumDWs&lt;&lt;16);
00794                 <span class="keywordflow">for</span> (i = 0; i &lt; wrNumDWs; ++i)
00795                     payload[i] = pattern | (i&lt;&lt;8) | i;
00796 
00797                 loadMWrTLP(wrNumDWs, payload, wrAddr);
00798 
00799                 <span class="comment">// Keep a copy of what was loaded into the Tx FIFO for comparison later</span>
00800                 <span class="keywordflow">if</span> (this-&gt;TxSaveLen &lt; <span class="keyword">sizeof</span>(this-&gt;TxSaveBuf))
00801                 {
00802                     memcpy(this-&gt;TxSavePtr, payload, wrNumDWs * 4);
00803                     this-&gt;TxSavePtr = this-&gt;TxSavePtr + wrNumDWs;
00804                     this-&gt;TxSaveLen = this-&gt;TxSaveLen + wrNumDWs * 4;
00805                 }
00806 
00807                 wrAddr = wrAddr + wrTLPSize;
00808                 <span class="keywordflow">if</span> (wrAddr &gt;= (FIFO_SIZE / 2))
00809                     wrAddr = 0;   <span class="comment">// wrap back to start of memory buffer</span>
00810             }
00811         }
00812 
00813     }
00814     <span class="keywordflow">else</span>
00815         <span class="keywordflow">return</span>(<span class="keyword">false</span>);  <span class="comment">// illegal traffic type</span>
00816 
00817 
00818     ReadReqSize = readReqSize;
00819     TotalBytesReq = totalBytesReq;
00820 
00821     <span class="keywordflow">if</span> (trafficMode == MRD_TLPS)
00822     {
00823         <span class="keywordflow">if</span> ((ReadReqSize &gt; 0) &amp;&amp; (TotalBytesReq &lt; (FIFO_SIZE - 2048)))   <span class="comment">// overhead of CplDs &amp; time cnts</span>
00824             RxFifoValid = <span class="keyword">true</span>;
00825         <span class="keywordflow">else</span>
00826             RxFifoValid = <span class="keyword">false</span>;
00827     }
00828     <span class="keywordflow">else</span>
00829     {
00830         RxFifoValid = <span class="keyword">false</span>;  <span class="comment">// Don't parse SFIF Rx FIFO for MWr or MRd+MWr thruput tests</span>
00831     }
00832 
00833     LEAVE();
00834 
00835     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00836 }
00837 
00838 
00850 <span class="keywordtype">bool</span>    SFIF::loadMWrTLP(uint32_t numDWs, uint32_t *payload, uint32_t wrAddr)
00851 {
00852     uint32_t credits;
00853     uint32_t i;
00854 
00855     ENTER();
00856     <span class="comment">// check address range of writes</span>
00857     <span class="keywordflow">if</span> ((wrAddr + (numDWs * 4) - 1) &gt;= DmaCommonBufSize)
00858     {
00859         ERRORSTR(<span class="stringliteral">"\nERROR!!! loadMWrTLP addr range error!"</span>);
00860         <span class="keywordflow">throw</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f___error.html">SFIF_Error</a>(<span class="stringliteral">"loadMWrTLP addr range error!"</span>);
00861         <span class="keywordflow">return</span>(<span class="keyword">false</span>);
00862     }
00863 
00864     <span class="comment">// turn wrAddr into the actual physical memory address</span>
00865     wrAddr = wrAddr + DmaCommonBufAddr;
00866 
00867     <span class="comment">// 1 credit = 4 DWs</span>
00868     credits = numDWs / 4;
00869     <span class="keywordflow">if</span> (numDWs % 4)
00870         ++credits;
00871 
00872     <span class="comment">// Write credit control word twice to clock into credit FIFO</span>
00873     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_CTRL, 0x8010 | (credits&lt;&lt;5));     <span class="comment">// Ctrl word, Posted credits: hdr &amp; data</span>
00874     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_DATA, 0);        <span class="comment">// dummy writes to clock in control and credits</span>
00875     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_CTRL, 0x8010 | (credits&lt;&lt;5));     <span class="comment">// Ctrl word, Posted credits: hdr &amp; data</span>
00876     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_DATA, 0);
00877 
00878     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_CTRL, 0x0001);    <span class="comment">// data word, start</span>
00879     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_DATA, 0x40000000   <span class="comment">// HDR0: MemWr, 3DW Hdr w/ payload</span>
00880                   |  (TrafficClassBits&lt;&lt;20)
00881                   |  (PoisonedBit&lt;&lt;14)
00882                   |  (RlxOrdBit&lt;&lt;13)
00883                   |  (SnoopBit&lt;&lt;12)
00884                   |  numDWs);  <span class="comment">// payload size in DWs</span>
00885     <span class="keywordflow">if</span> (numDWs == 1)
00886         <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_DATA, RequesterID | 0x0000000f);   <span class="comment">// HDR1: tag=0, 1st_BE = full, no last_BE</span>
00887     <span class="keywordflow">else</span>
00888         <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_DATA, RequesterID | 0x000000ff);   <span class="comment">// HDR1: tag=0, 1st_BE, last_BE</span>
00889 
00890 
00891     <span class="keywordflow">if</span> (numDWs == 1)
00892     {
00893         <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_CTRL, 0x0002);    <span class="comment">// data word, end, full 64 bit</span>
00894         <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_DATA, (wrAddr &amp; 0xfffffffc));     <span class="comment">// HDR[2]=addr,  2 lsb's must be 0</span>
00895         <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_CTRL, 0x0002);    <span class="comment">// data word, end</span>
00896         <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_DATA, SWAP(payload[0]));  <span class="comment">// first DW</span>
00897     }
00898     <span class="keywordflow">else</span>
00899     {
00900         <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_CTRL, 0x0000);    <span class="comment">// data word</span>
00901         <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_DATA, (wrAddr &amp; 0xfffffffc));     <span class="comment">// HDR[2]=addr,  2 lsb's must be 0</span>
00902 
00903         <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_DATA, SWAP(payload[0]));  <span class="comment">// first DW</span>
00904 
00905         <span class="keywordflow">for</span> (i = 1; i &lt; numDWs - 1; ++i)
00906         {
00907             <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_CTRL, 0x0000);    <span class="comment">// data word</span>
00908             <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_DATA, SWAP(payload[i]));
00909         }
00910 
00911         <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_CTRL, 0x000a);    <span class="comment">// last data word, end, DWEN</span>
00912         <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_DATA, SWAP(payload[numDWs - 1]));
00913         <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_CTRL, 0x000a);    <span class="comment">// data word, end, DWEN</span>
00914         <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_DATA, 0);    <span class="comment">// junk word to fill out 64 bit FIFO word</span>
00915     }
00916 
00917     LEAVE();
00918 
00919     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00920 }
00921 
00922 
00934 <span class="keywordtype">bool</span>    SFIF::loadMRdTLP(uint32_t numDWs, uint32_t rdAddr, uint32_t tag)
00935 {
00936     uint32_t cplds;
00937 
00938     ENTER();
00939     <span class="comment">// check address range of read request</span>
00940     <span class="keywordflow">if</span> ((rdAddr + ((numDWs * 4) - 1)) &gt;= DmaCommonBufSize)
00941     {
00942         ERRORSTR(<span class="stringliteral">"\nERROR!!! loadMRdTLP addr range error!"</span>);
00943         <span class="keywordflow">throw</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f___error.html">SFIF_Error</a>(<span class="stringliteral">"loadMRdTLP addr range error!"</span>);
00944         <span class="keywordflow">return</span>(<span class="keyword">false</span>);
00945     }
00946 
00947     <span class="comment">// Turn rdAddr into the actual physical memory address</span>
00948     rdAddr = rdAddr + DmaCommonBufAddr;
00949 
00950     <span class="keywordflow">if</span> ((numDWs % RCB_DW) == 0)
00951         cplds = numDWs / RCB_DW;
00952     <span class="keywordflow">else</span>
00953         cplds = numDWs / RCB_DW + 1;   <span class="comment">// expect one extra back with partial data</span>
00954     <span class="keywordflow">if</span> (cplds &gt; 15)
00955     {
00956         ERRORSTR(<span class="stringliteral">"RANGE ERROR!!! Number of expected CplDs &gt; 15!  Won't fit in SFIF field!\n"</span>);
00957         <span class="keywordflow">throw</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_s_f_i_f___error.html">SFIF_Error</a>(<span class="stringliteral">"loadMRdTLP: CplDs RANGE ERROR"</span>);
00958     }
00959 
00960     <span class="comment">// Write credit control word twice to clock into credit FIFO</span>
00961     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_CTRL, (tag&lt;&lt;21) | (cplds&lt;&lt;17) | (MRD&lt;&lt;16) | 0x8200); <span class="comment">// Ctrl word, 1 credit NonPosted Read Header</span>
00962     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_DATA, 0);        <span class="comment">// dummy writes to clock in control and credits</span>
00963     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_CTRL, (tag&lt;&lt;21) | (cplds&lt;&lt;17) | (MRD&lt;&lt;16) | 0x8200); <span class="comment">// Ctrl word, 1 credit NonPosted Read Header</span>
00964     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_DATA, 0);
00965 
00966     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_CTRL, 0x0001);    <span class="comment">// data word, start</span>
00967     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_DATA, 0x00000000   <span class="comment">// HDR0: MRd, 3DW Hdr w/ payload</span>
00968                   |  (TrafficClassBits&lt;&lt;20)
00969                   |  (PoisonedBit&lt;&lt;14)
00970                   |  (RlxOrdBit&lt;&lt;13)
00971                   |  (SnoopBit&lt;&lt;12)
00972                   |  numDWs);  <span class="comment">// read request size in DWs</span>
00973     <span class="keywordflow">if</span> (numDWs == 1)
00974         <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_DATA, RequesterID | 0x0000000f | (tag&lt;&lt;8));  <span class="comment">// HDR1: tag, 1st_BE = full, no last_BE</span>
00975     <span class="keywordflow">else</span>
00976         <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_DATA, RequesterID | 0x000000ff | (tag&lt;&lt;8));  <span class="comment">// HDR1: tag, 1st_BE, last_BE</span>
00977 
00978     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_CTRL, 0x000a);    <span class="comment">// data word, end, dwen</span>
00979     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_DATA, (rdAddr &amp; 0xfffffffc));     <span class="comment">// HDR[2]=addr,  2 lsb's must be 0</span>
00980     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_CTRL, 0x000a);    <span class="comment">// data word, end, dwen</span>
00981     <a class="code" href="class_lattice_semi___p_c_ie_1_1_device.html#a8">write32</a>(SFIF_TXTLP_DATA, 0);     <span class="comment">// junk word to fill out 64 bit FIFO word</span>
00982 
00983     LEAVE();
00984 
00985     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00986 
00987 }
00988 
00989 
00990 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Jul 16 12:05:26 2008 for Lattice PCIe API Manual by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
