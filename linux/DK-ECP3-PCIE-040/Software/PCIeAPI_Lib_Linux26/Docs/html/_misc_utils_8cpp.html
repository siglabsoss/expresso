<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Lattice PCIe API Manual: MiscUtils.cpp File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">Utils</a></div>
<h1>MiscUtils.cpp File Reference</h1><code>#include &lt;iostream&gt;</code><br>
<code>#include &lt;string&gt;</code><br>
<code>#include &lt;stdio.h&gt;</code><br>
<code>#include &lt;unistd.h&gt;</code><br>
<code>#include &lt;stdlib.h&gt;</code><br>
<code>#include &lt;malloc.h&gt;</code><br>
<code>#include "<a class="el" href="_misc_utils_8h-source.html">MiscUtils.h</a>"</code><br>
<code>#include "<a class="el" href="_p_c_ie_a_p_i_8h-source.html">PCIeAPI.h</a>"</code><br>

<p>
<a href="_misc_utils_8cpp-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_misc_utils_8cpp.html#a0">ShowLastError</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_misc_utils_8cpp.html#a1">AllocAlignedBuffer</a> (size_t size)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_misc_utils_8cpp.html#a2">FreeAlignedBuffer</a> (void *pUserSpaceBuf, size_t size)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_misc_utils_8cpp.html#a3">GetPCIeEnvVarBoardName</a> (char *boardName)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_misc_utils_8cpp.html#a4">GetPCIeEnvVarDemoName</a> (char *demoName)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">uint32_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_misc_utils_8cpp.html#a5">GetPCIeEnvVarBoardNum</a> (uint32_t defaultVal)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_misc_utils_8cpp.html#a6">GetPCIeEnvVars</a> (char *boardName, char *demoName, uint32_t &amp;boardNum)</td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
This is a collection of miscellaneous routines. Some routines provide for 64KB aligned memory allocation. Another displays the last system error message in readable format.
<p>
Definition in file <a class="el" href="_misc_utils_8cpp-source.html">MiscUtils.cpp</a>.<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="MiscUtils.cpp::AllocAlignedBuffer"></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void* AllocAlignedBuffer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">size_t&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>size</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Allocate a block of virtual memory that normally starts on a 64kB boundary. This is very useful for allocating a large buffer in User Space to be used fo SG DMA operations. Having the buffer aligned to 64kB makes the Mapping use less buffer descriptors. This uses the Windows API calls VirtualAlloc() and VirtualLock() to allocate the memory and prevent it from being swapped. VirtualLock() will fail if the amount of allocated memory is larger than approx 200KB, as defined by Windows WorkingSet memory manager. This default can be extended with Windows API calls. The method will still allocate the buffer, but it will not be able to lock it into memory and prevent swapping.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>size</em>&nbsp;</td><td>the size of the buffer </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>a pointer to the allocated block, or NULL if allocation fails. </dd></dl>
<dl compact><dt><b>Note:</b></dt><dd>use <a class="el" href="_misc_utils_8cpp.html#a0">ShowLastError()</a> for info regarding system failure. </dd></dl>

<p>
Definition at line <a class="el" href="_misc_utils_8cpp-source.html#l00085">85</a> of file <a class="el" href="_misc_utils_8cpp-source.html">MiscUtils.cpp</a>.
<p>
References <a class="el" href="_misc_utils_8cpp-source.html#l00037">ShowLastError()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="MiscUtils.cpp::FreeAlignedBuffer"></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">bool FreeAlignedBuffer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void *&nbsp;</td>
          <td class="mdname" nowrap> <em>pUserSpaceBuf</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>size_t&nbsp;</td>
          <td class="mdname" nowrap> <em>size</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Unlock and release memory allocated with <a class="el" href="_misc_utils_8cpp.html#a1">AllocAlignedBuffer()</a> <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>pUserSpaceBuf</em>&nbsp;</td><td>pointer to buffer to release </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>size</em>&nbsp;</td><td>the size of the buffer </td></tr>
  </table>
</dl>

<p>
Definition at line <a class="el" href="_misc_utils_8cpp-source.html#l00135">135</a> of file <a class="el" href="_misc_utils_8cpp-source.html">MiscUtils.cpp</a>.
<p>
References <a class="el" href="_misc_utils_8cpp-source.html#l00037">ShowLastError()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="MiscUtils.cpp::GetPCIeEnvVarBoardName"></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">bool GetPCIeEnvVarBoardName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">char *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>boardName</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Return the Lattice PCIe IP board name to open. This is specified by the system environment variable LSC_PCIE_BOARD. The name format follows the Windows PCI Vendor/Device naming pair. For example "ven_1204&amp;dev_5303". The quotes maybe around the name to escape the '&amp;' which causes problems when assigning with set. Two ways to create the environment variable: <ul>
<li>
set LSC_PCIE_BOARD="ven_1204&amp;dev5303" </li>
<li>
run the PCIeScan utility to locate all Lattice baords and create a config file that sets up the necessary env vars. </li>
</ul>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>boardName</em>&nbsp;</td><td>string to contain name read from envirment variable. The string size must be (LSC_PCIE_BOARD_NAME_LEN + 1) in size (to hold ). </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>true if environment variable found and assigned. False if not found. User will need to use an appropriate default value. </dd></dl>
<dl compact><dt><b>Note:</b></dt><dd>The boardName contents are not modified if the env var is not found, so a default value can be pre-loaded and will remain. </dd></dl>

<p>
Definition at line <a class="el" href="_misc_utils_8cpp-source.html#l00186">186</a> of file <a class="el" href="_misc_utils_8cpp-source.html">MiscUtils.cpp</a>.
<p>
Referenced by <a class="el" href="_misc_utils_8cpp-source.html#l00301">GetPCIeEnvVars()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="MiscUtils.cpp::GetPCIeEnvVarBoardNum"></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">uint32_t GetPCIeEnvVarBoardNum           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">uint32_t&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>defaultVal</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Return the Lattice PCIe eval board instance number to open. This is specified by the system environment variable LSC_PCIE_INSTANCE. The environment variable must be assigned an interger value. The range is typically from 1 to 4. (No real maximum limit, but practically there are never more than 4 PCIe slots in a system). If the environment variable is not defined then the default value passed in is returned. <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>defaultVal</em>&nbsp;</td><td>default board instance to use if env var not found </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>integer value of board instance number to use in opening a Driver Interface. </dd></dl>

<p>
Definition at line <a class="el" href="_misc_utils_8cpp-source.html#l00262">262</a> of file <a class="el" href="_misc_utils_8cpp-source.html">MiscUtils.cpp</a>.
<p>
Referenced by <a class="el" href="_misc_utils_8cpp-source.html#l00301">GetPCIeEnvVars()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="MiscUtils.cpp::GetPCIeEnvVarDemoName"></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">bool GetPCIeEnvVarDemoName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">char *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>demoName</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Return the Lattice PCIe IP demo name to open. This is specified by the system environment variable LSC_PCIE_INSTANCE. The name format follows the Windows PCI SubSys naming. For example "subsys_30301204". The quotes maybe around the name or not. Quotes are usually used with the board name, so this supports them too. Two ways to create the environment variable: <ul>
<li>
set LSC_PCIE_IP_ID="subsys_30301204" </li>
<li>
run the PCIeScan utility to locate all Lattice baords and create a config file that sets up the necessary env vars. </li>
</ul>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>demoName</em>&nbsp;</td><td>string to contain name read from envirment variable. The string size must be (LSC_PCIE_DEMO_NAME_LEN + 1) in size (to hold ). </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>true if environment variable found and assigned. False if not found. User will need to use an appropriate default value. </dd></dl>
<dl compact><dt><b>Note:</b></dt><dd>The demoName contents are not modified if the env var is not found, so a default value can be pre-loaded and will remain. </dd></dl>

<p>
Definition at line <a class="el" href="_misc_utils_8cpp-source.html#l00228">228</a> of file <a class="el" href="_misc_utils_8cpp-source.html">MiscUtils.cpp</a>.
<p>
Referenced by <a class="el" href="_misc_utils_8cpp-source.html#l00301">GetPCIeEnvVars()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="MiscUtils.cpp::GetPCIeEnvVars"></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">bool DLLIMPORT GetPCIeEnvVars           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">char *&nbsp;</td>
          <td class="mdname" nowrap> <em>boardName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>char *&nbsp;</td>
          <td class="mdname" nowrap> <em>demoName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>uint32_t &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>boardNum</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Return the Lattice PCIe environment variables associated with chosing the specific PCIe eval board, demo IP and instance to open. An application may have an option to open a variety of compatible eval boards. This function would be called at the begining of an application to retrieve the user selection of what specific board to connect to. The eval board to connect to is based on the triplet of: (board name),(demo name), (board instance). These values are specified in 3 environment variables. The environment variables used are: <ul>
<li>
LSC_PCIE_BOARD - PCI ven &amp; dev string </li>
<li>
LSC_PCIE_IP_ID - PCI SubSys ID string </li>
<li>
LSC_PCIE_INSTANCE - integer value </li>
</ul>
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>boardName</em>&nbsp;</td><td>string to contain name read from LSC_PCIE_BOARD envirment variable </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>demoName</em>&nbsp;</td><td>string to contain name read from LSC_IP_ID_BOARD envirment variable </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>demoName</em>&nbsp;</td><td>string to contain name read from LSC_PCIE_INSTANCE envirment variable </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>true if environment variables found and assigned. False if not found. User will then need to use an appropriate default value.</dd></dl>
<dl compact><dt><b>Note:</b></dt><dd>The boardName and demoName contents are not modified if the env vars are not found, so a default value can be pre-loaded and will remain. boardNum will be assigned 1 for a default. </dd></dl>

<p>
Definition at line <a class="el" href="_misc_utils_8cpp-source.html#l00301">301</a> of file <a class="el" href="_misc_utils_8cpp-source.html">MiscUtils.cpp</a>.
<p>
References <a class="el" href="_misc_utils_8cpp-source.html#l00186">GetPCIeEnvVarBoardName()</a>, <a class="el" href="_misc_utils_8cpp-source.html#l00262">GetPCIeEnvVarBoardNum()</a>, and <a class="el" href="_misc_utils_8cpp-source.html#l00228">GetPCIeEnvVarDemoName()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="MiscUtils.cpp::ShowLastError"></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void ShowLastError           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Display the system error message associated with the last system error code. Use for when openning a file or other system call fails. 
<p>
Definition at line <a class="el" href="_misc_utils_8cpp-source.html#l00037">37</a> of file <a class="el" href="_misc_utils_8cpp-source.html">MiscUtils.cpp</a>.
<p>
Referenced by <a class="el" href="_misc_utils_8cpp-source.html#l00085">AllocAlignedBuffer()</a>, and <a class="el" href="_misc_utils_8cpp-source.html#l00135">FreeAlignedBuffer()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Wed Jul 16 12:05:27 2008 for Lattice PCIe API Manual by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
