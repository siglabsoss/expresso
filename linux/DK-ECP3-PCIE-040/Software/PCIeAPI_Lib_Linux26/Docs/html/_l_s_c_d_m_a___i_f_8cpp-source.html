<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Lattice PCIe API Manual: LSCDMA_IF.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000006.html">DriverIF</a></div>
<h1>LSCDMA_IF.cpp</h1><a href="_l_s_c_d_m_a___i_f_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> *  COPYRIGHT (c) 2008 by Lattice Semiconductor Corporation</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * All rights reserved. All use of this software and documentation is</span>
00005 <span class="comment"> * subject to the License Agreement located in the file LICENSE.</span>
00006 <span class="comment"> */</span>
00007 
00010 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
00011 <span class="preprocessor">#include &lt;string&gt;</span>
00012 <span class="preprocessor">#include &lt;sstream&gt;</span>
00013 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00014 <span class="preprocessor">#include &lt;iostream&gt;</span>
00015 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00016 <span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span>
00017 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00018 <span class="preprocessor">#include &lt;time.h&gt;</span>
00019 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00020 
00021 
00022 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00023 
00024 <span class="preprocessor">#include "<a class="code" href="_p_c_ie_a_p_i_8h.html">PCIeAPI.h</a>"</span>
00025 <span class="preprocessor">#include "<a class="code" href="_l_s_c_d_m_a___i_f_8h.html">LSCDMA_IF.h</a>"</span>
00026 
00027 <span class="keyword">using</span> <span class="keyword">namespace </span>LatticeSemi_PCIe;
00028 
00029 
00030 
<a name="l00041"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a0">00041</a> <a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a0">LSCDMA_IF::LSCDMA_IF</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *pBoardID, <span class="keyword">const</span> <span class="keywordtype">char</span> *chan, uint32_t devNum) :
00042 
00043         LatticeSemi_PCIe::<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html">PCIe_IF</a>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html">PCIe_IF</a>::pLSCDMA_DRIVER,
00044                            pBoardID, 
00045                           <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html">PCIe_IF</a>::PCIEDMA_DEMO,
00046                            devNum,
00047                            NULL,
00048                            chan)
00049 {
00050     <span class="keyword">const</span> <a class="code" href="struct_d_m_a_resource_info__t.html">DMAResourceInfo_t</a> *pDummy;
00051 
00052     this-&gt;devNum = devNum;
00053     this-&gt;drvrID = drvrID;
00054 
00055 
00056 <span class="comment">// TODO</span>
00057     <span class="comment">// We need to create a semaphore to provide exclusive access to the Common Buffer</span>
00058     <span class="comment">// so multiple threads can't step on the buffer during transfers.</span>
00059     <span class="comment">// There's only one common buffer.</span>
00060 
00061     <span class="comment">// Call to preload the private class variable with the DMA info from the driver</span>
00062     <span class="comment">// at the start.  The dummy variable is not used.</span>
00063     <a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a2">getDriverDMAInfo</a>(&amp;pDummy);
00064 
00065 
00066 }
00067 
00068 
<a name="l00072"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a1">00072</a> <a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a1">LSCDMA_IF::~LSCDMA_IF</a>()
00073 {
00074     cout&lt;&lt;<span class="stringliteral">"LSCDMA_IF: driver closed."</span>&lt;&lt;endl;
00075 }
00076 
00077 
00078 
<a name="l00086"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a4">00086</a> size_t <a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a4">LSCDMA_IF::getSysDmaBufSize</a>(<span class="keywordtype">void</span>)
00087 {
00088     <span class="keywordflow">return</span>(this-&gt;DMAInfo.<a class="code" href="struct_d_m_a_resource_info__t.html#o6">DmaBufSize</a>);
00089 }
00090 
00091 
<a name="l00099"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a2">00099</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a2">LSCDMA_IF::getDriverDMAInfo</a>(<span class="keyword">const</span> <a class="code" href="struct_d_m_a_resource_info__t.html">DMAResourceInfo_t</a> **pInfo)
00100 {
00101 
00102     <span class="keywordflow">if</span> (ioctl(hDev, <a class="code" href="lscdma_2_ioctl_8h.html#a5">IOCTL_LSCDMA_GET_DMA_INFO</a>, &amp;DMAInfo) != 0)
00103         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"LSCDMA_IF: getDriverDMAInfo ioctl Failed!"</span>));
00104 
00105 
00106     *pInfo = &amp;DMAInfo;   <span class="comment">// return pointer to the structure</span>
00107 
00108     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00109 }
00110 
<a name="l00118"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a5">00118</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a5">LSCDMA_IF::writeSysDmaBuf</a>(uint32_t *pBuf, size_t len) 
00119 {
00120     uint32_t *tempBuf;
00121 
00122     <span class="keywordflow">if</span> (!DMAInfo.<a class="code" href="struct_d_m_a_resource_info__t.html#o5">hasDmaBuf</a>)
00123         <span class="keywordflow">return</span>(<span class="keyword">false</span>);
00124 
00125     <span class="keywordflow">if</span> (len &gt; DMAInfo.<a class="code" href="struct_d_m_a_resource_info__t.html#o6">DmaBufSize</a>)
00126         <span class="keywordflow">return</span>(<span class="keyword">false</span>);
00127     <span class="keywordflow">if</span> (len == 0)
00128         len = DMAInfo.<a class="code" href="struct_d_m_a_resource_info__t.html#o6">DmaBufSize</a>;
00129 
00130     tempBuf = (uint32_t *)malloc(DMAInfo.<a class="code" href="struct_d_m_a_resource_info__t.html#o6">DmaBufSize</a>);
00131     <span class="keywordflow">if</span> (tempBuf == NULL)
00132         <span class="keywordflow">return</span>(<span class="keyword">false</span>);
00133 
00134     memset(tempBuf, 0, DMAInfo.<a class="code" href="struct_d_m_a_resource_info__t.html#o6">DmaBufSize</a>);
00135     memcpy(tempBuf, pBuf, len);
00136 
00137 <span class="comment">// TODO : take the semaphore</span>
00138     <span class="keywordflow">if</span> (ioctl(hDev, <a class="code" href="lscdma_2_ioctl_8h.html#a2">IOCTL_LSCDMA_WRITE_SYSDMABUF</a>, tempBuf) != 0)
00139     {
00140 <span class="comment">// TODO : release the semaphore before aborting</span>
00141         free(tempBuf);
00142         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"LSCDMA_IF: IOCTL_LSCDMA_WRITE_SYSDMABUF failed!"</span>));
00143     }
00144 
00145 
00146 <span class="comment">// TODO : release the semaphore</span>
00147 
00148 
00149     free(tempBuf);
00150     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00151 }
00152 
00153 
<a name="l00160"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a6">00160</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a6">LSCDMA_IF::readSysDmaBuf</a>(uint32_t *pBuf, size_t len) 
00161 {
00162     uint32_t *tempBuf;
00163 
00164     <span class="keywordflow">if</span> (!DMAInfo.<a class="code" href="struct_d_m_a_resource_info__t.html#o5">hasDmaBuf</a>)
00165         <span class="keywordflow">return</span>(<span class="keyword">false</span>);
00166 
00167     <span class="keywordflow">if</span> (len &gt; DMAInfo.<a class="code" href="struct_d_m_a_resource_info__t.html#o6">DmaBufSize</a>)
00168         <span class="keywordflow">return</span>(<span class="keyword">false</span>);
00169     <span class="keywordflow">if</span> (len == 0)
00170         len = DMAInfo.<a class="code" href="struct_d_m_a_resource_info__t.html#o6">DmaBufSize</a>;   <span class="comment">// but pBuf needs to be the right length!!!</span>
00171 
00172     tempBuf = (uint32_t *)malloc(DMAInfo.<a class="code" href="struct_d_m_a_resource_info__t.html#o6">DmaBufSize</a>);
00173     <span class="keywordflow">if</span> (tempBuf == NULL)
00174         <span class="keywordflow">return</span>(<span class="keyword">false</span>);
00175 
00176     memset(tempBuf, 0, DMAInfo.<a class="code" href="struct_d_m_a_resource_info__t.html#o6">DmaBufSize</a>);
00177 
00178 <span class="comment">// TODO : take the semaphore</span>
00179     <span class="keywordflow">if</span> (ioctl(hDev, <a class="code" href="lscdma_2_ioctl_8h.html#a1">IOCTL_LSCDMA_READ_SYSDMABUF</a>, tempBuf) != 0)
00180     {
00181 <span class="comment">// TODO : release the semaphore before aborting</span>
00182         free(tempBuf);
00183         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"LSCDMA_IF: IOCTL_LSCDMA_READ_SYSDMABUF failed!"</span>));
00184     }
00185 
00186 
00187     memcpy(pBuf, tempBuf, len);
00188     free(tempBuf);
00189 
00190 <span class="comment">// TODO : release the semaphore</span>
00191 
00192 
00193     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00194 }
00195 
00196 
<a name="l00208"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a7">00208</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a7">LSCDMA_IF::ReadFromDevice</a>(<span class="keywordtype">void</span> *pBuf, size_t len)
00209 {
00210     ssize_t retLen;
00211 
00212     retLen = read(this-&gt;hDev, 
00213             pBuf, 
00214             len);
00215 
00216     <span class="keywordflow">if</span> ((size_t)retLen != len)
00217         <span class="keywordflow">return</span>(<span class="keyword">false</span>);
00218     <span class="keywordflow">else</span>
00219         <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00220 }
00221 
00222 
00223 
<a name="l00235"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a8">00235</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a8">LSCDMA_IF::WriteToDevice</a>(<span class="keywordtype">void</span> *pBuf, size_t len)
00236 {
00237     ssize_t retLen;
00238 
00239     retLen = write(this-&gt;hDev,
00240               pBuf,
00241               len);
00242 
00243     <span class="keywordflow">if</span> ((size_t)retLen != len)
00244         <span class="keywordflow">return</span>(<span class="keyword">false</span>);
00245     <span class="keywordflow">else</span>
00246         <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00247 
00248     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00249 }
00250 
00251 
<a name="l00259"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a3">00259</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a3">LSCDMA_IF::getDriverDMAInfoStr</a>(string &amp;outs)
00260 {
00261 
00262 
00263     <span class="keyword">const</span> <a class="code" href="struct_d_m_a_resource_info__t.html">DMAResourceInfo_t</a> *pInfo;
00264     <a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_d_m_a___i_f.html#a2">getDriverDMAInfo</a>(&amp;pInfo);
00265 
00266     std::ostringstream oss;
00267 
00268     oss&lt;&lt;<span class="stringliteral">"\nlscdma Driver DMA Info:\n"</span>;
00269     oss&lt;&lt;<span class="stringliteral">"DevID="</span>&lt;&lt;pInfo-&gt;<a class="code" href="struct_d_m_a_resource_info__t.html#o0">devID</a>&lt;&lt;endl;
00270     oss&lt;&lt;<span class="stringliteral">"PCI Bus#="</span>&lt;&lt;pInfo-&gt;<a class="code" href="struct_d_m_a_resource_info__t.html#o1">busNum</a>&lt;&lt;endl;
00271     oss&lt;&lt;<span class="stringliteral">"PCI Dev#="</span>&lt;&lt;pInfo-&gt;<a class="code" href="struct_d_m_a_resource_info__t.html#o2">deviceNum</a>&lt;&lt;endl;
00272     oss&lt;&lt;<span class="stringliteral">"PCI Func#="</span>&lt;&lt;pInfo-&gt;<a class="code" href="struct_d_m_a_resource_info__t.html#o3">functionNum</a>&lt;&lt;endl;
00273     oss&lt;&lt;<span class="stringliteral">"UINumber="</span>&lt;&lt;pInfo-&gt;<a class="code" href="struct_d_m_a_resource_info__t.html#o4">UINumber</a>&lt;&lt;endl;
00274     oss&lt;&lt;<span class="stringliteral">"hasDMA="</span>&lt;&lt;pInfo-&gt;<a class="code" href="struct_d_m_a_resource_info__t.html#o5">hasDmaBuf</a>&lt;&lt;endl;
00275     oss&lt;&lt;<span class="stringliteral">"DmaBufSize="</span>&lt;&lt;pInfo-&gt;<a class="code" href="struct_d_m_a_resource_info__t.html#o6">DmaBufSize</a>&lt;&lt;endl;
00276     oss&lt;&lt;<span class="stringliteral">"DmaAddr64="</span>&lt;&lt;pInfo-&gt;<a class="code" href="struct_d_m_a_resource_info__t.html#o7">DmaAddr64</a>&lt;&lt;endl;
00277     oss&lt;&lt;<span class="stringliteral">"DmaPhyAddrHi="</span>&lt;&lt;hex&lt;&lt;pInfo-&gt;<a class="code" href="struct_d_m_a_resource_info__t.html#o8">DmaPhyAddrHi</a>&lt;&lt;endl;
00278     oss&lt;&lt;<span class="stringliteral">"DmaPhyAddrLo="</span>&lt;&lt;pInfo-&gt;<a class="code" href="struct_d_m_a_resource_info__t.html#o9">DmaPhyAddrLo</a>&lt;&lt;dec&lt;&lt;endl;
00279 
00280 
00281     <span class="keywordflow">if</span> (pInfo-&gt;<a class="code" href="struct_d_m_a_resource_info__t.html#o9">DmaPhyAddrLo</a> % 4096)
00282     {
00283         oss&lt;&lt;<span class="stringliteral">"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n"</span>;
00284         oss&lt;&lt;<span class="stringliteral">"WARNING!  Base is not 4kB aligned.\n"</span>;
00285         oss&lt;&lt;<span class="stringliteral">"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n"</span>;
00286     }
00287 
00288     <span class="keywordflow">if</span> (pInfo-&gt;<a class="code" href="struct_d_m_a_resource_info__t.html#o9">DmaPhyAddrLo</a> % 128)
00289     {
00290         oss&lt;&lt;<span class="stringliteral">"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n"</span>;
00291         oss&lt;&lt;<span class="stringliteral">"WARNING!  Base is not 128 aligned.\n"</span>;
00292         oss&lt;&lt;<span class="stringliteral">"Writes need to account for crossing 4k boundary\n"</span>;
00293         oss&lt;&lt;<span class="stringliteral">"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n"</span>;
00294     }
00295 
00296     outs = oss.str();
00297 
00298     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00299 }
00300 
00301 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Jul 16 12:05:26 2008 for Lattice PCIe API Manual by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
