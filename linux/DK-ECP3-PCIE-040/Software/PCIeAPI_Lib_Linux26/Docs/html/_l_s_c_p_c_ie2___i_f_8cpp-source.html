<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Lattice PCIe API Manual: LSCPCIe2_IF.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000006.html">DriverIF</a></div>
<h1>LSCPCIe2_IF.cpp</h1><a href="_l_s_c_p_c_ie2___i_f_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> *  COPYRIGHT (c) 2008 by Lattice Semiconductor Corporation</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * All rights reserved. All use of this software and documentation is</span>
00005 <span class="comment"> * subject to the License Agreement located in the file LICENSE.</span>
00006 <span class="comment"> */</span>
00007 
00010 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
00011 <span class="preprocessor">#include &lt;string&gt;</span>
00012 <span class="preprocessor">#include &lt;sstream&gt;</span>
00013 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00014 <span class="preprocessor">#include &lt;iostream&gt;</span>
00015 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00016 <span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span>
00017 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00018 <span class="preprocessor">#include &lt;time.h&gt;</span>
00019 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00020 
00021 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00022 
00023 <span class="preprocessor">#include "<a class="code" href="_p_c_ie_a_p_i_8h.html">PCIeAPI.h</a>"</span>
00024 <span class="preprocessor">#include "<a class="code" href="_l_s_c_p_c_ie2___i_f_8h.html">LSCPCIe2_IF.h</a>"</span>
00025 
00026 <span class="keyword">using</span> <span class="keyword">namespace </span>LatticeSemi_PCIe;
00027 
00028 
00029 
<a name="l00039"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_p_c_ie2___i_f.html#a0">00039</a> <a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_p_c_ie2___i_f.html#a0">LSCPCIe2_IF::LSCPCIe2_IF</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *pBoardID, <span class="keyword">const</span> <span class="keywordtype">char</span> *pDemoID, uint32_t devNum) :
00040 
00041         LatticeSemi_PCIe::<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html">PCIe_IF</a>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html">PCIe_IF</a>::pLSCPCIE2_DRIVER, pBoardID, pDemoID, devNum, NULL, NULL)
00042 {
00043 
00044     this-&gt;devNum = devNum;
00045     this-&gt;drvrID = drvrID;
00046 
00047 }
00048 
00049 
<a name="l00053"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_p_c_ie2___i_f.html#a1">00053</a> <a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_p_c_ie2___i_f.html#a1">LSCPCIe2_IF::~LSCPCIe2_IF</a>()
00054 {
00055     cout&lt;&lt;<span class="stringliteral">"LSCPCIe2_IF: driver closed."</span>&lt;&lt;endl;
00056 }
00057 
<a name="l00065"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_p_c_ie2___i_f.html#a2">00065</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_p_c_ie2___i_f.html#a2">LSCPCIe2_IF::getPciDriverExtraInfo</a>(<span class="keyword">const</span> <a class="code" href="struct_extra_resource_info__t.html">ExtraResourceInfo_t</a> **pExtra)
00066 {
00067 
00068     <span class="comment">// Use driver specific IOCTL call to get extra PCI info from the driver</span>
00069     <span class="keywordflow">if</span> (ioctl(hDev, <a class="code" href="lscpcie_2_ioctl_8h.html#a7">IOCTL_LSCPCIE2_GET_EXTRA_INFO</a>, &amp;PCIExtraInfo) != 0)
00070     {
00071         close(hDev);
00072         hDev = -1;
00073         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: ioctl Failed!"</span>));
00074     }
00075     <span class="keywordflow">else</span>
00076     {
00077         <span class="keywordflow">if</span> (RUNTIMECTRL(VERBOSE))
00078             cout&lt;&lt;<span class="stringliteral">"LSCPCIe2_IF Get_Extra_Info"</span>&lt;&lt;endl;
00079 
00080     }
00081     *pExtra = &amp;PCIExtraInfo;   <span class="comment">// return pointer to the structure</span>
00082 
00083     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00084 }
00085 
<a name="l00093"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_p_c_ie2___i_f.html#a4">00093</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_p_c_ie2___i_f.html#a4">LSCPCIe2_IF::writeSysDmaBuf</a>(uint32_t *pBuf, size_t len) 
00094 {
00095     ssize_t written;
00096 
00097     <span class="keywordflow">if</span> (len == 0)
00098         <span class="keywordflow">return</span>(<span class="keyword">false</span>);  <span class="comment">// don't support writing nothing</span>
00099 
00100     written = write(this-&gt;hDev,   <span class="comment">// device handle</span>
00101             (<span class="keywordtype">void</span> *)pBuf,   <span class="comment">// user buffer to write</span>
00102             len);         <span class="comment">// number of bytes to write</span>
00103 
00104     <span class="keywordflow">if</span> ((size_t)written != len)
00105         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"LSCPCIe2_IF: WriteFile failed! invalid data returned."</span>));
00106 
00107     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00108 }
00109 
00110 
<a name="l00117"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_p_c_ie2___i_f.html#a5">00117</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_p_c_ie2___i_f.html#a5">LSCPCIe2_IF::readSysDmaBuf</a>(uint32_t *pBuf, size_t len) 
00118 {
00119     ssize_t nRead;
00120 
00121     <span class="keywordflow">if</span> (len == 0)
00122         <span class="keywordflow">return</span>(<span class="keyword">false</span>);  <span class="comment">// don't support reading nothing</span>
00123 
00124     nRead = read(this-&gt;hDev,     <span class="comment">// the device handle</span>
00125              (<span class="keywordtype">void</span> *)pBuf,   <span class="comment">// where to store read data</span>
00126                  len);    <span class="comment">// how much</span>
00127 
00128     <span class="keywordflow">if</span> ((size_t)nRead != len)
00129         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"LSCPCIe2_IF: ReadFile failed! invalid data returned."</span>));
00130 
00131     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00132 }
00133 
00134 
<a name="l00142"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_p_c_ie2___i_f.html#a3">00142</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_p_c_ie2___i_f.html#a3">LSCPCIe2_IF::getPCIExtraInfoStr</a>(string &amp;outs)
00143 {
00144 
00145 
00146     <span class="keyword">const</span> <a class="code" href="struct_extra_resource_info__t.html">ExtraResourceInfo_t</a> *pExtra;
00147     <a class="code" href="class_lattice_semi___p_c_ie_1_1_l_s_c_p_c_ie2___i_f.html#a2">getPciDriverExtraInfo</a>(&amp;pExtra);
00148 
00149     std::ostringstream oss;
00150 
00151     oss&lt;&lt;<span class="stringliteral">"\nDriver Extra Info:\n"</span>;
00152     oss&lt;&lt;<span class="stringliteral">"Driver: "</span>&lt;&lt;pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o10">DriverName</a>&lt;&lt;endl;
00153     oss&lt;&lt;<span class="stringliteral">"DevID="</span>&lt;&lt;pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o0">devID</a>&lt;&lt;endl;
00154     oss&lt;&lt;<span class="stringliteral">"PCI Bus#="</span>&lt;&lt;pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o1">busNum</a>&lt;&lt;endl;
00155     oss&lt;&lt;<span class="stringliteral">"PCI Dev#="</span>&lt;&lt;pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o2">deviceNum</a>&lt;&lt;endl;
00156     oss&lt;&lt;<span class="stringliteral">"PCI Func#="</span>&lt;&lt;pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o3">functionNum</a>&lt;&lt;endl;
00157     oss&lt;&lt;<span class="stringliteral">"UINumber="</span>&lt;&lt;pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o4">UINumber</a>&lt;&lt;endl;
00158     oss&lt;&lt;<span class="stringliteral">"hasDMA="</span>&lt;&lt;pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o5">hasDmaBuf</a>&lt;&lt;endl;
00159     oss&lt;&lt;<span class="stringliteral">"DmaBufSize="</span>&lt;&lt;pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o6">DmaBufSize</a>&lt;&lt;endl;
00160     oss&lt;&lt;<span class="stringliteral">"DmaAddr64="</span>&lt;&lt;pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o7">DmaAddr64</a>&lt;&lt;endl;
00161     oss&lt;&lt;<span class="stringliteral">"DmaPhyAddrHi="</span>&lt;&lt;hex&lt;&lt;pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o8">DmaPhyAddrHi</a>&lt;&lt;endl;
00162     oss&lt;&lt;<span class="stringliteral">"DmaPhyAddrLo="</span>&lt;&lt;pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o9">DmaPhyAddrLo</a>&lt;&lt;dec&lt;&lt;endl;
00163 
00164 
00165     <span class="keywordflow">if</span> (pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o9">DmaPhyAddrLo</a> % 4096)
00166     {
00167         oss&lt;&lt;<span class="stringliteral">"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n"</span>;
00168         oss&lt;&lt;<span class="stringliteral">"WARNING!  Base is not 4kB aligned.\n"</span>;
00169         oss&lt;&lt;<span class="stringliteral">"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n"</span>;
00170     }
00171 
00172     <span class="keywordflow">if</span> (pExtra-&gt;<a class="code" href="struct_extra_resource_info__t.html#o9">DmaPhyAddrLo</a> % 128)
00173     {
00174         oss&lt;&lt;<span class="stringliteral">"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n"</span>;
00175         oss&lt;&lt;<span class="stringliteral">"WARNING!  Base is not 128 aligned.\n"</span>;
00176         oss&lt;&lt;<span class="stringliteral">"Writes need to account for crossing 4k boundary\n"</span>;
00177         oss&lt;&lt;<span class="stringliteral">"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n"</span>;
00178     }
00179 
00180     outs = oss.str();
00181 
00182     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00183 }
00184 
00185 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Jul 16 12:05:26 2008 for Lattice PCIe API Manual by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
