<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Lattice PCIe API Manual: PCIe_IF.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000006.html">DriverIF</a></div>
<h1>PCIe_IF.cpp</h1><a href="_p_c_ie___i_f_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> *  COPYRIGHT (c) 2008 by Lattice Semiconductor Corporation</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * All rights reserved. All use of this software and documentation is</span>
00005 <span class="comment"> * subject to the License Agreement located in the file LICENSE.</span>
00006 <span class="comment"> */</span>
00007 
00010 <span class="preprocessor">#include &lt;string&gt;</span>
00011 <span class="preprocessor">#include &lt;sstream&gt;</span>
00012 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00013 <span class="preprocessor">#include &lt;iostream&gt;</span>
00014 <span class="preprocessor">#include &lt;exception&gt;</span>
00015 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00016 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00017 <span class="preprocessor">#include &lt;stdint.h&gt;</span>
00018 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00019 <span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span>
00020 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00021 <span class="preprocessor">#include &lt;time.h&gt;</span>
00022 
00023 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00024 <span class="preprocessor">#include &lt;sys/mman.h&gt;</span>
00025 
00026 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00027 
00028 
00029 <span class="preprocessor">#include "<a class="code" href="sys_defs_8h.html">sysDefs.h</a>"</span>
00030 <span class="preprocessor">#include "<a class="code" href="_p_c_ie_a_p_i_8h.html">PCIeAPI.h</a>"</span>
00031 <span class="preprocessor">#include "<a class="code" href="_p_c_ie___i_f_8h.html">PCIe_IF.h</a>"</span>
00032 <span class="preprocessor">#include "<a class="code" href="_debug_print_8h.html">DebugPrint.h</a>"</span>
00033 
00034 
00035 <span class="keyword">using</span> <span class="keyword">namespace </span>LatticeSemi_PCIe;
00036 
00037 
00038 <span class="comment">/*==================================================================================================*/</span>
00039 <span class="comment">/*==================================================================================================*/</span>
00040 
00041 <span class="comment">/*==================================================================================================*/</span>
00042 <span class="comment">/*==================================================================================================*/</span>
00043 
00044 
00045 <span class="comment">//====================================================================================</span>
00046 <span class="comment">//====================================================================================</span>
00047 <span class="comment">//         Lattice PCIe Evaluation Board IDs  (Vendor/Device register settings)</span>
00048 <span class="comment">//====================================================================================</span>
00049 <span class="comment">//====================================================================================</span>
00050 
<a name="l00054"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#s0">00054</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *PCIe_IF::PCIE_SC_BRD = <span class="stringliteral">"SC"</span>;
00055 
<a name="l00059"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#s1">00059</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *PCIe_IF::PCIE_ECP2M_BRD = <span class="stringliteral">"ECP2M"</span>;
00060 <span class="keyword">const</span> <span class="keywordtype">char</span> *PCIe_IF::PCIE_ECP2M35_BRD = <span class="stringliteral">"ECP2M"</span>;
00061 <span class="keyword">const</span> <span class="keywordtype">char</span> *PCIe_IF::PCIE_ECP2M50_BRD = <span class="stringliteral">"ECP2M"</span>;
00062 
00063 
00064 <span class="comment">//-------------------------------------------------------------</span>
00065 <span class="comment">// TODO</span>
00066 <span class="comment">// !!!!! NOT FULLY IMPLEMENTED BY HDW YET !!!!</span>
00067 <span class="comment">// Place holder and reference of Board model numbers</span>
00068 <span class="comment">//</span>
00069 <span class="comment">// New board database.  Uniquely IDs the FPGA device and board</span>
00070 <span class="comment">//-------------------------------------------------------------</span>
00071 
<a name="l00073"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#s4">00073</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *PCIe_IF::SC80_PCIE_x8_BRD_GL028 = <span class="stringliteral">"ven_1204&amp;dev_11c0"</span>;
<a name="l00075"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#s5">00075</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *PCIe_IF::ECP2M35_PCIE_x4_BRD_GL029 = <span class="stringliteral">"ven_1204&amp;dev_11d0"</span>;
<a name="l00077"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#s6">00077</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *PCIe_IF::ECP2M50_PCIE_x4_BRD_GL029 = <span class="stringliteral">"ven_1204&amp;dev_11d1"</span>;
<a name="l00079"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#s7">00079</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *PCIe_IF::SC25_PCIE_x1_BRD_GL030 = <span class="stringliteral">"ven_1204&amp;dev_11e0"</span>;
<a name="l00081"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#s8">00081</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *PCIe_IF::ECP2M35_PCIE_x1_BRD_GL031 = <span class="stringliteral">"ven_1204&amp;dev_11f0"</span>;
<a name="l00083"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#s9">00083</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *PCIe_IF::ECP2M35_PCIE_x1_BRD_GL034 = <span class="stringliteral">"ven_1204&amp;dev_1220"</span>;
<a name="l00085"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#s10">00085</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *PCIe_IF::SC80_PCIE_x4_BRD_GL035 = <span class="stringliteral">"ven_1204&amp;dev_11c0"</span>;
00086 
00087 
00088 
00089 <span class="comment">//====================================================================================</span>
00090 <span class="comment">//====================================================================================</span>
00091 <span class="comment">//             Lattice PCIe Demo IDs </span>
00092 <span class="comment">// driver uses the SubSys register settings and creates the following filename</span>
00093 <span class="comment">// sections</span>
00094 <span class="comment">//====================================================================================</span>
00095 <span class="comment">//====================================================================================</span>
<a name="l00099"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#s11">00099</a> <span class="comment"></span><span class="keyword">const</span> <span class="keywordtype">char</span> *PCIe_IF::PCIE_DEMO_SC = <span class="stringliteral">"Basic"</span>;
00100 
<a name="l00105"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#s12">00105</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *PCIe_IF::PCIE_DEMO_EC = <span class="stringliteral">"Basic"</span>;
00106 
00107 
<a name="l00111"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#s13">00111</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *PCIe_IF::BASIC_DEMO = <span class="stringliteral">"Basic"</span>;
00112 
00113 
<a name="l00118"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#s14">00118</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *PCIe_IF::SFIF_DEMO = <span class="stringliteral">"SFIF"</span>;
00119 
<a name="l00123"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#s15">00123</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *PCIe_IF::PCIEDMA_DEMO = <span class="stringliteral">"DMA"</span>;
00124 
00125 
00126 
00127 
00128 <span class="comment">//====================================================================================</span>
00129 <span class="comment">//====================================================================================</span>
00130 <span class="comment">//         Lattice Linux Device Driver IDs (GUID term borrowed from Windows)</span>
00131 <span class="comment">// Here a driver ID is actually the name of the parent driver node in the /dev tree.</span>
00132 <span class="comment">// Linux opens devices based on the filename in the /dev tree.</span>
00133 <span class="comment">//====================================================================================</span>
00134 <span class="comment">//====================================================================================</span>
00135 
<a name="l00137"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#s16">00137</a> <span class="keyword">const</span> GUID *PCIe_IF::pLSCSIM_DRIVER = <span class="stringliteral">"SIM"</span>;
00138 
<a name="l00140"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#s17">00140</a> <span class="keyword">const</span> GUID *PCIe_IF::pLSCPCIE_DRIVER = <span class="stringliteral">"lscpcie2"</span>;
00141 
<a name="l00145"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#s18">00145</a> <span class="keyword">const</span> GUID *PCIe_IF::pLSCPCIE2_DRIVER = <span class="stringliteral">"lscpcie2"</span>;
00146 
<a name="l00150"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#s19">00150</a> <span class="keyword">const</span> GUID *PCIe_IF::pLSCDMA_DRIVER   = <span class="stringliteral">"lscdma"</span>;
00151 
00152 <span class="comment">/*==================================================================================================*/</span>
00153 <span class="comment">/*==================================================================================================*/</span>
00154 <span class="comment">/*==================================================================================================*/</span>
00155 
00156 
00157 <span class="preprocessor">#define NO_SUCH_GUID     -1</span>
00158 <span class="preprocessor"></span><span class="preprocessor">#define NO_SUCH_BOARD_ID -2</span>
00159 <span class="preprocessor"></span><span class="preprocessor">#define NO_SUCH_DEMO_ID  -3</span>
00160 <span class="preprocessor"></span><span class="preprocessor">#define NO_MORE_BOARDS   -4</span>
00161 <span class="preprocessor"></span><span class="preprocessor">#define PARAM_ERROR      -5</span>
00162 <span class="preprocessor"></span><span class="preprocessor">#define OPEN_FILE_FAILED -6</span>
00163 <span class="preprocessor"></span>
00164 
00165 
<a name="l00182"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a0">00182</a> <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a0">PCIe_IF::PCIe_IF</a>(<span class="keyword">const</span> GUID *pGUID, 
00183                  <span class="keyword">const</span> <span class="keywordtype">char</span> *pBoardID,
00184                  <span class="keyword">const</span> <span class="keywordtype">char</span> *pDemoID,
00185                  uint32_t devNum, 
00186                  <span class="keyword">const</span> <span class="keywordtype">char</span> *pFriendlyName, 
00187                  <span class="keyword">const</span> <span class="keywordtype">char</span> *pFunctionName): <a class="code" href="class_lattice_semi___p_c_ie_1_1_register_access.html">RegisterAccess</a>((void *)pBoardID)
00188 {
00189     <span class="keywordtype">int</span> ret;
00190 
00191     hDev = -1;
00192     memset(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>));
00193 
00194     <span class="keywordflow">if</span> (pGUID == NULL)
00195         <span class="keywordflow">return</span>;   <span class="comment">// this is being invoked by a simulation layer, do not open real hardware</span>
00196 
00197     <span class="keywordflow">if</span> ((strstr(pGUID, <span class="stringliteral">"SIM"</span>) != NULL) || (strstr(pDemoID, <span class="stringliteral">"SIM"</span>) != NULL))
00198         <span class="keywordflow">return</span>;   <span class="comment">// this is being invoked by a simulation layer, do not open real hardware</span>
00199 
00200     <span class="keywordflow">if</span> (devNum == 0)
00201         <span class="keywordflow">return</span>;   <span class="comment">// this is being invoked by a simulation layer, do not open real hardware</span>
00202 
00203     <span class="keywordflow">if</span> (RUNTIMECTRL(VERBOSE))
00204         cout&lt;&lt;<span class="stringliteral">"Opening BoardID: "</span>&lt;&lt;pBoardID&lt;&lt;<span class="stringliteral">" DemoID: "</span>&lt;&lt;pDemoID&lt;&lt;endl;
00205 
00206 
00207     <span class="comment">/* Open the kernel driver using the driver ID, Board, Demo and instance number passed in */</span>
00208     ret = <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#b0">OpenDriver</a>(hDev, pGUID, pBoardID, pDemoID, devNum, pFriendlyName, pFunctionName);
00209     <span class="keywordflow">if</span> (ret == NO_SUCH_GUID)
00210         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"NO_SUCH_GUID"</span>));
00211     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ret == NO_SUCH_BOARD_ID)
00212         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"NO_SUCH_BOARD_ID"</span>));
00213     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ret == NO_MORE_BOARDS)
00214         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"NO_MORE_BOARDS"</span>));
00215     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ret == PARAM_ERROR)
00216         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PARAM_ERROR"</span>));
00217     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ret == OPEN_FILE_FAILED)
00218         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"OPEN_FILE_FAILED"</span>));
00219 
00220     <span class="keywordflow">if</span> (RUNTIMECTRL(VERBOSE))
00221         cout&lt;&lt;<span class="stringliteral">"PCIe_IF created."</span>&lt;&lt;endl;
00222 
00223 
00224     <span class="comment">// Use driver specific IOCTL call to get PCI info from the driver</span>
00225     <span class="keywordflow">if</span> (ioctl(hDev, <a class="code" href="lscpcie_2_ioctl_8h.html#a5">IOCTL_LSCPCIE_GET_RESOURCES</a>, &amp;PCIinfo) != 0)
00226     {
00227         close(hDev);
00228         hDev = -1;
00229         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: ioctl Failed!"</span>));
00230     }
00231 
00232     <span class="keywordflow">if</span> (<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#b1">MmapDriver</a>() &lt; 0)
00233         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: mmap BARs Failed!"</span>));
00234 
00235     <span class="keywordflow">if</span> (RUNTIMECTRL(VERBOSE))
00236     {
00237         cout&lt;&lt;<span class="stringliteral">"PCIe_IF Get_RESOURCES: "</span>&lt;&lt;endl;
00238 
00239         cout&lt;&lt;<span class="stringliteral">"hasInterrupt: "</span>&lt;&lt;PCIinfo.<a class="code" href="struct_p_c_i_resource_info__t.html#o3">hasInterrupt</a>;
00240         cout&lt;&lt;<span class="stringliteral">"  Vect: "</span>&lt;&lt;PCIinfo.<a class="code" href="struct_p_c_i_resource_info__t.html#o4">intrVector</a>;
00241         cout&lt;&lt;<span class="stringliteral">"  Num BARs: "</span>&lt;&lt;PCIinfo.<a class="code" href="struct_p_c_i_resource_info__t.html#o0">numBARs</a>&lt;&lt;endl;
00242         <span class="keywordflow">for</span> (uint32_t i = 0; i &lt;PCIinfo.<a class="code" href="struct_p_c_i_resource_info__t.html#o0">numBARs</a>; i++)
00243         {
00244             cout&lt;&lt;<span class="stringliteral">"BAR"</span>&lt;&lt;PCIinfo.<a class="code" href="struct_p_c_i_resource_info__t.html#o1">BAR</a>[i].<a class="code" href="struct_p_c_i___b_a_r__t.html#o0">nBAR</a>;
00245             cout&lt;&lt;<span class="stringliteral">"  Addr: "</span>&lt;&lt;hex&lt;&lt;PCIinfo.<a class="code" href="struct_p_c_i_resource_info__t.html#o1">BAR</a>[i].<a class="code" href="struct_p_c_i___b_a_r__t.html#o1">physStartAddr</a>;
00246             cout&lt;&lt;<span class="stringliteral">"  Size: "</span>&lt;&lt;dec&lt;&lt;PCIinfo.<a class="code" href="struct_p_c_i_resource_info__t.html#o1">BAR</a>[i].<a class="code" href="struct_p_c_i___b_a_r__t.html#o2">size</a>;
00247             cout&lt;&lt;<span class="stringliteral">"  Mapped: "</span>&lt;&lt;PCIinfo.<a class="code" href="struct_p_c_i_resource_info__t.html#o1">BAR</a>[i].<a class="code" href="struct_p_c_i___b_a_r__t.html#o3">memMapped</a>&lt;&lt;endl;
00248         }
00249     }
00250 }
00251 
00252 
<a name="l00256"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a1">00256</a> <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a1">PCIe_IF::~PCIe_IF</a>()
00257 {
00258     <span class="keywordtype">int</span> sysErr;
00259 
00260 
00261     <span class="comment">/* Release the shared memory.  It won't go away but we're done with it */</span>
00262     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; MAX_PCI_BARS; i++)
00263     {
00264         <span class="keywordflow">if</span> (<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[i] != 0)
00265         {
00266             sysErr = munmap((<span class="keywordtype">void</span> *)<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[i], <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p3">sizeBAR</a>[i]);
00267             <span class="keywordflow">if</span> (sysErr == -1)
00268                 perror(<span class="stringliteral">"munmap: "</span>);
00269         }
00270     }
00271 
00272 
00273     <span class="keywordflow">if</span> (hDev != -1)
00274     {
00275         close(hDev);
00276         hDev = -1;   <span class="comment">// don't use anymore</span>
00277     }
00278 
00279     <span class="keywordflow">if</span> (RUNTIMECTRL(VERBOSE))
00280         cout&lt;&lt;<span class="stringliteral">"PCIe_IF: driver closed. Bye."</span>&lt;&lt;endl;
00281 }
00282 
<a name="l00288"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a2">00288</a> HANDLE <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a2">PCIe_IF::getDriverHandle</a>(<span class="keywordtype">void</span>) 
00289 {
00290     <span class="keywordflow">return</span>(hDev);
00291 }
00292 
00293 
<a name="l00301"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a3">00301</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a3">PCIe_IF::getPCIConfigRegs</a>(uint8_t *pCfg)
00302 {
00303     <a class="code" href="struct_p_c_i_resource_info__t.html">PCIResourceInfo_t</a> PCIinfo;
00304 
00305 
00306     <span class="keywordflow">if</span> (ioctl(hDev, <a class="code" href="lscpcie_2_ioctl_8h.html#a5">IOCTL_LSCPCIE_GET_RESOURCES</a>, &amp;PCIinfo) != 0)
00307         <span class="keywordflow">return</span>(<span class="keyword">false</span>);
00308 
00309     memcpy(pCfg, PCIinfo.<a class="code" href="struct_p_c_i_resource_info__t.html#o2">PCICfgReg</a>, <span class="keyword">sizeof</span>(PCIinfo.<a class="code" href="struct_p_c_i_resource_info__t.html#o2">PCICfgReg</a>));
00310 
00311     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00312 }
00313 
00314 
<a name="l00322"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a4">00322</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a4">PCIe_IF::getPCIDriverInfo</a>(<span class="keyword">const</span> <a class="code" href="struct_p_c_i_resource_info__t.html">PCIResourceInfo_t</a> **pInfo)
00323 {
00324     *pInfo = &amp;PCIinfo;   <span class="comment">// return pointer to the structure</span>
00325 
00326     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00327 }
00328 
00329 
<a name="l00338"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a5">00338</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a5">PCIe_IF::getPCIResourcesStr</a>(string &amp;outs)
00339 {
00340     uint8_t buf[256];
00341     PCICfgRegs_t *pPCI;
00342 
00343     <span class="comment">// first get the Cfg 0 registers</span>
00344     <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a3">getPCIConfigRegs</a>(buf);
00345 
00346     <span class="comment">// Now parse and convert to a human readable string of know fields</span>
00347     pPCI = (PCICfgRegs_t *)buf;
00348 
00349     std::ostringstream oss;
00350     oss&lt;&lt;std::setbase(16);
00351 
00352 
00353     oss&lt;&lt;<span class="stringliteral">"[00]Vendor ID: "</span>;
00354     oss&lt;&lt;pPCI-&gt;vendorID;
00355     oss&lt;&lt;<span class="stringliteral">"\n[02]Device ID: "</span>;
00356     oss&lt;&lt;pPCI-&gt;deviceID;
00357     oss&lt;&lt;<span class="stringliteral">"\n[04]Command: "</span>;
00358     oss&lt;&lt;pPCI-&gt;command;
00359     oss&lt;&lt;<span class="stringliteral">" = ["</span>;
00360     <span class="keywordflow">if</span> (pPCI-&gt;command &amp; 0x0100)
00361         oss&lt;&lt;<span class="stringliteral">"IntrDis"</span>;
00362     <span class="comment">// bit 9 not used in PCIexpress</span>
00363     <span class="keywordflow">if</span> (pPCI-&gt;command &amp; 0x0100)
00364         oss&lt;&lt;<span class="stringliteral">" SERR#_en"</span>;
00365     <span class="comment">// bit 7 not used in PCIexpress</span>
00366     <span class="keywordflow">if</span> (pPCI-&gt;command &amp; 0x0040)
00367         oss&lt;&lt;<span class="stringliteral">" ParityErr"</span>;
00368     <span class="comment">// bits 5..3 are not used in PCIexpress</span>
00369     <span class="keywordflow">if</span> (pPCI-&gt;command &amp; 0x0004)
00370         oss&lt;&lt;<span class="stringliteral">" BusMstr"</span>;
00371     <span class="keywordflow">if</span> (pPCI-&gt;command &amp; 0x0002)
00372         oss&lt;&lt;<span class="stringliteral">" Mem"</span>;
00373     <span class="keywordflow">if</span> (pPCI-&gt;command &amp; 0x0001)
00374         oss&lt;&lt;<span class="stringliteral">" IO"</span>;
00375     oss&lt;&lt;<span class="stringliteral">"]"</span>;
00376 
00377     oss&lt;&lt;<span class="stringliteral">"\n[06]Status: "</span>;
00378     oss&lt;&lt;pPCI-&gt;status;
00379     oss&lt;&lt;<span class="stringliteral">" = ["</span>;
00380     <span class="keywordflow">if</span> (pPCI-&gt;status &amp; 0x8000)
00381         oss&lt;&lt;<span class="stringliteral">" ParityErr"</span>;
00382     <span class="keywordflow">if</span> (pPCI-&gt;status &amp; 0x4000)
00383         oss&lt;&lt;<span class="stringliteral">" sentSysErr"</span>;
00384     <span class="keywordflow">if</span> (pPCI-&gt;status &amp; 0x2000)
00385         oss&lt;&lt;<span class="stringliteral">" recvdMstrAbort"</span>;
00386     <span class="keywordflow">if</span> (pPCI-&gt;status &amp; 0x1000)
00387         oss&lt;&lt;<span class="stringliteral">" recvdTargetAbort"</span>;
00388     <span class="keywordflow">if</span> (pPCI-&gt;status &amp; 0x0800)
00389         oss&lt;&lt;<span class="stringliteral">" sentTargetAbort"</span>;
00390     <span class="keywordflow">if</span> (pPCI-&gt;status &amp; 0x0100)
00391         oss&lt;&lt;<span class="stringliteral">" DataErr"</span>;
00392     <span class="comment">// bits 7..5 are not used in PCIexpress</span>
00393     <span class="keywordflow">if</span> (pPCI-&gt;status &amp; 0x0010)
00394         oss&lt;&lt;<span class="stringliteral">" CapList"</span>;
00395     <span class="keywordflow">if</span> (pPCI-&gt;status &amp; 0x0008)
00396         oss&lt;&lt;<span class="stringliteral">" Intr"</span>;
00397     oss&lt;&lt;<span class="stringliteral">"]"</span>;
00398 
00399 
00400 
00401     oss&lt;&lt;<span class="stringliteral">"\n[08]Rev ID: "</span>;
00402     oss&lt;&lt;(int)pPCI-&gt;revID;
00403     oss&lt;&lt;<span class="stringliteral">"\n[09]Class Code: "</span>;
00404     oss&lt;&lt;(int)pPCI-&gt;classCode[2];
00405     oss&lt;&lt;(int)pPCI-&gt;classCode[1];
00406     oss&lt;&lt;(int)pPCI-&gt;classCode[0];
00407     oss&lt;&lt;<span class="stringliteral">"\n[0c]Cache Line Size: "</span>;
00408     oss&lt;&lt;(int)pPCI-&gt;cacheLineSize;
00409     oss&lt;&lt;<span class="stringliteral">"\n[0d]Latency Timer: "</span>;
00410     oss&lt;&lt;(int)pPCI-&gt;latencyTimer;
00411     oss&lt;&lt;<span class="stringliteral">"\n[0e]Header Type: "</span>;
00412     oss&lt;&lt;(int)pPCI-&gt;headerType;
00413     oss&lt;&lt;<span class="stringliteral">"\n[0f]BIST: "</span>;
00414     oss&lt;&lt;(int)pPCI-&gt;BIST;
00415     oss&lt;&lt;<span class="stringliteral">"\n[10]BAR0: "</span>;
00416     oss&lt;&lt;pPCI-&gt;BAR0;
00417     oss&lt;&lt;<span class="stringliteral">"\n[14]BAR1: "</span>;
00418     oss&lt;&lt;pPCI-&gt;BAR1;
00419     oss&lt;&lt;<span class="stringliteral">"\n[18]BAR2: "</span>;
00420     oss&lt;&lt;pPCI-&gt;BAR2;
00421     oss&lt;&lt;<span class="stringliteral">"\n[1c]BAR3: "</span>;
00422     oss&lt;&lt;pPCI-&gt;BAR3;
00423     oss&lt;&lt;<span class="stringliteral">"\n[20]BAR4: "</span>;
00424     oss&lt;&lt;pPCI-&gt;BAR4;
00425     oss&lt;&lt;<span class="stringliteral">"\n[24]BAR5: "</span>;
00426     oss&lt;&lt;pPCI-&gt;BAR5;
00427     oss&lt;&lt;<span class="stringliteral">"\n[28]Cardbus CIS Ptr: "</span>;
00428     oss&lt;&lt;pPCI-&gt;cardBusPtr;
00429     oss&lt;&lt;<span class="stringliteral">"\n[2c]Subsystem Vendor ID: "</span>;
00430     oss&lt;&lt;pPCI-&gt;subsystemVendorID;
00431     oss&lt;&lt;<span class="stringliteral">"\n[2e]Subsystem ID: "</span>;
00432     oss&lt;&lt;pPCI-&gt;subsystemID;
00433     oss&lt;&lt;<span class="stringliteral">"\n[30]Exp ROM: "</span>;
00434     oss&lt;&lt;pPCI-&gt;expROM_BAR;
00435     oss&lt;&lt;<span class="stringliteral">"\n[34]Capabilities Ptr: "</span>;
00436     oss&lt;&lt;(int)pPCI-&gt;capabilitiesPtr;
00437     oss&lt;&lt;<span class="stringliteral">"\n[3c]Interrupt Line: "</span>;
00438     oss&lt;&lt;(int)pPCI-&gt;interruptLine;
00439     oss&lt;&lt;<span class="stringliteral">"\n[3d]Interrupt Pin: "</span>;
00440     oss&lt;&lt;(int)pPCI-&gt;interruptPin;
00441     oss&lt;&lt;<span class="stringliteral">"\n[3e]Min Grant: "</span>;
00442     oss&lt;&lt;(int)pPCI-&gt;minGrant;
00443     oss&lt;&lt;<span class="stringliteral">"\n[3f]Max Latency: "</span>;
00444     oss&lt;&lt;(int)pPCI-&gt;maxLatency;
00445 
00446     outs = oss.str();
00447 
00448     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00449 }
00450 
<a name="l00459"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a6">00459</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a6">PCIe_IF::getDriverVersionStr</a>(string &amp;outs)
00460 {
00461     <a class="code" href="lscpcie_2_ioctl_8h.html#a9">DriverVerStr_t</a> str;
00462     
00463     <span class="keywordflow">if</span> (ioctl(hDev, <a class="code" href="lscpcie_2_ioctl_8h.html#a4">IOCTL_LSCPCIE_GET_VERSION_INFO</a>, str) != 0)
00464     {
00465         outs.append(<span class="stringliteral">"ERROR"</span>);
00466         <span class="keywordflow">return</span>(<span class="keyword">false</span>);
00467     }
00468 
00469     outs.append(str);
00470 
00471     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00472 }
00473 
00474 
<a name="l00482"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a7">00482</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a7">PCIe_IF::getDriverResourcesStr</a>(string &amp;outs)
00483 {
00484     <span class="keyword">const</span> <a class="code" href="struct_p_c_i_resource_info__t.html">PCIResourceInfo_t</a> *pPCI;
00485 
00486     <span class="comment">// first get the driver data</span>
00487     this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a4">getPCIDriverInfo</a>(&amp;pPCI);
00488 
00489     std::ostringstream oss;
00490     oss&lt;&lt;<span class="stringliteral">"Number of BARs: "</span>&lt;&lt;pPCI-&gt;<a class="code" href="struct_p_c_i_resource_info__t.html#o0">numBARs</a>&lt;&lt;<span class="stringliteral">"\n"</span>;
00491     <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; pPCI-&gt;<a class="code" href="struct_p_c_i_resource_info__t.html#o0">numBARs</a>; i++)
00492     {
00493         oss&lt;&lt;<span class="stringliteral">"BAR"</span>&lt;&lt;pPCI-&gt;<a class="code" href="struct_p_c_i_resource_info__t.html#o1">BAR</a>[i].<a class="code" href="struct_p_c_i___b_a_r__t.html#o0">nBAR</a>&lt;&lt;<span class="stringliteral">":"</span>;
00494         oss&lt;&lt;<span class="stringliteral">"  Addr: "</span>&lt;&lt;hex&lt;&lt;pPCI-&gt;<a class="code" href="struct_p_c_i_resource_info__t.html#o1">BAR</a>[i].<a class="code" href="struct_p_c_i___b_a_r__t.html#o1">physStartAddr</a>;
00495         oss&lt;&lt;<span class="stringliteral">"  Size: "</span>&lt;&lt;dec&lt;&lt;pPCI-&gt;<a class="code" href="struct_p_c_i_resource_info__t.html#o1">BAR</a>[i].<a class="code" href="struct_p_c_i___b_a_r__t.html#o2">size</a>;
00496         oss&lt;&lt;<span class="stringliteral">"  Mapped:"</span>&lt;&lt;pPCI-&gt;<a class="code" href="struct_p_c_i_resource_info__t.html#o1">BAR</a>[i].<a class="code" href="struct_p_c_i___b_a_r__t.html#o3">memMapped</a>&lt;&lt;<span class="stringliteral">"\n"</span>;
00497     }
00498     <span class="keywordflow">if</span> (pPCI-&gt;<a class="code" href="struct_p_c_i_resource_info__t.html#o3">hasInterrupt</a>)
00499         oss&lt;&lt;<span class="stringliteral">"Interrupt Vector: "</span>&lt;&lt;pPCI-&gt;<a class="code" href="struct_p_c_i_resource_info__t.html#o4">intrVector</a>&lt;&lt;<span class="stringliteral">"\n"</span>;
00500     <span class="keywordflow">else</span>
00501         oss&lt;&lt;<span class="stringliteral">"NO INTERRUPTS\n"</span>;
00502 
00503     outs = oss.str();
00504 
00505     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00506 }
00507 
00508 
<a name="l00519"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a8">00519</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a8">PCIe_IF::getPCICapabiltiesStr</a>(string &amp;outs)
00520 {
00521 
00522     <span class="keywordtype">int</span> i, id, next, index;
00523     uint8_t buf[256];
00524     PCICfgRegs_t *pPCI;
00525     uint8_t *p8;
00526     uint16_t *p16;
00527     uint32_t *p32;
00528 
00529     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *L0sLat[8] = {<span class="stringliteral">"64ns"</span>, <span class="stringliteral">"128ns"</span>, <span class="stringliteral">"256ns"</span>, <span class="stringliteral">"1us"</span>, <span class="stringliteral">"2us"</span>, <span class="stringliteral">"4us"</span>, <span class="stringliteral">"&gt;4us"</span>}; 
00530     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *L1Lat[8] = {<span class="stringliteral">"1us"</span>, <span class="stringliteral">"2us"</span>, <span class="stringliteral">"4us"</span>, <span class="stringliteral">"8us"</span>, <span class="stringliteral">"16us"</span>, <span class="stringliteral">"32us"</span>, <span class="stringliteral">"64us"</span>, <span class="stringliteral">"&gt;64us"</span>};    
00531 
00532 
00533     <span class="comment">// first get the Cfg 0 registers</span>
00534     <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a3">getPCIConfigRegs</a>(buf);
00535 
00536     pPCI = (PCICfgRegs_t *)buf;
00537 
00538     std::ostringstream oss;
00539     <span class="comment">//oss&lt;&lt;std::setbase(16);</span>
00540 
00541     <span class="comment">// Now parse the capabilities structures.  The first structure in the list</span>
00542     <span class="comment">// is pointed to by the Capabilities Ptr at location 0x34.  If this is 0</span>
00543     <span class="comment">// or the capabilities bit in the status is 0 then there are none.</span>
00544     <span class="keywordflow">if</span> (((pPCI-&gt;status &amp; 0x10) == 0) || (pPCI-&gt;capabilitiesPtr == 0))
00545     {
00546         oss&lt;&lt;<span class="stringliteral">"No Capabilities Structures."</span>;
00547         cout&lt;&lt;oss.str();
00548         <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00549     }
00550 
00551     i = 0;
00552     next = (int)pPCI-&gt;capabilitiesPtr;
00553     <span class="keywordflow">while</span> ((next &gt;= 0x40) &amp;&amp; (i &lt; 16))
00554     {
00555         ++i;  <span class="comment">// loop counter to prevent circular loop</span>
00556         index = next;
00557         <span class="keywordtype">id</span> = buf[next];
00558         p8 = (uint8_t *)&amp;buf[next];
00559         p16 = (uint16_t *)&amp;buf[next];
00560         p32 = (uint32_t *)&amp;buf[next];
00561         next = (int)buf[next + 1];
00562         <span class="keywordflow">switch</span>(id)
00563         {
00564             <span class="keywordflow">case</span> 1:  <span class="comment">// Power Management</span>
00565                 oss&lt;&lt;<span class="stringliteral">"\nPower Management Capability Structure @ 0x"</span>&lt;&lt;hex&lt;&lt;index&lt;&lt;<span class="stringliteral">"\n"</span>;
00566 
00567                 oss&lt;&lt;<span class="stringliteral">"\tPwrCap: 0x"</span>&lt;&lt;hex&lt;&lt;p16[1]&lt;&lt;dec&lt;&lt;<span class="stringliteral">" = ["</span>;
00568                 oss&lt;&lt;<span class="stringliteral">"PME:"</span>;
00569                 <span class="keywordflow">if</span> (p16[1] &amp; 0x8000)
00570                     oss&lt;&lt;<span class="stringliteral">"D3c-"</span>;
00571                 <span class="keywordflow">if</span> (p16[1] &amp; 0x4000)
00572                     oss&lt;&lt;<span class="stringliteral">"D3h-"</span>;
00573                 <span class="keywordflow">if</span> (p16[1] &amp; 0x2000)
00574                     oss&lt;&lt;<span class="stringliteral">"D2-"</span>;
00575                 <span class="keywordflow">if</span> (p16[1] &amp; 0x1000)
00576                     oss&lt;&lt;<span class="stringliteral">"D1-"</span>;
00577                 <span class="keywordflow">if</span> (p16[1] &amp; 0x0800)
00578                     oss&lt;&lt;<span class="stringliteral">"D0"</span>;
00579                 <span class="keywordflow">if</span> (p16[1] &amp; 0x0400)
00580                     oss&lt;&lt;<span class="stringliteral">" D2_support"</span>;
00581                 <span class="keywordflow">if</span> (p16[1] &amp; 0x0200)
00582                     oss&lt;&lt;<span class="stringliteral">" D1_support"</span>;
00583                 <span class="comment">// bunch of other bits that aren't really applicable</span>
00584                 oss&lt;&lt;<span class="stringliteral">" ver="</span>&lt;&lt;(p16[1] &amp; 0x007);
00585                 oss&lt;&lt;<span class="stringliteral">"]\n"</span>;
00586 
00587                 oss&lt;&lt;<span class="stringliteral">"\tPMCSR: 0x"</span>&lt;&lt;hex&lt;&lt;p16[2]&lt;&lt;dec&lt;&lt;<span class="stringliteral">" = ["</span>;
00588                 <span class="keywordflow">if</span> (p16[2] &amp; 0x8000)
00589                     oss&lt;&lt;<span class="stringliteral">"PME_Event"</span>;
00590                 <span class="comment">// Data_scale is bits 14:13</span>
00591                 <span class="comment">// Data_select is bits 12:9</span>
00592                 <span class="keywordflow">if</span> (p16[2] &amp; 0x0100)
00593                     oss&lt;&lt;<span class="stringliteral">" PME_en"</span>;
00594                 oss&lt;&lt;<span class="stringliteral">" state=D"</span>&lt;&lt;(p16[2] &amp; 0x003);
00595                 oss&lt;&lt;<span class="stringliteral">"]\n"</span>;
00596 
00597                 oss&lt;&lt;<span class="stringliteral">"\tData: 0x"</span>&lt;&lt;hex&lt;&lt;(int)p8[7]&lt;&lt;<span class="stringliteral">"\n"</span>;
00598                 <span class="keywordflow">break</span>;
00599 
00600             <span class="keywordflow">case</span> 2:  <span class="comment">// AGP Capability</span>
00601                 oss&lt;&lt;<span class="stringliteral">"\nAGP Capability Structure @ 0x"</span>&lt;&lt;hex&lt;&lt;index&lt;&lt;<span class="stringliteral">"\n"</span>;
00602                 <span class="keywordflow">break</span>;
00603 
00604             <span class="keywordflow">case</span> 3:  <span class="comment">// VPD (Vital Product Data) Capability</span>
00605                 oss&lt;&lt;<span class="stringliteral">"\nVPD (Vital Product Data) Capability Structure @ 0x"</span>&lt;&lt;hex&lt;&lt;index&lt;&lt;<span class="stringliteral">"\n"</span>;
00606                 <span class="keywordflow">break</span>;
00607 
00608             <span class="keywordflow">case</span> 4:  <span class="comment">// Slot ID Capability</span>
00609                 oss&lt;&lt;<span class="stringliteral">"\nSlot ID Capability Structure @ 0x"</span>&lt;&lt;hex&lt;&lt;index&lt;&lt;<span class="stringliteral">"\n"</span>;
00610                 <span class="keywordflow">break</span>;
00611 
00612             <span class="keywordflow">case</span> 5:  <span class="comment">// MSI</span>
00613                 oss&lt;&lt;<span class="stringliteral">"\nMSI Capability Structure @ 0x"</span>&lt;&lt;hex&lt;&lt;index&lt;&lt;<span class="stringliteral">"\n"</span>;
00614 
00615                 oss&lt;&lt;<span class="stringliteral">"\tMsgCtrlReg: 0x"</span>&lt;&lt;hex&lt;&lt;p16[1]&lt;&lt;dec&lt;&lt;<span class="stringliteral">" = ["</span>;
00616                 <span class="keywordflow">if</span> (p16[1] &amp; 0x0080)
00617                     oss&lt;&lt;<span class="stringliteral">"64bitAddr "</span>;
00618                 oss&lt;&lt;<span class="stringliteral">"numMsgs="</span>&lt;&lt;(1&lt;&lt;((p16[1] &amp; 0x0070)&gt;&gt;4))&lt;&lt;<span class="stringliteral">" "</span>;
00619                 oss&lt;&lt;<span class="stringliteral">"reqMsgs="</span>&lt;&lt;(1&lt;&lt;((p16[1] &amp; 0x000e)&gt;&gt;1))&lt;&lt;<span class="stringliteral">" "</span>;
00620                 <span class="keywordflow">if</span> (p16[1] &amp; 0x0001)
00621                     oss&lt;&lt;<span class="stringliteral">"MSI_Enable "</span>;
00622                 oss&lt;&lt;<span class="stringliteral">"]\n"</span>;
00623 
00624                 oss&lt;&lt;<span class="stringliteral">"\tMsgAddr: 0x"</span>&lt;&lt;hex&lt;&lt;p32[2]&lt;&lt;p32[1]&lt;&lt;<span class="stringliteral">"\n"</span>;   <span class="comment">// display the 64 bit address</span>
00625                 oss&lt;&lt;<span class="stringliteral">"\tMsgData: 0x"</span>&lt;&lt;hex&lt;&lt;p16[6]&lt;&lt;<span class="stringliteral">"\n"</span>;
00626                 <span class="keywordflow">break</span>;
00627 
00628             <span class="keywordflow">case</span> 6:  <span class="comment">// CompactPCI Hot Swap</span>
00629                 oss&lt;&lt;<span class="stringliteral">"\nCompactPCI Hot Swap Capability Structure @ 0x"</span>&lt;&lt;hex&lt;&lt;index&lt;&lt;<span class="stringliteral">"\n"</span>;
00630                 <span class="keywordflow">break</span>;
00631 
00632             <span class="keywordflow">case</span> 7:  <span class="comment">// PCI-X</span>
00633                 oss&lt;&lt;<span class="stringliteral">"\nPCI-X Capability Structure @ 0x"</span>&lt;&lt;hex&lt;&lt;index&lt;&lt;<span class="stringliteral">"\n"</span>;
00634                 <span class="keywordflow">break</span>;
00635 
00636             <span class="keywordflow">case</span> 8:  <span class="comment">// AMD</span>
00637                 oss&lt;&lt;<span class="stringliteral">"\nAMD Capability Structure @ 0x"</span>&lt;&lt;hex&lt;&lt;index&lt;&lt;<span class="stringliteral">"\n"</span>;
00638                 <span class="keywordflow">break</span>;
00639 
00640             <span class="keywordflow">case</span> 9:  <span class="comment">// Vendor Specific</span>
00641                 oss&lt;&lt;<span class="stringliteral">"\nVendor Specific Capability Structure @ 0x"</span>&lt;&lt;hex&lt;&lt;index&lt;&lt;<span class="stringliteral">"\n"</span>;
00642                 <span class="keywordflow">break</span>;
00643 
00644             <span class="keywordflow">case</span> 0x0a:  <span class="comment">// Debug Port</span>
00645                 oss&lt;&lt;<span class="stringliteral">"\nDebug Port @ 0x"</span>&lt;&lt;hex&lt;&lt;index&lt;&lt;<span class="stringliteral">"\n"</span>;
00646                 <span class="keywordflow">break</span>;
00647 
00648             <span class="keywordflow">case</span> 0x0b:  <span class="comment">// CompactPCI central resource control</span>
00649                 oss&lt;&lt;<span class="stringliteral">"\nCompactPCI central resource control @ 0x"</span>&lt;&lt;hex&lt;&lt;index&lt;&lt;<span class="stringliteral">"\n"</span>;
00650                 <span class="keywordflow">break</span>;
00651 
00652             <span class="keywordflow">case</span> 0x0c:  <span class="comment">// PCI Hot Plug</span>
00653                 oss&lt;&lt;<span class="stringliteral">"\nPCI Hot-Plug Compatable @ 0x"</span>&lt;&lt;hex&lt;&lt;index&lt;&lt;<span class="stringliteral">"\n"</span>;
00654                 <span class="keywordflow">break</span>;
00655 
00656             <span class="keywordflow">case</span> 0x10: <span class="comment">// PCI Express</span>
00657                 oss&lt;&lt;<span class="stringliteral">"\nPCI Express Capability Structure @ 0x"</span>&lt;&lt;hex&lt;&lt;index&lt;&lt;<span class="stringliteral">"\n"</span>;
00658                 oss&lt;&lt;<span class="stringliteral">"\tPCIe_Cap: 0x"</span>&lt;&lt;hex&lt;&lt;p16[1]&lt;&lt;dec&lt;&lt;<span class="stringliteral">" = ["</span>;
00659                 oss&lt;&lt;<span class="stringliteral">" IntMsg#="</span>&lt;&lt;((p16[1] &amp; 0x3e00)&gt;&gt;9);
00660                 <span class="keywordflow">if</span> (p16[1] &amp; 0x0100)
00661                     oss&lt;&lt;<span class="stringliteral">" SlotImp"</span>;
00662                 oss&lt;&lt;<span class="stringliteral">" type="</span>&lt;&lt;((p16[1] &amp; 0x0f0)&gt;&gt;4);   <span class="comment">// 0=PCIeEndPt, 1= Legacy</span>
00663                 oss&lt;&lt;<span class="stringliteral">" ver="</span>&lt;&lt;(p16[1] &amp; 0x00f);
00664                 oss&lt;&lt;<span class="stringliteral">"]\n"</span>;
00665 
00666 
00667                 oss&lt;&lt;<span class="stringliteral">"\tDev_Cap: 0x"</span>&lt;&lt;hex&lt;&lt;p32[1]&lt;&lt;dec&lt;&lt;<span class="stringliteral">" = ["</span>;
00668                 <span class="keywordflow">if</span> (p32[1] &amp; 0x4000)
00669                     oss&lt;&lt;<span class="stringliteral">" PwrInd"</span>;
00670                 <span class="keywordflow">if</span> (p32[1] &amp; 0x2000)
00671                     oss&lt;&lt;<span class="stringliteral">" AttInd"</span>;
00672                 <span class="keywordflow">if</span> (p32[1] &amp; 0x1000)
00673                     oss&lt;&lt;<span class="stringliteral">" AttBtn"</span>;
00674                 oss&lt;&lt;<span class="stringliteral">" L1Lat="</span>&lt;&lt;L1Lat[((p32[1] &amp; 0x0e00)&gt;&gt;9)];
00675                 oss&lt;&lt;<span class="stringliteral">" L0sLat="</span>&lt;&lt;L0sLat[((p32[1] &amp; 0x01c0)&gt;&gt;6)];
00676                 <span class="keywordflow">if</span> (p32[1] &amp; 0x20)
00677                     oss&lt;&lt;<span class="stringliteral">" 8bit_tag"</span>;
00678                 <span class="keywordflow">if</span> (p32[1] &amp; 0x18)
00679                     oss&lt;&lt;<span class="stringliteral">" Phantom"</span>;
00680                 oss&lt;&lt;<span class="stringliteral">" MaxTLPSize="</span>&lt;&lt;(128&lt;&lt;(p32[1] &amp; 0x07));
00681                 oss&lt;&lt;<span class="stringliteral">"]\n"</span>;
00682 
00683 
00684                 oss&lt;&lt;<span class="stringliteral">"\tDev_Ctrl: 0x"</span>&lt;&lt;hex&lt;&lt;p16[4]&lt;&lt;dec&lt;&lt;<span class="stringliteral">" = ["</span>;
00685                 oss&lt;&lt;<span class="stringliteral">" MaxRdSize="</span>&lt;&lt;(128&lt;&lt;((p16[4] &amp; 0x7000)&gt;&gt;12));
00686                 <span class="keywordflow">if</span> (p16[4] &amp; 0x0800)
00687                     oss&lt;&lt;<span class="stringliteral">" NoSnoop"</span>;
00688                 <span class="keywordflow">if</span> (p16[4] &amp; 0x0400)
00689                     oss&lt;&lt;<span class="stringliteral">" AuxPwr"</span>;
00690                 <span class="keywordflow">if</span> (p16[4] &amp; 0x0200)
00691                     oss&lt;&lt;<span class="stringliteral">" Phantom"</span>;
00692                 <span class="keywordflow">if</span> (p16[4] &amp; 0x0100)
00693                     oss&lt;&lt;<span class="stringliteral">" ExtTag"</span>;
00694                 oss&lt;&lt;<span class="stringliteral">" MaxTLPSize="</span>&lt;&lt;(128&lt;&lt;((p16[4] &amp; 0x0e)&gt;&gt;5));
00695                 <span class="keywordflow">if</span> (p16[4] &amp; 0x0010)
00696                     oss&lt;&lt;<span class="stringliteral">" RlxOrd"</span>;
00697                 <span class="keywordflow">if</span> (p16[4] &amp; 0x0008)
00698                     oss&lt;&lt;<span class="stringliteral">" UR"</span>;
00699                 <span class="keywordflow">if</span> (p16[4] &amp; 0x0004)
00700                     oss&lt;&lt;<span class="stringliteral">" ERR_FATAL"</span>;
00701                 <span class="keywordflow">if</span> (p16[4] &amp; 0x0002)
00702                     oss&lt;&lt;<span class="stringliteral">" ERR_NONFATAL"</span>;
00703                 <span class="keywordflow">if</span> (p16[4] &amp; 0x0001)
00704                     oss&lt;&lt;<span class="stringliteral">" ERR_COR"</span>;
00705                 oss&lt;&lt;<span class="stringliteral">"]\n"</span>;
00706 
00707 
00708                 oss&lt;&lt;<span class="stringliteral">"\tDev_Stat: 0x"</span>&lt;&lt;hex&lt;&lt;p16[5]&lt;&lt;dec&lt;&lt;<span class="stringliteral">" = ["</span>;
00709                 <span class="keywordflow">if</span> (p16[5] &amp; 0x0020)
00710                     oss&lt;&lt;<span class="stringliteral">" ReqPend"</span>;
00711                 <span class="keywordflow">if</span> (p16[5] &amp; 0x0010)
00712                     oss&lt;&lt;<span class="stringliteral">" AuxPwr"</span>;
00713                 <span class="keywordflow">if</span> (p16[5] &amp; 0x0008)
00714                     oss&lt;&lt;<span class="stringliteral">" UR"</span>;
00715                 <span class="keywordflow">if</span> (p16[5] &amp; 0x0004)
00716                     oss&lt;&lt;<span class="stringliteral">" ERR_FATAL"</span>;
00717                 <span class="keywordflow">if</span> (p16[5] &amp; 0x0002)
00718                     oss&lt;&lt;<span class="stringliteral">" ERR_NONFATAL"</span>;
00719                 <span class="keywordflow">if</span> (p16[5] &amp; 0x0001)
00720                     oss&lt;&lt;<span class="stringliteral">" ERR_COR"</span>;
00721                 oss&lt;&lt;<span class="stringliteral">"]\n"</span>;
00722 
00723 
00724                 oss&lt;&lt;<span class="stringliteral">"\tLink_Cap: 0x"</span>&lt;&lt;hex&lt;&lt;p32[3]&lt;&lt;dec&lt;&lt;<span class="stringliteral">" = ["</span>;
00725                 oss&lt;&lt;<span class="stringliteral">" Port#="</span>&lt;&lt;((p32[3] &amp; 0xff000000)&gt;&gt;24);
00726                 oss&lt;&lt;<span class="stringliteral">" L1Lat="</span>&lt;&lt;L1Lat[((p32[3] &amp; 0x38000)&gt;&gt;15)];
00727                 oss&lt;&lt;<span class="stringliteral">" L0sLat="</span>&lt;&lt;L0sLat[((p32[3] &amp; 0x7000)&gt;&gt;12)];
00728                 <span class="keywordflow">if</span> ((p32[3] &amp; 0x0c00) == 0x0c00)
00729                     oss&lt;&lt;<span class="stringliteral">" ASPM:L1+L0s"</span>;
00730                 <span class="keywordflow">if</span> ((p32[3] &amp; 0x0c00) == 0x0400)
00731                     oss&lt;&lt;<span class="stringliteral">" ASPM:L0s"</span>;
00732                 oss&lt;&lt;<span class="stringliteral">" Width=x"</span>&lt;&lt;((p32[3] &amp; 0x03f0)&gt;&gt;4);
00733                 <span class="keywordflow">if</span> (p32[3] &amp; 0x0001)
00734                     oss&lt;&lt;<span class="stringliteral">" 2.5G"</span>;
00735                 oss&lt;&lt;<span class="stringliteral">"]\n"</span>;
00736 
00737 
00738                 oss&lt;&lt;<span class="stringliteral">"\tLink_Ctrl: 0x"</span>&lt;&lt;hex&lt;&lt;p16[6]&lt;&lt;dec&lt;&lt;<span class="stringliteral">" = ["</span>;
00739                 <span class="keywordflow">if</span> (p16[8] &amp; 0x0080)
00740                     oss&lt;&lt;<span class="stringliteral">" ExtSync"</span>;
00741                 <span class="keywordflow">if</span> (p16[8] &amp; 0x0040)
00742                     oss&lt;&lt;<span class="stringliteral">" CommonClk"</span>;
00743                 <span class="keywordflow">if</span> (p16[8] &amp; 0x0008)
00744                     oss&lt;&lt;<span class="stringliteral">" RCB=128"</span>;
00745                 <span class="keywordflow">else</span>
00746                     oss&lt;&lt;<span class="stringliteral">" RCB=64"</span>;
00747                 oss&lt;&lt;<span class="stringliteral">" ASPM:"</span>;
00748                 <span class="keywordflow">switch</span>(p16[8] &amp; 0x0003)
00749                 {
00750                     <span class="keywordflow">case</span> 0: oss&lt;&lt;<span class="stringliteral">"Disabled"</span>; <span class="keywordflow">break</span>;
00751                     <span class="keywordflow">case</span> 1: oss&lt;&lt;<span class="stringliteral">"L0s"</span>; <span class="keywordflow">break</span>;
00752                     <span class="keywordflow">case</span> 2: oss&lt;&lt;<span class="stringliteral">"L1"</span>; <span class="keywordflow">break</span>;
00753                     <span class="keywordflow">case</span> 3: oss&lt;&lt;<span class="stringliteral">"L0s+L1"</span>; <span class="keywordflow">break</span>;
00754                 }
00755                 oss&lt;&lt;<span class="stringliteral">"]\n"</span>;
00756 
00757 
00758                 oss&lt;&lt;<span class="stringliteral">"\tLink_Stat: 0x"</span>&lt;&lt;hex&lt;&lt;p16[7]&lt;&lt;dec&lt;&lt;<span class="stringliteral">" = ["</span>;
00759                 <span class="keywordflow">if</span> (p16[9] &amp; 0x1000)
00760                     oss&lt;&lt;<span class="stringliteral">" SlotRefClk"</span>;
00761                 <span class="keywordflow">if</span> (p16[9] &amp; 0x0400)
00762                     oss&lt;&lt;<span class="stringliteral">" TRAIN_ERR"</span>;
00763                 oss&lt;&lt;<span class="stringliteral">" Width=x"</span>&lt;&lt;((p16[9] &amp; 0x03f0)&gt;&gt;4);
00764                 <span class="keywordflow">if</span> (p16[9] &amp; 0x0001)
00765                     oss&lt;&lt;<span class="stringliteral">" 2.5G"</span>;
00766                 oss&lt;&lt;<span class="stringliteral">"]\n"</span>;
00767 
00768                 <span class="comment">// Slot Registers and Root Registers not implemented by our EndPoint core</span>
00769 
00770                 <span class="keywordflow">break</span>;
00771 
00772 
00773             <span class="keywordflow">default</span>:
00774                 oss&lt;&lt;<span class="stringliteral">"Unknown Capability: "</span>&lt;&lt;dec&lt;&lt;<span class="keywordtype">id</span>&lt;&lt;hex&lt;&lt;<span class="stringliteral">"\n"</span>;
00775                 next = 0; <span class="comment">// abort</span>
00776                 <span class="keywordflow">break</span>;
00777 
00778         }
00779 
00780     }
00781 
00782     outs = oss.str();
00783 
00784     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00785 }
00786 
00787 
00788 
00789 
<a name="l00795"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a9">00795</a> uint8_t <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a9">PCIe_IF::read8</a>(uint32_t offset) 
00796 {
00797     uint8_t val;
00798     uint32_t nBAR;
00799 
00800     nBAR = OFFSET2BAR(offset);
00801     <span class="keywordflow">if</span> (this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR] == NULL)
00802         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: read8 failed! invalid BAR."</span>));
00803 
00804         <span class="keyword">volatile</span> uint8_t *p8 = (uint8_t *)<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR];
00805 
00806     val = *(p8 + OFFSET2ADDR(offset));
00807 
00808     <span class="keywordflow">return</span>(val);
00809 }
00810     
00811 
<a name="l00817"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a10">00817</a> <span class="keywordtype">void</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a10">PCIe_IF::write8</a>(uint32_t offset, uint8_t val)
00818 {
00819     uint32_t nBAR;
00820 
00821 
00822     nBAR = OFFSET2BAR(offset);
00823     <span class="keywordflow">if</span> (this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR] == NULL)
00824         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: write8 failed! invalid BAR."</span>));
00825 
00826         <span class="keyword">volatile</span> uint8_t *p8 = (uint8_t *)<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR];
00827 
00828     *(p8 + OFFSET2ADDR(offset)) = val;
00829 }
00830 
00831 
00832 
<a name="l00839"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a11">00839</a> uint16_t <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a11">PCIe_IF::read16</a>(uint32_t offset)
00840 {
00841     uint16_t val;
00842     uint32_t nBAR;
00843 
00844     <span class="keywordflow">if</span> (offset &amp; 0x01)
00845         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: read16 failed! invalid offset."</span>));
00846 
00847     nBAR = OFFSET2BAR(offset);
00848     <span class="keywordflow">if</span> (this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR] == NULL)
00849         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: read16 failed! invalid BAR."</span>));
00850 
00851         <span class="keyword">volatile</span> uint16_t *p16 = (uint16_t *)<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR];
00852 
00853     val = *(p16 + (OFFSET2ADDR(offset)/<span class="keyword">sizeof</span>(uint16_t)));
00854 
00855     <span class="keywordflow">return</span>(val);
00856 }
00857 
00858 
<a name="l00865"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a12">00865</a> <span class="keywordtype">void</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a12">PCIe_IF::write16</a>(uint32_t offset, uint16_t val)
00866 {
00867     uint32_t nBAR;
00868 
00869     <span class="keywordflow">if</span> (offset &amp; 0x01)
00870         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: write16 failed! invalid offset."</span>));
00871 
00872     nBAR = OFFSET2BAR(offset);
00873     <span class="keywordflow">if</span> (this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR] == NULL)
00874         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: write16 failed! invalid BAR."</span>));
00875 
00876         <span class="keyword">volatile</span> uint16_t *p16 = (uint16_t *)<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR];
00877 
00878     *(p16 + (OFFSET2ADDR(offset)/<span class="keyword">sizeof</span>(uint16_t))) = val;
00879 
00880 }
00881 
00882 
00883 
<a name="l00893"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a13">00893</a> uint32_t <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a13">PCIe_IF::read32</a>(uint32_t offset)
00894 {
00895     uint32_t val;
00896     uint32_t nBAR;
00897 
00898     <span class="keywordflow">if</span> (offset &amp; 0x03)
00899         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: read32 failed! invalid offset."</span>));
00900 
00901     nBAR = OFFSET2BAR(offset);
00902     <span class="keywordflow">if</span> (this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR] == NULL)
00903         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: read32 failed! invalid BAR."</span>));
00904 
00905         <span class="keyword">volatile</span> uint32_t *p32 = (uint32_t *)<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR];
00906 
00907     val = *(p32 + (OFFSET2ADDR(offset)/<span class="keyword">sizeof</span>(uint32_t)));
00908 
00909     <span class="keywordflow">return</span>(val);
00910 }
00911     
00912 
00913 
<a name="l00920"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a14">00920</a> <span class="keywordtype">void</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a14">PCIe_IF::write32</a>(uint32_t offset, uint32_t val)
00921 {
00922     uint32_t nBAR;
00923 
00924     <span class="keywordflow">if</span> (offset &amp; 0x03)
00925         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: write32 failed! invalid offset."</span>));
00926 
00927     nBAR = OFFSET2BAR(offset);
00928     <span class="keywordflow">if</span> (this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR] == NULL)
00929         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: write32 failed! invalid BAR."</span>));
00930 
00931         <span class="keyword">volatile</span> uint32_t *p32 = (uint32_t *)<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR];
00932 
00933     *(p32 + (OFFSET2ADDR(offset)/<span class="keyword">sizeof</span>(uint32_t))) = val;
00934 
00935 }
00936 
00937 
00938 <span class="comment">/*=================== BLOCK ACCESS METHODS ================*/</span>
00939 <span class="comment">/*=================== BLOCK ACCESS METHODS ================*/</span>
00940 <span class="comment">/*=================== BLOCK ACCESS METHODS ================*/</span>
00941 
<a name="l00951"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a15">00951</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a9">PCIe_IF::read8</a>(uint32_t offset, uint8_t *val, size_t len, <span class="keywordtype">bool</span> incAddr)
00952 {
00953     <span class="keyword">volatile</span> uint8_t *addr;
00954     uint32_t nBAR;
00955     size_t i;
00956 
00957     nBAR = OFFSET2BAR(offset);
00958     <span class="keywordflow">if</span> (this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR] == NULL)
00959         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: block read8 failed! invalid BAR."</span>));
00960 
00961     addr = (uint8_t *)this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR] + OFFSET2ADDR(offset);
00962 
00963 
00964     <span class="keywordflow">if</span> (incAddr)
00965     {
00966         <span class="comment">// loop to copy len bytes from BAR addr to user's array</span>
00967         <span class="keywordflow">for</span> (i = 0; i &lt; len; i++)
00968         {
00969         *val = *addr;
00970         ++val;
00971         ++addr;
00972         }
00973 
00974     }
00975     <span class="keywordflow">else</span>  <span class="comment">// don't increment read address</span>
00976     {
00977         <span class="comment">// loop to copy len bytes from BAR addr to user's array</span>
00978         <span class="keywordflow">for</span> (i = 0; i &lt; len; i++)
00979         {
00980         *val = *addr;
00981         ++val;
00982         }
00983     }
00984 
00985     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00986 }
00987     
00988 
<a name="l00998"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a16">00998</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a10">PCIe_IF::write8</a>(uint32_t offset, uint8_t *val, size_t len, <span class="keywordtype">bool</span> incAddr)
00999 {
01000     <span class="keyword">volatile</span> uint8_t *addr;
01001     uint32_t nBAR;
01002     size_t i;
01003 
01004     nBAR = OFFSET2BAR(offset);
01005     <span class="keywordflow">if</span> (this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR] == NULL)
01006         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: block read8 failed! invalid BAR."</span>));
01007 
01008     addr = (uint8_t *)this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR] + OFFSET2ADDR(offset);
01009 
01010     <span class="keywordflow">if</span> (incAddr)
01011     {
01012         <span class="comment">// loop to copy len bytes from  user's array to BAR addr</span>
01013         <span class="keywordflow">for</span> (i = 0; i &lt; len; i++)
01014         {
01015         *addr = *val;
01016         ++val;
01017         ++addr;
01018         }
01019     }
01020     <span class="keywordflow">else</span>  <span class="comment">// don't increment write address</span>
01021     {
01022         <span class="keywordflow">for</span> (i = 0; i &lt; len; i++)
01023         {
01024         *addr = *val;
01025         ++val;
01026         }
01027     }
01028 
01029     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
01030 }
01031 
01032 
01033 
<a name="l01044"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a17">01044</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a11">PCIe_IF::read16</a>(uint32_t offset, uint16_t *val, size_t len, <span class="keywordtype">bool</span> incAddr)
01045 {
01046     <span class="keyword">volatile</span> uint16_t *addr;
01047     uint32_t nBAR;
01048     size_t i;
01049 
01050     <span class="keywordflow">if</span> (offset &amp; 0x01)
01051         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: block read16 failed! invalid offset."</span>));
01052 
01053     nBAR = OFFSET2BAR(offset);
01054     <span class="keywordflow">if</span> (this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR] == NULL)
01055         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: block read16 failed! invalid BAR."</span>));
01056 
01057     addr = (uint16_t *)this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR] + (OFFSET2ADDR(offset) / <span class="keyword">sizeof</span>(uint16_t));
01058 
01059 
01060     <span class="keywordflow">if</span> (incAddr)
01061     {
01062         <span class="comment">// loop to copy len bytes from BAR addr to user's array</span>
01063         <span class="keywordflow">for</span> (i = 0; i &lt; len; i++)
01064         {
01065         *val = *addr;
01066         ++val;
01067         ++addr;
01068         }
01069 
01070     }
01071     <span class="keywordflow">else</span>  <span class="comment">// don't increment read address</span>
01072     {
01073         <span class="comment">// loop to copy len bytes from BAR addr to user's array</span>
01074         <span class="keywordflow">for</span> (i = 0; i &lt; len; i++)
01075         {
01076         *val = *addr;
01077         ++val;
01078         }
01079     }
01080 
01081     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
01082 }
01083 
01084 
<a name="l01094"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a18">01094</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a12">PCIe_IF::write16</a>(uint32_t offset, uint16_t *val, size_t len, <span class="keywordtype">bool</span> incAddr)
01095 {
01096     <span class="keyword">volatile</span> uint16_t *addr;
01097     uint32_t nBAR;
01098     size_t i;
01099 
01100     <span class="keywordflow">if</span> (offset &amp; 0x01)
01101         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: block write16 failed! invalid offset."</span>));
01102 
01103     nBAR = OFFSET2BAR(offset);
01104     <span class="keywordflow">if</span> (this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR] == NULL)
01105         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: block write16 failed! invalid BAR."</span>));
01106 
01107     addr = (uint16_t *)this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR] + (OFFSET2ADDR(offset) / <span class="keyword">sizeof</span>(uint16_t));
01108 
01109     <span class="keywordflow">if</span> (incAddr)
01110     {
01111         <span class="comment">// loop to copy len bytes from  user's array to BAR addr</span>
01112         <span class="keywordflow">for</span> (i = 0; i &lt; len; i++)
01113         {
01114         *addr = *val;
01115         ++val;
01116         ++addr;
01117         }
01118     }
01119     <span class="keywordflow">else</span>  <span class="comment">// don't increment write address</span>
01120     {
01121         <span class="keywordflow">for</span> (i = 0; i &lt; len; i++)
01122         {
01123         *addr = *val;
01124         ++val;
01125         }
01126     }
01127 
01128     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
01129 }
01130 
01131 
01132 
<a name="l01142"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a19">01142</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a13">PCIe_IF::read32</a>(uint32_t offset, uint32_t *val, size_t len, <span class="keywordtype">bool</span> incAddr)
01143 {
01144 
01145     <span class="keyword">volatile</span> uint32_t *addr;
01146     uint32_t nBAR;
01147     size_t i;
01148 
01149     <span class="keywordflow">if</span> (offset &amp; 0x03)
01150         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: block read32 failed! invalid offset."</span>));
01151 
01152     nBAR = OFFSET2BAR(offset);
01153     <span class="keywordflow">if</span> (this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR] == NULL)
01154         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: block read32 failed! invalid BAR."</span>));
01155 
01156     addr = (uint32_t *)this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR] + (OFFSET2ADDR(offset) / <span class="keyword">sizeof</span>(uint32_t));
01157 
01158 
01159     <span class="keywordflow">if</span> (incAddr)
01160     {
01161         <span class="comment">// loop to copy len bytes from BAR addr to user's array</span>
01162         <span class="keywordflow">for</span> (i = 0; i &lt; len; i++)
01163         {
01164         *val = *addr;
01165         ++val;
01166         ++addr;
01167         }
01168 
01169     }
01170     <span class="keywordflow">else</span>  <span class="comment">// don't increment read address</span>
01171     {
01172         <span class="comment">// loop to copy len bytes from BAR addr to user's array</span>
01173         <span class="keywordflow">for</span> (i = 0; i &lt; len; i++)
01174         {
01175         *val = *addr;
01176         ++val;
01177         }
01178     }
01179 
01180     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
01181 }
01182     
01183 
01184 
<a name="l01194"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a20">01194</a> <span class="keywordtype">bool</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#a14">PCIe_IF::write32</a>(uint32_t offset, uint32_t *val, size_t len, <span class="keywordtype">bool</span> incAddr)
01195 {
01196     <span class="keyword">volatile</span> uint32_t *addr;
01197     uint32_t nBAR;
01198     size_t i;
01199 
01200     <span class="keywordflow">if</span> (offset &amp; 0x03)
01201         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: block write32 failed! invalid offset."</span>));
01202 
01203     nBAR = OFFSET2BAR(offset);
01204     <span class="keywordflow">if</span> (this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR] == NULL)
01205         <span class="keywordflow">throw</span>(<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f___error.html">PCIe_IF_Error</a>(<span class="stringliteral">"PCIe_IF: block write32 failed! invalid BAR."</span>));
01206 
01207     addr = (uint32_t *)this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR] + (OFFSET2ADDR(offset) / <span class="keyword">sizeof</span>(uint32_t));
01208 
01209     <span class="keywordflow">if</span> (incAddr)
01210     {
01211         <span class="comment">// loop to copy len bytes from  user's array to BAR addr</span>
01212         <span class="keywordflow">for</span> (i = 0; i &lt; len; i++)
01213         {
01214         *addr = *val;
01215         ++val;
01216         ++addr;
01217         }
01218     }
01219     <span class="keywordflow">else</span>  <span class="comment">// don't increment write address</span>
01220     {
01221         <span class="keywordflow">for</span> (i = 0; i &lt; len; i++)
01222         {
01223         *addr = *val;
01224         ++val;
01225         }
01226     }
01227 
01228     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
01229 
01230 }
01231 
01232 
01233 
<a name="l01268"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#b0">01268</a> <span class="keywordtype">int</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#b0">PCIe_IF::OpenDriver</a>(HANDLE &amp;hnd,
01269             <span class="keyword">const</span> GUID *pGUID, 
01270             <span class="keyword">const</span> <span class="keywordtype">char</span> *pBoardID,
01271             <span class="keyword">const</span> <span class="keywordtype">char</span> *pDemoID,
01272             uint32_t instance, 
01273             <span class="keyword">const</span> <span class="keywordtype">char</span> *pFriendlyName, 
01274             <span class="keyword">const</span> <span class="keywordtype">char</span> *pFunctionName)
01275 {
01276     <span class="keywordtype">int</span> rv = OK;
01277     <span class="keywordtype">int</span> fd;
01278     <span class="keywordtype">char</span> drivername[MAX_DEV_FILENAME_SIZE];
01279 
01280     ENTER();
01281 
01282     <span class="keywordflow">if</span> ((pFunctionName != NULL) &amp;&amp; (strlen(pFunctionName) &gt;= MAX_FUNCTION_NAME_SIZE))
01283     {
01284         ERRORSTR(<span class="stringliteral">"ERROR: FunctionName string too large\n"</span>);
01285         <span class="keywordflow">return</span>(PARAM_ERROR);
01286     }
01287 
01288 
01289     <span class="keywordflow">if</span> ((pBoardID == NULL) || (strlen(pBoardID) &gt; MAX_BOARD_ID_SIZE))
01290     {
01291         ERRORSTR(<span class="stringliteral">"ERROR: invalid BoardID string!\n"</span>);
01292         <span class="keywordflow">return</span>(PARAM_ERROR);
01293     }
01294 
01295     <span class="keywordflow">if</span> ((pDemoID == NULL) || (strlen(pDemoID) &gt; MAX_DEMO_ID_SIZE))
01296     {
01297         ERRORSTR(<span class="stringliteral">"ERROR: invalid DemoID string!\n"</span>);
01298         <span class="keywordflow">return</span>(PARAM_ERROR);
01299     }
01300 
01301 
01302     sprintf(drivername, <span class="stringliteral">"/dev/%s/%s_%s_%d"</span>, pGUID,
01303                         pBoardID,
01304                         pDemoID,
01305                         instance);
01306 
01307 
01308     <span class="keywordflow">if</span> (pFunctionName != NULL)
01309     {
01310         strcat(drivername, pFunctionName);
01311     }
01312 
01313 
01314     DEBUGPRINT((<span class="stringliteral">"Opening: %s"</span>, drivername));
01315 
01316     fd = open(drivername, O_RDWR, 0666); 
01317     <span class="keywordflow">if</span> (fd == -1)
01318     {
01319         perror(<span class="stringliteral">"OpenDriver: open"</span>);
01320         ERRORSTR(<span class="stringliteral">"ERROR: Device file not found!\n"</span>);
01321         <span class="keywordflow">return</span>(OPEN_FILE_FAILED);
01322     }
01323 
01324     hnd = fd;  <span class="comment">// return the handle to the open device</span>
01325 
01326     LEAVE();
01327 
01328     <span class="keywordflow">return</span>(rv);
01329 }
01330 
01331 
<a name="l01338"></a><a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#b1">01338</a> <span class="keywordtype">int</span> <a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#b1">PCIe_IF::MmapDriver</a>(<span class="keywordtype">void</span>)
01339 {
01340     <span class="keywordtype">void</span> *pmem;
01341     size_t len;
01342     <span class="keywordtype">int</span> nMapped = 0;
01343     <span class="keywordtype">int</span> nBAR;
01344     
01345     ENTER();
01346 
01347     <span class="comment">// BARs have to be allocated starting at 0 and going sequentially (I believe)</span>
01348     <span class="comment">// Question: is this handling 64 bit addresses???</span>
01349     <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; this-&gt;PCIinfo.<a class="code" href="struct_p_c_i_resource_info__t.html#o0">numBARs</a>; i++)
01350     {
01351         nBAR = this-&gt;PCIinfo.<a class="code" href="struct_p_c_i_resource_info__t.html#o1">BAR</a>[i].<a class="code" href="struct_p_c_i___b_a_r__t.html#o0">nBAR</a>;
01352         <span class="comment">// First we need to select the BAR for mapping using an IOCTL call</span>
01353         <span class="keywordflow">if</span> (ioctl(this-&gt;hDev, <a class="code" href="lscpcie_2_ioctl_8h.html#a6">IOCTL_LSCPCIE_SET_BAR</a>, nBAR) != 0)
01354         {
01355             ERRORSTR(<span class="stringliteral">"ERROR: MmapDriver ioctl failed!\n"</span>);
01356             <span class="keywordflow">return</span>(-1);
01357         }
01358 
01359         len = this-&gt;PCIinfo.<a class="code" href="struct_p_c_i_resource_info__t.html#o1">BAR</a>[i].<a class="code" href="struct_p_c_i___b_a_r__t.html#o2">size</a>;
01360 
01361         pmem = mmap(0,                      <span class="comment">/* choose any user address */</span>
01362                 len,                    <span class="comment">/* This big */</span>
01363                 PROT_READ | PROT_WRITE, <span class="comment">/* access control */</span>
01364                 MAP_SHARED,             <span class="comment">/* access control */</span>
01365                 this-&gt;hDev,             <span class="comment">/* the device object */</span>
01366                 0);                     <span class="comment">/* the offset from beginning */</span>
01367 
01368         <span class="keywordflow">if</span> (pmem == MAP_FAILED)
01369         {
01370             perror(<span class="stringliteral">"mmap: "</span>);
01371             ERRORSTR(<span class="stringliteral">"ERROR: MmapDriver mmap failed!\n"</span>);
01372             <span class="keywordflow">return</span>(-1);
01373         }
01374         
01375         DEBUGPRINT((<span class="stringliteral">"mapped BAR%d to 0x%p"</span>, nBAR, pmem));
01376         this-&gt;PCIinfo.<a class="code" href="struct_p_c_i_resource_info__t.html#o1">BAR</a>[i].<a class="code" href="struct_p_c_i___b_a_r__t.html#o3">memMapped</a> = <span class="keyword">true</span>;
01377         this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p2">pBAR</a>[nBAR] = pmem;
01378         this-&gt;<a class="code" href="class_lattice_semi___p_c_ie_1_1_p_c_ie___i_f.html#p3">sizeBAR</a>[nBAR] = len;   <span class="comment">// save for unmap purposes </span>
01379         ++nMapped;
01380     }
01381 
01382 
01383 
01384     <span class="keywordflow">return</span>(nMapped);
01385 }
01386 
01387 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Jul 16 12:05:26 2008 for Lattice PCIe API Manual by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
