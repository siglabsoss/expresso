<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Lattice PCIe API Manual: MiscUtils.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">Utils</a></div>
<h1>MiscUtils.cpp</h1><a href="_misc_utils_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> *  COPYRIGHT (c) 2008 by Lattice Semiconductor Corporation</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * All rights reserved. All use of this software and documentation is</span>
00005 <span class="comment"> * subject to the License Agreement located in the file LICENSE.</span>
00006 <span class="comment"> */</span>
00007 
00016 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00017 
00018 <span class="preprocessor">#include &lt;iostream&gt;</span>
00019 <span class="preprocessor">#include &lt;string&gt;</span>
00020 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00021 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00022 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00023 <span class="preprocessor">#include &lt;malloc.h&gt;</span>
00024 
00025 
00026 <span class="preprocessor">#include "<a class="code" href="_misc_utils_8h.html">MiscUtils.h</a>"</span>
00027 
00028 <span class="preprocessor">#include "<a class="code" href="_p_c_ie_a_p_i_8h.html">PCIeAPI.h</a>"</span>
00029 
00030 <span class="keyword">using</span> <span class="keyword">namespace </span>LatticeSemi_PCIe;
00031 
<a name="l00037"></a><a class="code" href="_misc_utils_8h.html#a2">00037</a> <span class="keywordtype">void</span> <a class="code" href="_misc_utils_8cpp.html#a0">ShowLastError</a>(<span class="keywordtype">void</span>) 
00038 {
00039 
00040     perror(<span class="stringliteral">"PCIeAPI:"</span>);
00041 
00042 <span class="preprocessor">#if 0</span>
00043 <span class="preprocessor"></span>    <span class="comment">// Retrieve the system error message for the last-error code</span>
00044     LPVOID lpMsgBuf;
00045 
00046     DWORD dw = GetLastError(); 
00047 
00048     FormatMessage(
00049                  FORMAT_MESSAGE_ALLOCATE_BUFFER | 
00050                  FORMAT_MESSAGE_FROM_SYSTEM |
00051                  FORMAT_MESSAGE_IGNORE_INSERTS,
00052                  NULL,
00053                  dw,
00054                  MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),
00055                  (LPTSTR) &amp;lpMsgBuf,
00056                  0, NULL );
00057 
00058 
00059     cout&lt;&lt;(LPCTSTR)lpMsgBuf&lt;&lt;endl;
00060     LocalFree(lpMsgBuf);
00061 <span class="preprocessor">#endif</span>
00062 <span class="preprocessor"></span>
00063 
00064 }
00065 
00066 
00067 
<a name="l00085"></a><a class="code" href="_misc_utils_8h.html#a3">00085</a> <span class="keywordtype">void</span>    *<a class="code" href="_misc_utils_8h.html#a3">AllocAlignedBuffer</a>(size_t size)
00086 {
00087     <span class="keywordtype">void</span> *pUserSpaceBuf;
00088 
00089 
00090     <span class="keywordflow">if</span> (posix_memalign(&amp;pUserSpaceBuf, 0x10000, size))
00091     {
00092         <a class="code" href="_misc_utils_8cpp.html#a0">ShowLastError</a>();
00093         <span class="keywordflow">return</span>(NULL);
00094     }
00095 
00096     <span class="keywordflow">return</span>(pUserSpaceBuf);
00097 
00098 
00099 <span class="preprocessor">#if 0  // Windows</span>
00100 <span class="preprocessor"></span>    <span class="comment">// Use VirtualAlloc</span>
00101     pUserSpaceBuf = (<span class="keywordtype">void</span> *)VirtualAlloc(NULL, 
00102                      size, 
00103                      MEM_COMMIT | MEM_RESERVE, 
00104                      PAGE_READWRITE);
00105     <span class="keywordflow">if</span> (pUserSpaceBuf == NULL)
00106     {
00107         <span class="keywordflow">if</span> (RUNTIMECTRL(VERBOSE))
00108         {
00109             cout&lt;&lt;<span class="stringliteral">"ERROR! VirtualAlloc failed.  exiting\n"</span>;
00110             <a class="code" href="_misc_utils_8cpp.html#a0">ShowLastError</a>();
00111         }
00112         <span class="keywordflow">return</span>(NULL);
00113     }
00114 
00115     <span class="comment">// The maximum number of pages that a process can lock is</span>
00116     <span class="comment">// equal to the number of pages in its minimum working set minus a small overhead.</span>
00117     <span class="keywordflow">if</span> (VirtualLock(pUserSpaceBuf, size) == FALSE)
00118     {
00119         <span class="keywordflow">if</span> (RUNTIMECTRL(VERBOSE))
00120         {
00121             cout&lt;&lt;<span class="stringliteral">"WARNING: VirtualLock permission denied.\n"</span>;
00122             <a class="code" href="_misc_utils_8cpp.html#a0">ShowLastError</a>();
00123         }
00124         <span class="comment">//return(NULL);</span>
00125     }
00126 <span class="preprocessor">#endif</span>
00127 <span class="preprocessor"></span>
00128 }
00129 
<a name="l00135"></a><a class="code" href="_misc_utils_8h.html#a4">00135</a> <span class="keywordtype">bool</span>    <a class="code" href="_misc_utils_8h.html#a4">FreeAlignedBuffer</a>(<span class="keywordtype">void</span> *pUserSpaceBuf, size_t size)
00136 {
00137 
00138     free(pUserSpaceBuf);
00139     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00140 
00141 <span class="preprocessor">#if 0  // Windows</span>
00142 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (VirtualUnlock(pUserSpaceBuf, size) == FALSE)
00143     {
00144         <span class="keywordflow">if</span> (RUNTIMECTRL(VERBOSE))
00145         {
00146             cout&lt;&lt;<span class="stringliteral">"VirtualUnlock failed.\n"</span>;
00147             <a class="code" href="_misc_utils_8cpp.html#a0">ShowLastError</a>();
00148         }
00149     }
00150 
00151     <span class="keywordflow">if</span> (VirtualFree(pUserSpaceBuf, 0, MEM_RELEASE) == FALSE)
00152     {
00153         <span class="keywordflow">if</span> (RUNTIMECTRL(VERBOSE))
00154         {
00155             cout&lt;&lt;<span class="stringliteral">"ERROR! VirtualFree failed.\n"</span>;
00156             <a class="code" href="_misc_utils_8cpp.html#a0">ShowLastError</a>();
00157         }
00158         <span class="keywordflow">return</span>(<span class="keyword">false</span>);
00159     }
00160 
00161     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00162 <span class="preprocessor">#endif</span>
00163 <span class="preprocessor"></span>}
00164 
00165 
00166 
<a name="l00186"></a><a class="code" href="_misc_utils_8h.html#a5">00186</a> <span class="keywordtype">bool</span> <a class="code" href="_misc_utils_8h.html#a5">GetPCIeEnvVarBoardName</a>(<span class="keywordtype">char</span> *boardName)
00187 {
00188     <span class="keywordtype">char</span> *pEnvVar;
00189 
00190     <span class="comment">// Find out what board the user expects to run on</span>
00191     pEnvVar = getenv(<span class="stringliteral">"LSC_PCIE_BOARD"</span>);
00192     <span class="keywordflow">if</span> (pEnvVar == NULL)
00193     {
00194         <span class="keywordflow">return</span>(<span class="keyword">false</span>);
00195     }
00196     <span class="keywordflow">else</span>  <span class="comment">// str is given, but it could have a " around it, if so remove "</span>
00197     {
00198         <span class="keywordflow">if</span> (*pEnvVar == <span class="charliteral">'"'</span>)
00199             strncpy(boardName, pEnvVar + 1, LSC_PCIE_BOARD_NAME_LEN);
00200         <span class="keywordflow">else</span>
00201             strncpy(boardName, pEnvVar, LSC_PCIE_BOARD_NAME_LEN);
00202         boardName[LSC_PCIE_BOARD_NAME_LEN] = <span class="charliteral">'\0'</span>;  <span class="comment">// ensure NULL terminated</span>
00203     }
00204 
00205     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00206 }
00207 
00208 
<a name="l00228"></a><a class="code" href="_misc_utils_8h.html#a6">00228</a> <span class="keywordtype">bool</span> <a class="code" href="_misc_utils_8h.html#a6">GetPCIeEnvVarDemoName</a>(<span class="keywordtype">char</span> *demoName)
00229 {
00230     <span class="keywordtype">char</span> *pEnvVar;
00231 
00232     <span class="comment">// Find out what board the user expects to run on</span>
00233     pEnvVar = getenv(<span class="stringliteral">"LSC_PCIE_IP_ID"</span>);
00234     <span class="keywordflow">if</span> (pEnvVar == NULL)
00235     {
00236         <span class="keywordflow">return</span>(<span class="keyword">false</span>);
00237     }
00238     <span class="keywordflow">else</span>  <span class="comment">// str is given, but it could have a " around it, if so remove "</span>
00239     {
00240         <span class="keywordflow">if</span> (*pEnvVar == <span class="charliteral">'"'</span>)
00241             strncpy(demoName, pEnvVar + 1, LSC_PCIE_DEMO_NAME_LEN);
00242         <span class="keywordflow">else</span>
00243             strncpy(demoName, pEnvVar, LSC_PCIE_DEMO_NAME_LEN);
00244         demoName[LSC_PCIE_DEMO_NAME_LEN] = <span class="charliteral">'\0'</span>;  <span class="comment">// ensure NULL terminated</span>
00245     }
00246 
00247     <span class="keywordflow">return</span>(<span class="keyword">true</span>);
00248 }
00249 
<a name="l00262"></a><a class="code" href="_misc_utils_8h.html#a7">00262</a> uint32_t <a class="code" href="_misc_utils_8h.html#a7">GetPCIeEnvVarBoardNum</a>(uint32_t defaultVal)
00263 {
00264     <span class="keywordtype">char</span> *pEnvVar;
00265     uint32_t boardNum;
00266 
00267     <span class="comment">// Find out what board number the user expects to run on</span>
00268     pEnvVar = getenv(<span class="stringliteral">"LSC_PCIE_INSTANCE"</span>);
00269     <span class="keywordflow">if</span> (pEnvVar == NULL)
00270         boardNum = defaultVal;
00271     <span class="keywordflow">else</span>
00272         boardNum = atoi(pEnvVar);
00273 
00274     <span class="keywordflow">return</span>(boardNum);
00275 }
00276 
<a name="l00301"></a><a class="code" href="_misc_utils_8h.html#a8">00301</a> <span class="keywordtype">bool</span> <a class="code" href="_misc_utils_8h.html#a8">GetPCIeEnvVars</a>(<span class="keywordtype">char</span> *boardName, <span class="keywordtype">char</span> *demoName, uint32_t &amp;boardNum)
00302 {
00303     <span class="keywordtype">bool</span> retVal;
00304 
00305     retVal = <a class="code" href="_misc_utils_8h.html#a5">GetPCIeEnvVarBoardName</a>(boardName);
00306     retVal = retVal &amp;&amp; <a class="code" href="_misc_utils_8h.html#a6">GetPCIeEnvVarDemoName</a>(demoName);
00307     boardNum = <a class="code" href="_misc_utils_8h.html#a7">GetPCIeEnvVarBoardNum</a>(1);
00308 
00309     <span class="keywordflow">return</span>(retVal);
00310 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Jul 16 12:05:26 2008 for Lattice PCIe API Manual by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
