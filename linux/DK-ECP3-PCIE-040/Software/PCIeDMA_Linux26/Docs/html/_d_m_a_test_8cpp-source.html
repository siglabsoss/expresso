<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Lattice PCIe DMA Demos: DMATest.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000001.html">DMATest</a></div>
<h1>DMATest.cpp</h1><a href="_d_m_a_test_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> *  COPYRIGHT (c) 2008 by Lattice Semiconductor Corporation</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * All rights reserved. All use of this software and documentation is</span>
00005 <span class="comment"> * subject to the License Agreement located in the file LICENSE.</span>
00006 <span class="comment"> */</span>
00033 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
00034 <span class="preprocessor">#include &lt;iostream&gt;</span>
00035 <span class="preprocessor">#include &lt;string&gt;</span>
00036 
00037 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00038 
00039 <span class="preprocessor">#include "PCIeAPI.h"</span>
00040 <span class="preprocessor">#include "MiscUtils.h"</span>
00041 <span class="preprocessor">#include "LSCDMA_IF.h"</span>
00042 <span class="preprocessor">#include "GPIO.h"</span>
00043 <span class="preprocessor">#include "SGDMA.h"</span>
00044 <span class="preprocessor">#include "Mem.h"</span>
00045 <span class="preprocessor">#include "MemFormat.h"</span>
00046 <span class="preprocessor">#include "../MemMap.h"</span>   <span class="comment">// definition of all IP devices in this design</span>
00047 
00048 <span class="preprocessor">#define IMG_FRAME_SIZE (1024*1024) </span>
00049 <span class="preprocessor"></span>
00050 <span class="preprocessor">#define CHECK(x,y) if (x != y) {printf("Comparison Error Detected @ line: %d\n", __LINE__); exit(-1);}</span>
00051 <span class="preprocessor"></span>
00052 
00054 <span class="comment">// Required to use Lattice PCIe methods</span>
00056 <span class="comment"></span><span class="keyword">using</span> <span class="keyword">namespace </span>LatticeSemi_PCIe;
00057 
00058 
00059 
00060 
00061 
00063 <span class="comment">//             Main Entry</span>
00065 <span class="comment"></span>
<a name="l00072"></a><a class="code" href="_d_m_a_test_8cpp.html#a2">00072</a> <span class="keywordtype">int</span> <a class="code" href="_image_move_8cpp.html#a20">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
00073 {
00074     LSCDMA_IF *pDrvr;
00075     <span class="keywordtype">char</span> boardName[LSC_PCIE_BOARD_NAME_LEN + 1];
00076     <span class="keywordtype">char</span> demoName[LSC_PCIE_DEMO_NAME_LEN + 1];
00077     uint32_t boardNum;
00078     string infoStr;
00079     uint32_t rd32_val;
00080     
00081 
00082     cout&lt;&lt;<span class="stringliteral">"\n=======================================\n"</span>;
00083     cout&lt;&lt;  <span class="stringliteral">"|   Lattice PCIe SGDMA Demo IP Test   |\n"</span>;
00084     cout&lt;&lt;  <span class="stringliteral">"|             ver 1.0                 |\n"</span>;
00085     cout&lt;&lt;  <span class="stringliteral">"| Verify access to eval board, IP and |\n"</span>;
00086     cout&lt;&lt;  <span class="stringliteral">"| correct system operation.           | \n"</span>;
00087     cout&lt;&lt;  <span class="stringliteral">"=======================================\n"</span>;
00088 
00089 
00090     cout&lt;&lt;<span class="stringliteral">"\n\n========================================================\n"</span>;
00091     cout&lt;&lt;<span class="stringliteral">"           Lattice LSC_API Openning the DLL Tests\n"</span>;
00092     cout&lt;&lt;<span class="stringliteral">"========================================================\n"</span>;
00093 
00094 
00095     cout&lt;&lt;<span class="stringliteral">"\n\n======================================\n"</span>;
00096     cout&lt;&lt;<span class="stringliteral">"    Instantiate the PCIeAPI DLL class\n"</span>;
00097     cout&lt;&lt;    <span class="stringliteral">"======================================\n"</span>;
00098     PCIeAPI theDLL;
00099     cout&lt;&lt;<span class="stringliteral">"Dll version info: "</span>&lt;&lt;theDLL.getVersionStr()&lt;&lt;endl;
00100    
00101 
00102     <span class="comment">// Setup so lots of diag output occurs from tests</span>
00103     theDLL.setRunTimeCtrl(PCIeAPI::VERBOSE);
00104 
00105     <span class="comment">// Get the environment variables needed to open the desired board</span>
00106     <span class="comment">// Pre-load with defaults</span>
00107     strcpy(boardName, <span class="stringliteral">"ECP2M"</span>);
00108     strcpy(demoName, <span class="stringliteral">"DMA"</span>);
00109     boardNum = 1;
00110     <span class="keywordflow">if</span> (!GetPCIeEnvVars(boardName, demoName, boardNum))
00111        cout&lt;&lt;<span class="stringliteral">"\nEnvVars not found.  Using defaults.\n"</span>;
00112 
00113     cout&lt;&lt;<span class="stringliteral">"boardName = "</span>&lt;&lt;boardName&lt;&lt;endl;
00114     cout&lt;&lt;<span class="stringliteral">"boardNum = "</span>&lt;&lt;boardNum&lt;&lt;endl;
00115     cout&lt;&lt;<span class="stringliteral">"demoName = "</span>&lt;&lt;demoName&lt;&lt;endl;
00116     <span class="keywordflow">try</span>
00117     {
00118        cout&lt;&lt;<span class="stringliteral">"\n\n======================================\n"</span>;
00119        cout&lt;&lt;    <span class="stringliteral">"       Driver Interface Info\n"</span>;
00120        cout&lt;&lt;    <span class="stringliteral">"======================================\n"</span>;
00121        cout&lt;&lt;<span class="stringliteral">"Opening LSCDMA_IF...\n"</span>;
00122         pDrvr = <span class="keyword">new</span> LSCDMA_IF(boardName, 
00123                               NULL,   <span class="comment">// no specific channel, just register access</span>
00124                               boardNum);
00125 
00126         cout&lt;&lt;<span class="stringliteral">"OK.\n"</span>;
00127   
00128         pDrvr-&gt;getDriverVersionStr(infoStr);
00129         cout&lt;&lt;<span class="stringliteral">"Version: "</span>&lt;&lt;infoStr&lt;&lt;endl;
00130         pDrvr-&gt;getDriverResourcesStr(infoStr);
00131         cout&lt;&lt;<span class="stringliteral">"Resources: "</span>&lt;&lt;infoStr&lt;&lt;endl;
00132         pDrvr-&gt;getPCICapabiltiesStr(infoStr);
00133         cout&lt;&lt;<span class="stringliteral">"Link Info: "</span>&lt;&lt;infoStr&lt;&lt;endl;
00134     
00135 
00136     <span class="keyword">const</span> DMAResourceInfo_t *pLinkInfo;
00137     <span class="keywordflow">if</span> (pDrvr-&gt;getDriverDMAInfo(&amp;pLinkInfo) == <span class="keyword">false</span>)
00138     {
00139         cout&lt;&lt;<span class="stringliteral">"ERROR accessing Driver Link Information in lscdma driver.\n"</span>;
00140         exit(-1);
00141     }
00142 
00143     
00144     cout&lt;&lt;<span class="stringliteral">"\n\n----------------------------------\n"</span>;
00145     cout&lt;&lt;<span class="stringliteral">"   DMA Info Structures\n"</span>;
00146     cout&lt;&lt;<span class="stringliteral">"----------------------------------\n"</span>;
00147 
00148 
00149     pDrvr-&gt;getDriverDMAInfoStr(infoStr);
00150         cout&lt;&lt;infoStr&lt;&lt;endl;
00151     ULONG MaxPayloadSize;  <span class="comment">/* PCIe max payload size for MWr into PC memory */</span>
00152     ULONG MaxReadReqSize;  <span class="comment">/* PCIe max read size for MRd from PC memory */</span>
00153     ULONG RCBSize;         <span class="comment">/* Root Complex Read Completion size (normally 64 bytes) */</span>
00154     ULONG LinkWidth;       <span class="comment">/* PCIe link width: x1, x4 */</span>
00155 
00156 
00157     cout&lt;&lt;<span class="stringliteral">" Link Width = "</span>&lt;&lt;dec&lt;&lt;pLinkInfo-&gt;LinkWidth&lt;&lt;endl;
00158     cout&lt;&lt;<span class="stringliteral">" MaxPayloadSize = "</span>&lt;&lt;dec&lt;&lt;pLinkInfo-&gt;MaxPayloadSize&lt;&lt;endl;
00159     cout&lt;&lt;<span class="stringliteral">" MaxReadReqSize= "</span>&lt;&lt;dec&lt;&lt;pLinkInfo-&gt;MaxReadReqSize&lt;&lt;endl;
00160     cout&lt;&lt;<span class="stringliteral">" RCB Size = "</span>&lt;&lt;dec&lt;&lt;pLinkInfo-&gt;RCBSize&lt;&lt;endl;
00161         
00162         cout&lt;&lt;<span class="stringliteral">"\n\n======================================\n"</span>;
00163         cout&lt;&lt;    <span class="stringliteral">"       GPIO ACCESS TESTS\n"</span>;
00164         cout&lt;&lt;    <span class="stringliteral">"======================================\n"</span>;
00165         cout&lt;&lt;<span class="stringliteral">"Creating GPIO device"</span>&lt;&lt;endl;
00166         GPIO *pGpio = <span class="keyword">new</span> GPIO(<span class="stringliteral">"GPIO"</span>, memGPIO(0), pDrvr); 
00167 
00168     
00169         rd32_val = pGpio-&gt;getID();
00170         cout&lt;&lt;<span class="stringliteral">"Read GPIO ID register: 0x"</span>&lt;&lt;hex&lt;&lt;rd32_val&lt;&lt;endl;
00171     CHECK(0x12043010, rd32_val);
00172         cout&lt;&lt;<span class="stringliteral">"Write/Read/Verify GPIO ScratchPad:\n"</span>;
00173         cout&lt;&lt;<span class="stringliteral">"GPIO ScratchPadReg = 0x"</span>&lt;&lt;hex&lt;&lt;pGpio-&gt;getScratchPad()&lt;&lt;endl;
00174         cout&lt;&lt;<span class="stringliteral">"Set to 0x44332211..."</span>;
00175         pGpio-&gt;setScratchPad(0x44332211);
00176         cout&lt;&lt;<span class="stringliteral">"GPIO ScratchPadReg = 0x"</span>&lt;&lt;hex&lt;&lt;pGpio-&gt;getScratchPad()&lt;&lt;endl;
00177         <span class="keywordflow">if</span> (pGpio-&gt;getScratchPad() != 0x44332211)
00178     {
00179            cout&lt;&lt;<span class="stringliteral">"FAIL!!!"</span>&lt;&lt;endl;
00180        exit(-1);
00181     }
00182         <span class="keywordflow">else</span>        
00183     {
00184            cout&lt;&lt;<span class="stringliteral">"PASS"</span>&lt;&lt;endl;
00185     }
00186 
00187         cout&lt;&lt;<span class="stringliteral">"LED test...\n"</span>;
00188         pGpio-&gt;LED16DisplayTest();
00189     
00190     
00191 
00192 
00193         cout&lt;&lt;<span class="stringliteral">"\n\n======================================\n"</span>;
00194         cout&lt;&lt;    <span class="stringliteral">"       INTERRUPT CONTROLLER TESTS\n"</span>;
00195         cout&lt;&lt;    <span class="stringliteral">"======================================\n"</span>;
00196     rd32_val = pGpio-&gt;read32(INTRCTL_ID_REG);
00197     printf(<span class="stringliteral">"IntrCtrl  ID: %08x\n"</span>, rd32_val);
00198     CHECK(0x12043050, rd32_val);
00199 
00200     <span class="comment">// Record Interrupt Controller state to later restore</span>
00201     uint32_t save1 = pGpio-&gt;read32(INTRCTL_CTRL);
00202     uint32_t save2 = pGpio-&gt;read32(INTRCTL_ENABLE);
00203 
00204     printf(<span class="stringliteral">"\nClear interrupt control, disable everything:\n"</span>);
00205     pGpio-&gt;write32(INTRCTL_CTRL, 0);
00206     pGpio-&gt;write32(INTRCTL_ENABLE, 0);
00207     printf(<span class="stringliteral">"\tctrl = %08x\n"</span>, pGpio-&gt;read32(INTRCTL_CTRL));
00208     printf(<span class="stringliteral">"\tstatus = %08x\n"</span>, pGpio-&gt;read32(INTRCTL_STATUS));
00209     printf(<span class="stringliteral">"\tenable = %08x\n"</span>, pGpio-&gt;read32(INTRCTL_ENABLE));
00210 
00211     printf(<span class="stringliteral">"\nLooping interrupts (watch 16seg LEDs change)...\n"</span>);
00212     pGpio-&gt;write32(INTRCTL_CTRL, INTRCTL_TEST_MODE | INTRCTL_OUTPUT_EN);
00213     pGpio-&gt;write32(INTRCTL_ENABLE, INTRCTL_TEST1_EN);
00214     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 100; i++)
00215     {
00216         pGpio-&gt;write32(INTRCTL_CTRL, INTRCTL_INTR_TEST1 | INTRCTL_TEST_MODE | INTRCTL_OUTPUT_EN);
00217         Sleep(50);
00218         printf(<span class="stringliteral">"."</span>);
00219     }
00220     pGpio-&gt;write32(INTRCTL_CTRL, 0);
00221     pGpio-&gt;write32(INTRCTL_ENABLE, 0);
00222 
00223     <span class="comment">// Restore previous interrupt controller state</span>
00224     pGpio-&gt;write32(INTRCTL_CTRL, save1);
00225     pGpio-&gt;write32(INTRCTL_ENABLE, save2);
00226 
00227 
00228         cout&lt;&lt;<span class="stringliteral">"\n\n======================================\n"</span>;
00229         cout&lt;&lt;    <span class="stringliteral">"       SGDMA ACCESS TESTS\n"</span>;
00230         cout&lt;&lt;    <span class="stringliteral">"======================================\n"</span>;
00231     cout&lt;&lt;<span class="stringliteral">"Creating SGDMA device"</span>&lt;&lt;endl;
00232     SGDMA *pSgdma = <span class="keyword">new</span> SGDMA(<span class="stringliteral">"SGDMA"</span>, memSGDMA(0), pDrvr); 
00233     
00234         cout&lt;&lt;<span class="stringliteral">"Read SGDMA ID register: 0x"</span>&lt;&lt;hex&lt;&lt;(pSgdma-&gt;getID())&lt;&lt;endl;
00235         
00236 
00237     pSgdma-&gt;showGlobalRegs();
00238 
00239     pSgdma-&gt;showChannelRegs();
00240 
00241         cout&lt;&lt;<span class="stringliteral">"\n\n=======================================================\n"</span>;
00242     cout&lt;&lt;<span class="stringliteral">"Testing Buffer Descriptor Registers: "</span>;
00243     <span class="keywordflow">if</span> (pSgdma-&gt;verifyBufDescRegs())
00244     {
00245         cout&lt;&lt;<span class="stringliteral">"PASS"</span>&lt;&lt;endl;
00246     }
00247     <span class="keywordflow">else</span>
00248     {
00249         cout&lt;&lt;<span class="stringliteral">"FAIL"</span>&lt;&lt;endl;
00250         exit(-1);
00251     }
00252         cout&lt;&lt;<span class="stringliteral">"=======================================================\n"</span>;
00253 
00254     pSgdma-&gt;showBufDescRegs();
00255    
00256 
00257 
00258         cout&lt;&lt;<span class="stringliteral">"\n\n======================================\n"</span>;
00259         cout&lt;&lt;    <span class="stringliteral">"       ColorBar IP ACCESS TESTS\n"</span>;
00260     cout&lt;&lt;    <span class="stringliteral">" First colors should be 0x000000ff\n"</span>;
00261         cout&lt;&lt;    <span class="stringliteral">"======================================\n"</span>;
00262     pGpio-&gt;write32(0x30, 1);  <span class="comment">// set reset</span>
00263     pGpio-&gt;write32(0x30, 0);  <span class="comment">// clear reset to run</span>
00264     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 16 ; i++)
00265     {
00266         rd32_val = pDrvr-&gt;read32(memIMG_FIFO(0));
00267         printf(<span class="stringliteral">"%d: %08x\n"</span>, i, rd32_val);
00268         CHECK(0x000000ff, rd32_val);
00269     }
00270     
00271 
00272 
00273         cout&lt;&lt;<span class="stringliteral">"\n\n======================================\n"</span>;
00274         cout&lt;&lt;    <span class="stringliteral">"       EBR ACCESS TESTS\n"</span>;
00275         cout&lt;&lt;    <span class="stringliteral">"======================================\n"</span>;
00276     cout&lt;&lt;<span class="stringliteral">"Creating EBR Memory device object"</span>&lt;&lt;endl;
00277     uint32_t *buf = (uint32_t *)malloc(pSgdma-&gt;getSizeDrvrCB());
00278     string outs;
00279     
00280     <span class="keywordflow">if</span> (buf == NULL)
00281     {
00282             cout&lt;&lt;<span class="stringliteral">"ERROR allocating buffer memory\n"</span>;
00283             ShowLastError();
00284             exit(-1);
00285     }
00286 
00287     Mem *pEbrMem = <span class="keyword">new</span> Mem(<span class="stringliteral">"EBR64"</span>, EBR64_SIZE, memEBR_64(0), pDrvr); 
00288 
00289     <span class="comment">// Let's try testing 1024 first and build up</span>
00290     pGpio-&gt;write32(0x28, 0);
00291     <span class="keywordflow">if</span> (pEbrMem-&gt;test(1024))
00292     {
00293         cout&lt;&lt;<span class="stringliteral">"PASS"</span>&lt;&lt;endl;
00294     }
00295     <span class="keywordflow">else</span>
00296     {
00297         cout&lt;&lt;<span class="stringliteral">"FAIL"</span>&lt;&lt;endl;
00298         exit(-1);
00299     }
00300 
00301      <span class="comment">// Display memory using utility format function</span>
00302     pEbrMem-&gt;get(0, 256, buf);
00303     MemFormat::formatBlockOfWords(outs, 0, 64, buf);
00304     cout&lt;&lt;outs;
00305 
00306         cout&lt;&lt;<span class="stringliteral">"\n\n======================================\n"</span>;
00307         cout&lt;&lt;    <span class="stringliteral">"       EBR_IMG ACCESS TESTS\n"</span>;
00308         cout&lt;&lt;    <span class="stringliteral">"======================================\n"</span>;
00309 
00310     cout&lt;&lt;<span class="stringliteral">"\n\nEBR=0xaaaaaaaa  XOR mask = 0\n"</span>;
00311     pGpio-&gt;write32(0x28, 0);
00312     memset(buf, 0xaa, 256);
00313     pEbrMem-&gt;set(0, 256, buf);
00314     memset(buf, 0x00, 256);
00315     pEbrMem-&gt;get(0, 256, buf);
00316     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 16; i++)
00317     {
00318         printf(<span class="stringliteral">"%d: %x\n"</span>, i, buf[i]);
00319         CHECK(buf[i], 0xaaaaaaaa);
00320     }
00321 
00322     cout&lt;&lt;<span class="stringliteral">"\n\nEBR=0xaaaaaaaa  XOR mask = ffffffff\n"</span>;
00323     pGpio-&gt;write32(0x28, 0xffffffff);
00324     memset(buf, 0xaa, 256);
00325     pEbrMem-&gt;set(0, 256, buf);
00326     memset(buf, 0x00, 256);
00327     pEbrMem-&gt;get(0, 256, buf);
00328     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 16; i++)
00329     {
00330         printf(<span class="stringliteral">"%d: %x\n"</span>, i, buf[i]);
00331         CHECK(buf[i], 0x55555555);
00332     }
00333 
00334     cout&lt;&lt;<span class="stringliteral">"\n\nEBR=0xaaaaaaaa  XOR mask = f0f0f0f0\n"</span>;
00335     pGpio-&gt;write32(0x28, 0xf0f0f0f0);
00336     memset(buf, 0xaa, 256);
00337     pEbrMem-&gt;set(0, 256, buf);
00338     memset(buf, 0x00, 256);
00339     pEbrMem-&gt;get(0, 256, buf);
00340     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 16; i++)
00341     {
00342         printf(<span class="stringliteral">"%d: %x\n"</span>, i, buf[i]);
00343         CHECK(buf[i], 0x5a5a5a5a);
00344     }
00345     
00346 
00347         cout&lt;&lt;<span class="stringliteral">"\n\n======================================\n"</span>;
00348         cout&lt;&lt;    <span class="stringliteral">"       DMA TRANSFER TESTS\n"</span>;
00349         cout&lt;&lt;    <span class="stringliteral">"======================================\n"</span>;
00350         cout&lt;&lt;<span class="stringliteral">"\n-------------- Verify Driver Common Buffer Access -----------------\n"</span>;
00351         cout&lt;&lt;<span class="stringliteral">"getSizeDrvrCB = "</span>&lt;&lt;dec&lt;&lt;pSgdma-&gt;getSizeDrvrCB()&lt;&lt;<span class="stringliteral">" bytes\n"</span>;
00352         <span class="keywordflow">if</span> (pSgdma-&gt;testDrvrCB())
00353     {
00354            cout&lt;&lt;<span class="stringliteral">"PASS\n"</span>;
00355     }
00356         <span class="keywordflow">else</span>
00357     {
00358             cout&lt;&lt;<span class="stringliteral">"FAIL!!!\n"</span>;
00359         exit(-1);
00360     }
00361         
00362         cout&lt;&lt;<span class="stringliteral">"--------------- DMA Read Test -----------------\n"</span>;            
00363         cout&lt;&lt;<span class="stringliteral">"\nLoad pattern in Driver Common Buffer\n"</span>;
00364         pSgdma-&gt;fillPatternDrvrCB(0x12340000);
00365     pGpio-&gt;write32(0x28, 0x00000000);  <span class="comment">// clear bit mask pattern</span>
00366         
00367         cout&lt;&lt;<span class="stringliteral">"Configure SGDMA Chan1 and Transfer data to EBR_64\n"</span>;
00368         pSgdma-&gt;ReadFromCB(1,     <span class="comment">// channel</span>
00369                           4096, <span class="comment">// len</span>
00370                           WB(memEBR_64(0)),  <span class="comment">// destination Wishbone bus address in IP</span>
00371                           1,           <span class="comment">// linear memory mode</span>
00372                           DATA_64BIT,  <span class="comment">// size of source data</span>
00373                           1,           <span class="comment">// use 1 BD</span>
00374                           1);          <span class="comment">// start at BD #1</span>
00375         
00376     <span class="comment">// Display some diagnostics</span>
00377     pSgdma-&gt;showGlobalRegs();
00378     pSgdma-&gt;showChannelRegs();
00379 
00380         cout&lt;&lt;<span class="stringliteral">"Verify pattern in EBR memory...\n"</span>;
00381     memset(buf, 0, 4096);  <span class="comment">// clear to ensure new values are loaded</span>
00382         pEbrMem-&gt;get(0, 4096, buf);
00383 <span class="preprocessor">#if 0</span>
00384 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 4096/4; i++)
00385         {
00386         CHECK(buf[i], (0x12340000 | i));
00387         }
00388 <span class="preprocessor">#endif</span>
00389 <span class="preprocessor"></span>        
00390     outs.clear();
00391     MemFormat::formatBlockOfWords(outs, 0, 64, buf);
00392     cout&lt;&lt;outs;
00393 
00394 
00395 
00396         cout&lt;&lt;<span class="stringliteral">"\n--------------- DMA Write Test -----------------\n"</span>;            
00397         cout&lt;&lt;<span class="stringliteral">"\nLoad pattern in EBR\n"</span>;
00398     pEbrMem-&gt;fill(0x55, 0, 4096);
00399 
00400     <span class="comment">// Set the XOR Mask</span>
00401     pGpio-&gt;write32(0x28, 0xffff0000);  <span class="comment">// load bit invert pattern</span>
00402         
00403         cout&lt;&lt;<span class="stringliteral">"Clear system memory\n"</span>;
00404         pSgdma-&gt;clearDrvrCB();
00405         
00406         cout&lt;&lt;<span class="stringliteral">"Configure SGDMA Chan0 and Transfer data to PC\n"</span>;
00407         pSgdma-&gt;WriteToCB(0,     <span class="comment">// channel</span>
00408                           4096, <span class="comment">// len</span>
00409                           WB(memEBR_64(0)),  <span class="comment">// source Wishbone bus address in IP</span>
00410                           1,           <span class="comment">// linear memory mode</span>
00411                           DATA_64BIT,  <span class="comment">// size of source data</span>
00412                           1,           <span class="comment">// use 1 BD</span>
00413                           0);          <span class="comment">// start at BD #0</span>
00414         
00415     <span class="comment">// Display some diagnostics</span>
00416     pSgdma-&gt;showGlobalRegs();
00417     pSgdma-&gt;showChannelRegs();
00418 
00419         cout&lt;&lt;<span class="stringliteral">"Verify pattern in memory...\n"</span>;
00420     memset(buf, 0, 4096);  <span class="comment">// clear to ensure new values are loaded</span>
00421         pSgdma-&gt;getDrvrCB(buf, 4096);
00422 <span class="preprocessor">#if 1</span>
00423 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 4096/4; i++)
00424         {
00425         CHECK(buf[i], 0xaaaa5555);
00426         }
00427 <span class="preprocessor">#endif </span>
00428 <span class="preprocessor"></span>    pSgdma-&gt;showDrvrCB(256);
00429 
00430 
00431 
00432         cout&lt;&lt;<span class="stringliteral">"\n\n======================================\n"</span>;
00433     cout&lt;&lt;<span class="stringliteral">" User Space Memory Allocation Test\n"</span>;
00434         cout&lt;&lt;<span class="stringliteral">"======================================\n"</span>;
00435         cout&lt;&lt;<span class="stringliteral">"Allocate 1MB user buf memory...\n"</span>;
00436         
00437     uint32_t *pBigBuf = (uint32_t *)AllocAlignedBuffer(IMG_FRAME_SIZE);
00438     uint32_t *pBB;
00439     <span class="keywordflow">if</span> (pBigBuf == NULL)
00440     {
00441         cout&lt;&lt;<span class="stringliteral">"!!! ERROR !!! couldn't allocate 1MB\n"</span>;
00442         ShowLastError();
00443     }
00444     <span class="keywordflow">else</span>
00445     {
00446         FreeAlignedBuffer(pBigBuf, (IMG_FRAME_SIZE));
00447     }
00448 
00449 
00450         cout&lt;&lt;<span class="stringliteral">"\n\n!!!!!!!!!!!!!!!!!!!!!!!!!!\n"</span>;
00451         cout&lt;&lt;    <span class="stringliteral">"   ALL TESTS COMPLETED \n"</span>;
00452         cout&lt;&lt;    <span class="stringliteral">"!!!!!!!!!!!!!!!!!!!!!!!!!!\n"</span>;
00453 
00454         
00455         free(buf);
00456     <span class="keyword">delete</span> pGpio;
00457     <span class="keyword">delete</span> pSgdma;
00458     <span class="keyword">delete</span> pEbrMem;
00459         <span class="keyword">delete</span> pDrvr;
00460     }
00461     <span class="keywordflow">catch</span> (std::exception &amp;e)
00462     {
00463     cout&lt;&lt;<span class="stringliteral">"\nError during testing: "</span>&lt;&lt;e.what()&lt;&lt;endl;
00464     ShowLastError();
00465     <span class="keywordflow">return</span>(-1);
00466 
00467     }
00468     
00469     
00470 
00471     <span class="keywordflow">return</span> EXIT_SUCCESS;
00472 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Jul 16 12:05:28 2008 for Lattice PCIe DMA Demos by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
